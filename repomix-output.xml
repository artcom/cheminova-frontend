This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.github/
  instructions/
    react.instructions.md
  copilot-instructions.md
.husky/
  pre-commit
public/
  locales/
    de/
      translation.json
    en/
      translation.json
    es/
      translation.json
    fr/
      translation.json
  amaraWriting.riv
  android-chrome-192x192.png
  android-chrome-512x512.png
  apple-touch-icon.png
  favicon.ico
  favicon.svg
  site.webmanifest
src/
  api/
    djangoApi.js
    hooks.js
    queries.js
    uploadImage.js
  components/
    App/
      App.jsx
      index.js
      screens.js
    Ending/
      Ending.jsx
      index.js
      README.md
    ExampleQueries/
      ExampleQueries.jsx
      index.js
    Exploration/
      1stImage.png
      2ndImage.png
      CameraIcon.jsx
      Exploration.jsx
      index.js
      IntroductionBackground.png
      Rectangle.png
      styles.js
    Gallery/
      assets/
        1.jpg
        2.jpg
        3.jpg
      CologneCathedral/
        CologneCathedral1.webp
        CologneCathedral10.webp
        CologneCathedral11.webp
        CologneCathedral12.webp
        CologneCathedral13.webp
        CologneCathedral14.webp
        CologneCathedral15.webp
        CologneCathedral16.webp
        CologneCathedral17.webp
        CologneCathedral18.webp
        CologneCathedral19.webp
        CologneCathedral2.webp
        CologneCathedral20.webp
        CologneCathedral21.webp
        CologneCathedral22.webp
        CologneCathedral23.webp
        CologneCathedral24.webp
        CologneCathedral25.webp
        CologneCathedral26.webp
        CologneCathedral27.webp
        CologneCathedral28.webp
        CologneCathedral29.webp
        CologneCathedral3.webp
        CologneCathedral30.webp
        CologneCathedral31.webp
        CologneCathedral32.webp
        CologneCathedral33.webp
        CologneCathedral34.webp
        CologneCathedral35.webp
        CologneCathedral36.webp
        CologneCathedral37.webp
        CologneCathedral38.webp
        CologneCathedral39.webp
        CologneCathedral4.webp
        CologneCathedral40.webp
        CologneCathedral41.webp
        CologneCathedral42.webp
        CologneCathedral43.webp
        CologneCathedral44.webp
        CologneCathedral45.webp
        CologneCathedral5.webp
        CologneCathedral6.webp
        CologneCathedral7.webp
        CologneCathedral8.webp
        CologneCathedral9.webp
      components/
        AnimatingTile.jsx
        CameraController.jsx
        GalleryContent.jsx
        GalleryLoader.jsx
        StackBump.jsx
      hooks/
        useImagePreloader.js
        useResponsiveTilesPerRow.js
      animationUtils.js
      config.js
      Gallery.jsx
      helpers.js
      index.js
      UploadedImagesGallery.jsx
      utils.js
    Introduction/
      CameraIcon.jsx
      index.js
      Introduction.jsx
      IntroductionBackground.png
      Rectangle.png
      styles.js
    Perspective/
      index.js
      Perspective.jsx
    PhotoCapture/
      hooks/
        usePhotoTasks.js
      index.js
      PhotoCapture.jsx
      PhotoCaptureMetadata.jsx
      styles.js
    UI/
      assets/
        LaNau.webp
      LanguageSelector/
        index.js
        LanguageSelector.jsx
      LoadingSpinner/
        index.js
        LoadingSpinner.jsx
      Button.jsx
      Description.jsx
      Header.jsx
      Headline.jsx
      IconButton.jsx
      Imprint.jsx
      LegalNotice.jsx
      MainLayout.jsx
      MobileOnlyGuard.jsx
      Navigation.jsx
      Privacy.jsx
      RiveAnimation.jsx
      SmallButton.jsx
      SubHeadline.jsx
      Vignette.jsx
    Upload/
      index.js
      styles.js
      Upload.jsx
    Welcome/
      CharacterShowcase/
        assets/
          1.png
          2.png
          3.png
          amara.png
          amaraSelected.png
          mateo.png
          mateoSelected.png
          nova.png
          novaSelected.png
        components/
          CharacterCard.jsx
          CharacterCarousel.jsx
          Intro.jsx
        hooks/
          useCharacterCarousel.js
        utils/
          transformUtils.js
        CharacterShowcase.jsx
        constants.js
        index.js
        styles.js
      hooks/
        useWelcomeBackground.js
        useWelcomeContent.js
        useWelcomeSteps.js
      constants.js
      index.js
      styles.jsx
      Welcome.jsx
  config/
    api.js
    language.js
  hooks/
    useCharacterCarousel.js
    useDevicePlatform.js
    useEndingContent.js
    useFetchPosts.js
    useGallery.js
    useGlobalState.js
    useHistoryNavigation.js
    useImagePreloader.js
    useLocalizedQuery.js
    usePerspectiveContent.js
    usePhotoTasks.js
    useResponsiveTilesPerRow.js
    useSupportedLanguages.js
    useSwipeGesture.js
    useUploadImage.js
    useUploadPost.js
  i18n/
    index.js
  providers/
    LanguageProvider.jsx
  routes/
    CharacterLayout.jsx
    ErrorPage.jsx
    Root.jsx
  theme/
    index.js
    ThemeProvider.jsx
  utils/
    apiUtils.js
    languageErrors.js
  GlobalState.jsx
  GlobalStyles.jsx
  main.jsx
.env.example
.env.local.example
.gitignore
.gitlab-ci.yml
.lintstagedrc.json
.prettierrc
eslint.config.js
index.html
jsconfig.json
package.json
react-router.md
README.md
vite.config.js
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".husky/pre-commit">
npx lint-staged
</file>

<file path="public/favicon.svg">
<svg width="180" height="180" viewBox="0 0 180 180" fill="none" xmlns="http://www.w3.org/2000/svg">
<rect width="180" height="180" rx="22" fill="#F1ECE1"/>
<path d="M90.4783 142.197C82.3177 142.197 74.994 141.099 68.5074 138.901C62.0208 136.704 56.4757 133.356 51.8723 128.858C47.3735 124.359 43.921 118.866 41.5146 112.379C39.2129 105.788 38.0621 98.0984 38.0621 89.3101C38.0621 80.3125 39.2652 72.4135 41.6716 65.6129C44.0779 58.8124 47.5305 53.0582 52.0293 48.3501C56.6327 43.6421 62.0208 40.1372 68.1935 37.8355C74.3663 35.4292 81.2191 34.226 88.752 34.226C94.7155 34.226 100.156 34.9584 105.073 36.4231C110.095 37.8878 114.437 40.0849 118.099 43.0144C121.761 45.8392 124.585 49.2917 126.573 53.372C128.666 57.3477 129.764 61.8988 129.869 67.0254L106.486 73.4597C106.486 69.1701 105.544 65.6653 103.661 62.9451C101.882 60.2249 99.5805 58.1847 96.7557 56.8246C94.0354 55.3599 91.0537 54.6275 87.8104 54.6275C85.1948 54.6275 82.4746 55.2029 79.6498 56.3538C76.9296 57.4 74.4186 59.2309 72.1169 61.8465C69.8152 64.3575 67.9843 67.7054 66.6242 71.8903C65.2641 76.0753 64.584 81.3064 64.584 87.5838C64.584 95.7444 65.7349 102.336 68.0366 107.358C70.3383 112.379 73.5293 116.094 77.6096 118.5C81.6899 120.802 86.1887 121.953 91.106 121.953C96.5464 121.953 100.731 120.802 103.661 118.5C106.695 116.094 108.84 113.112 110.095 109.555C111.351 105.997 112.031 102.388 112.135 98.7262L134.106 102.179C134.001 107.828 133.164 113.112 131.595 118.029C130.026 122.946 127.515 127.236 124.062 130.898C120.714 134.455 116.268 137.227 110.723 139.215C105.178 141.203 98.4296 142.197 90.4783 142.197Z" fill="black"/>
<circle cx="88.5909" cy="87.5909" r="11.1972" transform="rotate(28.2529 88.5909 87.5909)" fill="black" stroke="black" stroke-width="6.53846"/>
<circle cx="93.8914" cy="80.8914" r="5.82724" transform="rotate(28.2529 93.8914 80.8914)" fill="#F1ECE1"/>
</svg>
</file>

<file path="public/site.webmanifest">
{
    "name": "Cheminova",
    "short_name": "Cheminova",
    "icons": [
        {
            "src": "/android-chrome-192x192.png",
            "sizes": "192x192",
            "type": "image/png"
        },
        {
            "src": "/android-chrome-512x512.png",
            "sizes": "512x512",
            "type": "image/png"
        }
    ],
    "theme_color": "#FFFFFF",
    "background_color": "#FFFFFF",
    "display": "standalone"
}
</file>

<file path="src/api/queries.js">
import { fetchAllLocalesContent, getContentForLocale } from "@/api/djangoApi"
import { queryKeys } from "@/api/hooks"

export const allContentQuery = (locale) => ({
  queryKey: [...queryKeys.all, "locale", locale],
  queryFn: async () => {
    const allLocalesContent = await fetchAllLocalesContent()
    return getContentForLocale(allLocalesContent, locale)
  },
})
</file>

<file path="src/components/App/index.js">
export { default } from "./App"
</file>

<file path="src/components/Gallery/index.js">
export { default, loader } from "./Gallery"
</file>

<file path="src/components/Introduction/CameraIcon.jsx">
export default function CameraIcon() {
  return (
    <svg
      xmlns="http://www.w3.org/2000/svg"
      width="32"
      height="25"
      viewBox="0 0 32 25"
      fill="none"
    >
      <rect
        x="1"
        y="1"
        width="53"
        height="53"
        rx="26.5"
        transform="matrix(0 1 1 0 0 0)"
        stroke="white"
        strokeWidth="2"
      />
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M11.0226 1.0001C10.4679 1.0001 9.99746 1.27542 9.70104 1.62147C9.40462 1.96752 9.23371 2.36952 9.08513 2.75504C9.08512 2.75642 9.08512 2.7578 9.08513 2.75918L8.53708 4.17837H2.73293C1.50438 4.17837 0.5 5.16814 0.5 6.37204V21.8053C0.5 23.0092 1.50438 24 2.73293 24H29.2702C30.4988 24 31.5 23.0092 31.5 21.8053V6.37205C31.5 5.16815 30.4988 4.17837 29.2702 4.17837H23.4661L22.918 2.75912C22.918 2.75877 22.918 2.75947 22.918 2.75912C22.918 2.75877 22.918 2.75738 22.918 2.75703C22.918 2.75668 22.918 2.75738 22.918 2.75703C22.918 2.75668 22.918 2.75529 22.918 2.75494C22.7694 2.36952 22.5985 1.96742 22.3021 1.62137C22.0057 1.27532 21.5352 1 20.9805 1L11.0226 1.0001ZM11.0226 2.04592H20.9805C21.2227 2.04592 21.3282 2.11378 21.4816 2.29284C21.6349 2.4719 21.7855 2.7765 21.92 3.12541L22.5986 4.88341C22.6364 4.98257 22.7042 5.06816 22.7929 5.12883C22.8817 5.1895 22.9872 5.2224 23.0955 5.22318H29.2702C29.9201 5.22318 30.4342 5.72407 30.4342 6.37205V21.8053C30.4342 22.4533 29.9201 22.9542 29.2702 22.9542H2.73293C2.08307 22.9542 1.56897 22.4533 1.56897 21.8053V6.37205C1.56897 5.72407 2.08307 5.22318 2.73293 5.22318H8.90766C9.01595 5.2224 9.12145 5.1895 9.21018 5.12883C9.29892 5.06816 9.3667 4.98257 9.40457 4.88341L10.0831 3.12541C10.2176 2.7765 10.3682 2.47189 10.5216 2.29284C10.6749 2.11377 10.7804 2.04592 11.0226 2.04592ZM16.0021 7.22809C12.1593 7.22809 9.03815 10.3075 9.03815 14.0887C9.03815 17.8699 12.1593 20.9533 16.0021 20.9533C19.8449 20.9533 22.965 17.8699 22.965 14.0887C22.965 10.3075 19.8449 7.22809 16.0021 7.22809ZM27.3473 7.43828C27.2473 7.43861 27.1484 7.45819 27.0561 7.4959C26.9638 7.53362 26.8801 7.58873 26.8096 7.65808C26.7391 7.72743 26.6833 7.80968 26.6454 7.90011C26.6074 7.99054 26.588 8.0874 26.5884 8.18515C26.5891 8.38167 26.6693 8.56995 26.8114 8.70892C26.9536 8.84788 27.1462 8.92625 27.3473 8.92691C27.4474 8.92739 27.5466 8.90857 27.6393 8.87153C27.7319 8.8345 27.8162 8.77997 27.8873 8.71108C27.9583 8.64219 28.0148 8.56027 28.0534 8.47003C28.0921 8.37978 28.1122 8.28298 28.1125 8.18515C28.1129 8.08688 28.0933 7.98953 28.0549 7.89869C28.0166 7.80786 27.9602 7.72534 27.8891 7.65591C27.818 7.58647 27.7335 7.5315 27.6405 7.49414C27.5475 7.45679 27.4479 7.4378 27.3473 7.43828ZM16.0021 8.27391C19.2622 8.27391 21.896 10.8673 21.896 14.0887C21.896 17.3101 19.2622 19.9085 16.0021 19.9085C12.742 19.9085 10.1071 17.3101 10.1071 14.0887C10.1071 10.8673 12.742 8.27391 16.0021 8.27391Z"
        fill="black"
      />
      <path
        d="M22.918 2.75912L23.4661 4.17837H29.2702C30.4988 4.17837 31.5 5.16815 31.5 6.37205V21.8053C31.5 23.0092 30.4988 24 29.2702 24H2.73293C1.50438 24 0.5 23.0092 0.5 21.8053V6.37204C0.5 5.16814 1.50438 4.17837 2.73293 4.17837H8.53708L9.08513 2.75918C9.08512 2.7578 9.08512 2.75642 9.08513 2.75504C9.23371 2.36952 9.40462 1.96752 9.70104 1.62147C9.99746 1.27542 10.468 1.0001 11.0226 1.0001L20.9805 1C21.5352 1 22.0057 1.27532 22.3021 1.62137C22.5985 1.96742 22.7694 2.36952 22.918 2.75494C22.918 2.75529 22.918 2.75668 22.918 2.75703M22.918 2.75912C22.918 2.75877 22.918 2.75947 22.918 2.75912ZM22.918 2.75912C22.918 2.75877 22.918 2.75738 22.918 2.75703M22.918 2.75703C22.918 2.75668 22.918 2.75738 22.918 2.75703ZM11.0226 2.04592H20.9805C21.2227 2.04592 21.3282 2.11378 21.4816 2.29284C21.6349 2.4719 21.7855 2.7765 21.92 3.12541L22.5986 4.88341C22.6364 4.98257 22.7042 5.06816 22.7929 5.12883C22.8817 5.1895 22.9872 5.2224 23.0955 5.22318H29.2702C29.9201 5.22318 30.4342 5.72407 30.4342 6.37205V21.8053C30.4342 22.4533 29.9201 22.9542 29.2702 22.9542H2.73293C2.08307 22.9542 1.56897 22.4533 1.56897 21.8053V6.37205C1.56897 5.72407 2.08307 5.22318 2.73293 5.22318H8.90766C9.01595 5.2224 9.12145 5.1895 9.21018 5.12883C9.29892 5.06816 9.3667 4.98257 9.40457 4.88341L10.0831 3.12541C10.2176 2.7765 10.3682 2.47189 10.5216 2.29284C10.6749 2.11377 10.7804 2.04592 11.0226 2.04592ZM16.0021 7.22809C12.1593 7.22809 9.03815 10.3075 9.03815 14.0887C9.03815 17.8699 12.1593 20.9533 16.0021 20.9533C19.8449 20.9533 22.965 17.8699 22.965 14.0887C22.965 10.3075 19.8449 7.22809 16.0021 7.22809ZM27.3473 7.43828C27.2473 7.43861 27.1484 7.45819 27.0561 7.4959C26.9638 7.53362 26.8801 7.58872 26.8096 7.65808C26.7391 7.72743 26.6833 7.80968 26.6454 7.90011C26.6074 7.99054 26.588 8.0874 26.5884 8.18515C26.5891 8.38167 26.6693 8.56995 26.8114 8.70892C26.9536 8.84788 27.1463 8.92625 27.3473 8.92691C27.4474 8.92739 27.5466 8.90856 27.6393 8.87153C27.7319 8.8345 27.8162 8.77997 27.8873 8.71108C27.9583 8.64219 28.0148 8.56027 28.0534 8.47003C28.0921 8.37978 28.1122 8.28298 28.1125 8.18515C28.1129 8.08688 28.0933 7.98953 28.0549 7.89869C28.0166 7.80786 27.9602 7.72534 27.8891 7.65591C27.818 7.58647 27.7335 7.53149 27.6405 7.49414C27.5475 7.45679 27.4479 7.4378 27.3473 7.43828ZM16.0021 8.27391C19.2622 8.27391 21.896 10.8673 21.896 14.0887C21.896 17.3101 19.2622 19.9085 16.0021 19.9085C12.742 19.9085 10.1071 17.3101 10.1071 14.0887C10.1071 10.8673 12.742 8.27391 16.0021 8.27391Z"
        stroke="black"
      />
    </svg>
  )
}
</file>

<file path="src/components/Introduction/index.js">
export { default, loader } from "./Introduction"
</file>

<file path="src/components/PhotoCapture/index.js">
export { default, loader } from "./PhotoCapture"
</file>

<file path="src/components/UI/Button.jsx">
import { styled } from "styled-components"

const StyledButton = styled.button`
  all: unset;
  width: 8.875rem;
  height: 3.4375rem;
  border-radius: 2.75rem;
  border: 2px solid #fff;
  flex-shrink: 0;
  display: flex;
  flex-direction: column;
  justify-content: center;
  color: #fff;
  text-align: center;
  font-size: 1.25rem;
  font-style: normal;
  font-weight: 700;
  line-height: normal;

  &:disabled {
    opacity: 0.5;
  }
`

export default function Button({ children, ...props }) {
  return <StyledButton {...props}>{children}</StyledButton>
}
</file>

<file path="src/components/UI/Description.jsx">
import { motion } from "motion/react"
import { styled } from "styled-components"

const DescriptionBlock = styled(motion.div)`
  width: 100%;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: flex-start;
  gap: 0.75rem;
  padding: 0 1.56125rem;
  position: relative;
  z-index: 2;
`

const DescriptionTitle = styled.div`
  height: 1.6875rem;
  align-self: stretch;
  color: #fff;
  text-align: center;
  font-size: 1.5rem;
  font-style: normal;
  font-weight: 700;
  line-height: normal;
`

const DescriptionText = styled.div`
  align-self: stretch;
  color: #fff;
  text-align: center;
  font-size: 1rem;
  font-style: normal;
  font-weight: 400;
  line-height: normal;
`

export default function Description({ title, text, headline, subheadline }) {
  return (
    <DescriptionBlock
      key={`description-${headline}-${subheadline}`}
      initial={{ opacity: 0 }}
      animate={{ opacity: 1 }}
      exit={{ opacity: 0 }}
      transition={{
        delay: 0.3,
        duration: 0.6,
        ease: "easeOut",
      }}
    >
      <DescriptionTitle>{title}</DescriptionTitle>
      <DescriptionText>{text}</DescriptionText>
    </DescriptionBlock>
  )
}
</file>

<file path="src/components/UI/Imprint.jsx">
import { styled } from "styled-components"

const Container = styled.div`
  max-width: 900px;
  padding: 32px;
  background: #fff;
  box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
  color: #222;
  height: auto;
  overflow-y: scroll;
`

const Title = styled.h1`
  font-size: 1.4rem;
  font-weight: 700;
  margin-bottom: 24px;
  color: #1a237e;
`

const SectionTitle = styled.h2`
  font-size: 1.1rem;
  font-weight: 600;
  margin-top: 32px;
  margin-bottom: 12px;
  color: #3949ab;
`

const Paragraph = styled.p`
  font-size: 0.8rem;
  line-height: 1.7;
  margin-bottom: 16px;
`

const List = styled.ul`
  margin-left: 24px;
  margin-bottom: 16px;
`

const ListItem = styled.li`
  font-size: 0.7;
  line-height: 1.6;
  margin-bottom: 8px;
`

export default function Imprint() {
  return (
    <Container>
      <Title>Impressum / Imprint</Title>
      <SectionTitle>Vorstand / Board</SectionTitle>
      <Paragraph>Andreas Wiek</Paragraph>
      <SectionTitle>Aufsichtsrat / Supervisory Board</SectionTitle>
      <List>
        <ListItem>Volker Tietgens (Vorsitzender / Chairman)</ListItem>
        <ListItem>Dr. Miloš Stefanović</ListItem>
        <ListItem>Dr. Uwe S. Schuricht</ListItem>
      </List>
      <SectionTitle>Registergericht / Registered at</SectionTitle>
      <Paragraph>Amtsgericht Charlottenburg, Berlin</Paragraph>
      <SectionTitle>Registernummer / No.</SectionTitle>
      <Paragraph>HRB 68308</Paragraph>
      <SectionTitle>Umsatzsteuer-Identifikationsnummer / VAT ID</SectionTitle>
      <Paragraph>DE 811998328</Paragraph>
      <SectionTitle>Adresse / Address</SectionTitle>
      <Paragraph>
        ART+COM GmbH
        <br />
        Prinzessinnenstraße 1<br />
        10969 Berlin
        <br />
        Deutschland / Germany
        <br />
        Telefon / Telephone: +49 30 21001-0
        <br />
        info@artcom.de
      </Paragraph>
      <SectionTitle>Haftungshinweis / Note on liability</SectionTitle>
      <Paragraph>
        Trotz sorgfältiger inhaltlicher Kontrolle übernehmen wir keine Haftung
        für die Inhalte externer Links. Für den Inhalt der verlinkten Seiten
        sind ausschließlich deren Betreiber verantwortlich.
        <br />
        <br />
        Although we make every effort to verify outside material we are unable
        to accept liability for the content of external links. Responsibility
        for this material lies solely with the relevant website owners.
      </Paragraph>
    </Container>
  )
}
</file>

<file path="src/components/UI/Privacy.jsx">
import { styled } from "styled-components"

const Container = styled.div`
  max-width: 900px;
  padding: 32px;
  background: #fff;
  box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
  color: #222;
`

const Title = styled.h1`
  font-size: 1.3rem;
  font-weight: 700;
  margin-bottom: 24px;
  color: #1a237e;
`

const SectionTitle = styled.h2`
  font-size: 1.2rem;
  font-weight: 600;
  margin-top: 32px;
  margin-bottom: 12px;
  color: #3949ab;
`

const Paragraph = styled.p`
  font-size: 0.8rem;
  line-height: 1.7;
  margin-bottom: 16px;
`

const List = styled.ul`
  margin-left: 24px;
  margin-bottom: 16px;
`

const ListItem = styled.li`
  font-size: 0.7rem;
  line-height: 1.6;
  margin-bottom: 8px;
`

const Link = styled.a`
  color: #1976d2;
  text-decoration: underline;
`

export default function Privacy() {
  return (
    <Container>
      <Title>Datenschutzerklärung / Privacy Policy</Title>
      <SectionTitle>Allgemeiner Hinweis und Pflichtinformationen</SectionTitle>
      <Paragraph>
        <strong>Benennung der verantwortlichen Stelle</strong>
        <br />
        Die verantwortliche Stelle für die Datenverarbeitung auf dieser Website
        ist:
        <br />
        ART+COM GmbH, Prinzessinnenstr. 1, 10969 Berlin
        <br />
        Die verantwortliche Stelle entscheidet allein oder gemeinsam mit anderen
        über die Zwecke und Mittel der Verarbeitung von personenbezogenen Daten
        (z.B. Namen, Kontaktdaten o. Ä.).
      </Paragraph>
      <SectionTitle>
        Widerruf Ihrer Einwilligung zur Datenverarbeitung
      </SectionTitle>
      <Paragraph>
        Nur mit Ihrer ausdrücklichen Einwilligung sind einige Vorgänge der
        Datenverarbeitung möglich. Ein Widerruf Ihrer bereits erteilten
        Einwilligung ist jederzeit möglich. Für den Widerruf genügt eine
        formlose Mitteilung per E-Mail. Die Rechtmäßigkeit der bis zum Widerruf
        erfolgten Datenverarbeitung bleibt vom Widerruf unberührt.
      </Paragraph>
      <SectionTitle>
        Recht auf Beschwerde bei der zuständigen Aufsichtsbehörde
      </SectionTitle>
      <Paragraph>
        Als Betroffener steht Ihnen im Falle eines datenschutzrechtlichen
        Verstoßes ein Beschwerderecht bei der zuständigen Aufsichtsbehörde zu.
        Zuständige Aufsichtsbehörde bezüglich datenschutzrechtlicher Fragen ist
        der Landesdatenschutzbeauftragte des Bundeslandes, in dem sich der Sitz
        unseres Unternehmens befindet. Der folgende Link stellt eine Liste der
        Datenschutzbeauftragten sowie deren Kontaktdaten bereit:{" "}
        <Link
          href="https://www.bfdi.bund.de/DE/Infothek/Anschriften_Links/anschriften_links-node.html"
          target="_blank"
          rel="noopener noreferrer"
        >
          bfdi.bund.de
        </Link>
        .
      </Paragraph>
      <SectionTitle>Recht auf Datenübertragbarkeit</SectionTitle>
      <Paragraph>
        Ihnen steht das Recht zu, Daten, die wir auf Grundlage Ihrer
        Einwilligung oder in Erfüllung eines Vertrags automatisiert verarbeiten,
        an sich oder an Dritte aushändigen zu lassen. Die Bereitstellung erfolgt
        in einem maschinenlesbaren Format. Sofern Sie die direkte Übertragung
        der Daten an einen anderen Verantwortlichen verlangen, erfolgt dies nur,
        soweit es technisch machbar ist.
      </Paragraph>
      <SectionTitle>
        Recht auf Auskunft, Berichtigung, Sperrung, Löschung
      </SectionTitle>
      <Paragraph>
        Sie haben jederzeit im Rahmen der geltenden gesetzlichen Bestimmungen
        das Recht auf unentgeltliche Auskunft über Ihre gespeicherten
        personenbezogenen Daten, Herkunft der Daten, deren Empfänger und den
        Zweck der Datenverarbeitung und ggf. ein Recht auf Berichtigung,
        Sperrung oder Löschung dieser Daten. Diesbezüglich und auch zu weiteren
        Fragen zum Thema personenbezogene Daten können Sie sich jederzeit über
        die im Impressum aufgeführten Kontaktmöglichkeiten artcom.de
      </Paragraph>
      <SectionTitle>SSL- bzw. TLS-Verschlüsselung</SectionTitle>
      <Paragraph>
        Aus Sicherheitsgründen und zum Schutz der Übertragung vertraulicher
        Inhalte, die Sie an uns als Seitenbetreiber senden, nutzt unsere Website
        eine SSL-bzw. TLS-Verschlüsselung. Damit sind Daten, die Sie über diese
        Website übermitteln, für Dritte nicht mitlesbar. Sie erkennen eine
        verschlüsselte Verbindung an der „https://“ Adresszeile Ihres Browsers
        und am Schloss-Symbol in der Browserzeile.
      </Paragraph>
      <SectionTitle>Datenschutzbeauftragter</SectionTitle>
      <Paragraph>
        Wir haben einen Datenschutzbeauftragten bestellt.
        <br />
        Jürgen Geuter, Prinzessinnenstr. 1, 10969 Berlin
        <br />
        Telefon: +49 30 21001-0
        <br />
        E-Mail: datenschutz@artcom.de
      </Paragraph>
      <SectionTitle>Server-Log-Dateien</SectionTitle>
      <Paragraph>
        In Server-Log-Dateien erheben und speichern wir zum Zwecke der
        Überwachung der Funktion des angebotenen Dienstes automatisch
        Informationen, die Ihr Browser automatisch an uns übermittelt. Dies
        sind:
      </Paragraph>
      <List>
        <ListItem>Besuchte Seite auf unserer Domain</ListItem>
        <ListItem>Datum und Uhrzeit der Serveranfrage</ListItem>
        <ListItem>Browsertyp und Browserversion</ListItem>
        <ListItem>Verwendetes Betriebssystem</ListItem>
        <ListItem>Referrer URL</ListItem>
        <ListItem>Hostname des zugreifenden Rechners</ListItem>
        <ListItem>IP-Adresse</ListItem>
      </List>
      <Paragraph>
        Es findet keine Zusammenführung dieser Daten mit anderen Datenquellen
        statt. Grundlage der Datenverarbeitung bildet Art. 6 Abs. 1 lit. b
        DSGVO, der die Verarbeitung von Daten zur Erfüllung eines Vertrags oder
        vorvertraglicher Maßnahmen gestattet.
      </Paragraph>
      <SectionTitle>Privacy policy</SectionTitle>
      <Paragraph>
        The information in this declaration applies to the processing of
        personal data on or via our website and is intended in particular to
        inform you of the scope of processing, the purposes of processing, the
        recipients, legal bases, storage periods and your rights. Personal data
        are all information relating to an identified or identifiable natural
        person, i.e. a human being (hereinafter also referred to as “data
        subject”), including for example your name, your address or your e-mail
        address. &quot;Processing&quot; of personal data means in particular the
        collection, storage, use and transmission of such data.
      </Paragraph>
      <SectionTitle>Name and Address of the controller</SectionTitle>
      <Paragraph>
        The controller within the meaning of the General Data Protection
        Regulation (GDPR) and other national data protection laws of the member
        states as well as other data protection regulations is:
        <br />
        ART+COM GmbH
        <br />
        Prinzessinnenstraße 1<br />
        10969 Berlin
        <br />
        Germany
        <br />
        Phone +49 30 21001-0
        <br />
        info@artcom.de www.artcom.de
      </Paragraph>
      <SectionTitle>Contact data of the data protection officer</SectionTitle>
      <Paragraph>
        The data protection officer can be consulted under the following contact
        details:
        <br />
        Data Protection Officer
        <br />
        c/o ART+COM GmbH
        <br />
        Prinzessinnenstraße 1<br />
        10969 Berlin
        <br />
        Germany
        <br />
        privacy@artcom.de
      </Paragraph>
      <SectionTitle>General information data processing</SectionTitle>
      <Paragraph>
        <strong>1. Legal basis for the processing of personal data</strong>
        <br />
        Insofar as the data subject has given consent to the processing of his
        or her personal data for one or more specific purposes, legal basis is
        Art. 6 para. 1 lit. a GDPR. Insofar as the processing is necessary for
        the performance of a contract to which the data subject is party or in
        order to take steps at the request of the data subject prior to entering
        into a contract, legal basis is Art. 6 para. 1 lit. b GDPR. Insofar as
        the processing is necessary for compliance with a legal obligation to
        which the controller is subject, legal basis is Art. 6 para. 1 lit. c
        GDPR. If processing is necessary for the purposes of the legitimate
        interests pursued by the controller or by a third party, except where
        such interests are overridden by the interests or fundamental rights and
        freedoms of the data subject which require protection of personal data,
        legal basis is Art. 6 para. 1 lit. f GDPR.
      </Paragraph>
      <SectionTitle>Data erasure and storage time</SectionTitle>
      <Paragraph>
        The personal data of the data subject will be erased or processing
        restricted as soon as the purpose of storage ceases to apply. In certain
        cases, data can be stored if this has been provided for by the European
        or national legislator in EU regulations, laws or other provisions to
        which the controller is subject.
      </Paragraph>
      <SectionTitle>
        Provision of the website and creation of log files
      </SectionTitle>
      <Paragraph>
        <strong>1. Description and extent of data processing</strong>
        <br />
        Every time you visit our website, our system automatically collects data
        and information from the computer system of the accessing device
        (computer, smartphone, tablet, etc.). The following data is collected:
      </Paragraph>
      <List>
        <ListItem>
          Information about the browser type, the version used, installed
          plugins and the set language
        </ListItem>
        <ListItem>
          The operating system of the accessing device and its version
        </ListItem>
        <ListItem>The IP address of the accessing device</ListItem>
        <ListItem>Date and time of access and time spent on the site</ListItem>
        <ListItem>
          Loading time of the pages (average value for all accessed pages of the
          session)
        </ListItem>
        <ListItem>
          Websites from which the system of the accessing device reaches our
          website
        </ListItem>
        <ListItem>
          Websites that are accessed by the user device on our website
        </ListItem>
      </List>
      <Paragraph>
        This data is also stored in the log files of our system. This data is
        not stored together with other personal data of the user.
      </Paragraph>
      <Paragraph>
        <strong>2. Legal basis for data processing</strong>
        <br />
        Legal basis for the temporary storage of data and log files is Art. 6
        para. 1 lit. f GDPR.
      </Paragraph>
      <Paragraph>
        <strong>3. Purpose of data processing</strong>
        <br />
        The temporary storage of the IP address by the system is necessary to
        enable the website to be delivered to the user’s device. For this the IP
        address of the user must remain stored for the duration of the session.
        The data is stored in log files to ensure and improve the functionality
        of the website and for statistical evaluations. In addition, the data
        serves us to optimize the website and to ensure the security of our
        information technology systems. An evaluation of the data for marketing
        purposes does not take place in this context. Our legitimate interest in
        data processing also lies in these purposes.
      </Paragraph>
      <Paragraph>
        <strong>4. Possibility of opposition and elimination</strong>
        <br />
        The collection of data for the provision of the website and the storage
        of data in log files is absolutely necessary for the operation of the
        website. Consequently, there is no possibility of objection on the part
        of the user.
      </Paragraph>
      <SectionTitle>Rights of the data subject</SectionTitle>
      <Paragraph>
        If your personal data are processed, you are a data subject within the
        meaning of the GDPR and you have the following rights against the
        controller (in the case of the fulfilment of further conditions
        regulated in the relevant regulations, if applicable):
      </Paragraph>
      <List>
        <ListItem>The right of access according to Art. 15 GDPR</ListItem>
        <ListItem>
          The right to rectification according to Art. 16 GDPR
        </ListItem>
        <ListItem>
          The right to erasure (“right to be forgotten”) according to Art. 17
          GDPR
        </ListItem>
        <ListItem>
          The right to restriction of processing according to Art. 18 GDPR
        </ListItem>
        <ListItem>
          The right to a notification according to Art. 19 GDPR
        </ListItem>
        <ListItem>
          The right to data portability according to Art. 20 GDPR
        </ListItem>
        <ListItem>The right to object according to Art. 21 GDPR</ListItem>
        <ListItem>
          The right not to be subject to a decision based solely on automated
          processing according to Art. 22 GDPR
        </ListItem>
        <ListItem>
          The right to withdraw consent to the processing of personal data
          according to Art. 7 para. 3 GDPR
        </ListItem>
      </List>
      <Paragraph>
        To assert these rights, please contact our data protection officer at
        the aforementioned address.
      </Paragraph>
      <Paragraph>
        Without prejudice to any other administrative or judicial remedy, you
        also have the right to lodge a complaint with a supervisory authority,
        in particular in the Member State where you are staying, working or
        suspected of infringing, if you believe that the processing of personal
        data concerning you infringes the GDPR.
      </Paragraph>
      <SectionTitle>Security</SectionTitle>
      <Paragraph>
        In accordance with the &quot;Privacy By Design&quot; principle, all
        traffic exchanged between the user&apos;s browser and ART+COM servers is
        encrypted via SSL/TLS.
      </Paragraph>
    </Container>
  )
}
</file>

<file path="src/components/UI/SubHeadline.jsx">
import { motion } from "motion/react"
import { styled } from "styled-components"

const SubHeadline = styled(motion.div)`
  color: ${({ theme }) => theme.colors.background.paper};
  text-align: center;
  font-size: 1.5rem;
  font-style: normal;
  font-weight: 700;
  line-height: normal;
  position: relative;
  z-index: 3;
`

export default SubHeadline
</file>

<file path="src/components/Welcome/CharacterShowcase/components/CharacterCard.jsx">
import { motion } from "motion/react"
import { styled } from "styled-components"

import { CAROUSEL_ANIMATION } from "../utils/transformUtils"

const CharacterCardContainer = styled(motion.div)`
  flex: 0 0 100dvw;
  height: 100%;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-end;
  user-select: none;
`

const CharacterImage = styled(motion.img)`
  width: auto;
  height: 60dvh;
  margin-bottom: 5.25rem;
  object-fit: contain;
  filter: ${(props) =>
    `drop-shadow(0 ${0.5 + props.$shadowIntensity * 0.25}rem ${0.75 + props.$shadowIntensity * 0.5}rem rgba(0, 0, 0, ${0.4 - props.$shadowIntensity * 0.1}))`};
`

const CharacterCard = ({ character, scale, shadowIntensity }) => {
  return (
    <CharacterCardContainer
      initial={{ opacity: 0, y: 20 }}
      animate={{
        opacity: 1,
        y: 0,
        scale: scale,
      }}
      transition={{
        duration: 0.5,
        delay: 0.4,
        ease: "easeOut",
        scale: CAROUSEL_ANIMATION,
      }}
    >
      <CharacterImage
        initial={{ opacity: 0, scale: 0.8 }}
        animate={{ opacity: 1, scale: 1 }}
        transition={{
          duration: 0.6,
          delay: 0.6,
          ease: "easeOut",
        }}
        src={character.image}
        alt={character.name}
        $shadowIntensity={shadowIntensity}
      />
    </CharacterCardContainer>
  )
}

export default CharacterCard
</file>

<file path="src/routes/CharacterLayout.jsx">
import { extractFromContentTree } from "@/api/hooks"
import { allContentQuery } from "@/api/queries"
import useGlobalState from "@/hooks/useGlobalState"
import { getCurrentLocale } from "@/i18n"
import { useEffect } from "react"
import { Outlet, useLoaderData } from "react-router-dom"

export default function CharacterLayout() {
  const { characterIndex } = useLoaderData()
  const { setCurrentCharacterIndex } = useGlobalState()

  useEffect(() => {
    if (typeof characterIndex === "number") {
      setCurrentCharacterIndex(characterIndex)
    }
  }, [characterIndex, setCurrentCharacterIndex])

  return <Outlet />
}

export const loader =
  (queryClient) =>
  async ({ params }) => {
    const locale = getCurrentLocale()
    const query = allContentQuery(locale)
    const content = await queryClient.ensureQueryData(query)

    const characterId = params.characterId
    const characterIndex = Number.parseInt(characterId ?? "", 10)

    if (Number.isNaN(characterIndex) || characterIndex < 0) {
      throw new Response("Character not found", { status: 404 })
    }

    const characters = extractFromContentTree.getCharacters(content)

    if (!characters?.[characterIndex]) {
      throw new Response("Character not found", { status: 404 })
    }

    return { characterIndex }
  }
</file>

<file path="src/routes/ErrorPage.jsx">
import { isRouteErrorResponse, useRouteError } from "react-router-dom"
import { styled } from "styled-components"

const Wrapper = styled.div`
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  width: 100%;
  height: 100%;
  padding: 2rem;
  gap: 1.5rem;
  text-align: center;
`

const Title = styled.h1`
  font-size: 1.75rem;
  font-weight: 700;
`

const Message = styled.p`
  font-size: 1rem;
  max-width: 28rem;
`

const ErrorDetails = styled.pre`
  margin-top: 1rem;
  text-align: left;
  width: 100%;
  max-width: 28rem;
  overflow: auto;
  white-space: pre-wrap;
`

export default function ErrorPage() {
  const error = useRouteError()

  if (isRouteErrorResponse(error)) {
    return (
      <Wrapper>
        <Title>Something went wrong</Title>
        <Message>
          {error.status} {error.statusText}
        </Message>
      </Wrapper>
    )
  }

  return (
    <Wrapper>
      <Title>Unexpected application error</Title>
      <Message>
        {error instanceof Error ? error.message : "An unknown error occurred."}
      </Message>
      {error instanceof Error && <ErrorDetails>{error.stack}</ErrorDetails>}
      {console.log(error)}
    </Wrapper>
  )
}
</file>

<file path="src/routes/Root.jsx">
import { allContentQuery } from "@/api/queries"
import useGlobalState from "@/hooks/useGlobalState"
import { getCurrentLocale } from "@/i18n"
import { Outlet } from "react-router-dom"
import { styled } from "styled-components"

import Imprint from "@ui/Imprint"
import MobileOnlyGuard from "@ui/MobileOnlyGuard"
import Privacy from "@ui/Privacy"

const AppContainer = styled.div`
  width: 100dvw;
  height: 100dvh;
  overflow: hidden;
  position: relative;
`

const ScrollContainer = styled(AppContainer)`
  overflow: auto;
`

export function AppLayout({ children }) {
  const { showModal } = useGlobalState()

  if (showModal === "privacy") {
    return (
      <ScrollContainer>
        <Privacy />
      </ScrollContainer>
    )
  }

  if (showModal === "imprint") {
    return (
      <ScrollContainer>
        <Imprint />
      </ScrollContainer>
    )
  }

  return (
    <MobileOnlyGuard>
      <AppContainer>{children ?? <Outlet />}</AppContainer>
    </MobileOnlyGuard>
  )
}

export default function Root() {
  return <AppLayout />
}

export const loader = (queryClient) => async () => {
  const locale = getCurrentLocale()
  const query = allContentQuery(locale)
  const data = await queryClient.ensureQueryData(query)
  return { locale, hasContent: Array.isArray(data) && data.length > 0 }
}
</file>

<file path="src/theme/ThemeProvider.jsx">
import { theme } from "@theme"
import { ThemeProvider } from "styled-components"

export default function AppThemeProvider({ children }) {
  return <ThemeProvider theme={theme}>{children}</ThemeProvider>
}
</file>

<file path=".gitignore">
node_modules
dist
.eslintcache
.vscode
.env
</file>

<file path=".lintstagedrc.json">
{
  "*.{js,jsx}": ["eslint --cache --fix", "prettier --write"],
  "*.{json,css,md,yml}": ["prettier --write"]
}
</file>

<file path=".prettierrc">
{
  "semi": false,
  "plugins": ["@ianvs/prettier-plugin-sort-imports"],
  "importOrder": [
    "^@core/(.*)$",
    "",
    "^@server/(.*)$",
    "",
    "^@ui/(.*)$",
    "",
    "^[./]"
  ]
}
</file>

<file path="eslint.config.js">
import globals from "globals"
import pluginJs from "@eslint/js"
import pluginReact from "eslint-plugin-react"
import pluginReactHooks from "eslint-plugin-react-hooks"
import eslintConfigPrettier from "eslint-config-prettier"
import reactCompiler from "eslint-plugin-react-compiler"
import pluginQuery from "@tanstack/eslint-plugin-query"
import ReactThree from "@react-three/eslint-plugin"

/** @type {import('eslint').Linter.Config[]} */
export default [
  {
    languageOptions: {
      globals: {
        ...globals.browser,
      },
    },
  },

  {
    files: ["**/*.config.{js,mjs,cjs}", "vite.config.js", "eslint.config.js"],
    languageOptions: {
      globals: {
        ...globals.node,
        __dirname: "readonly",
        __filename: "readonly",
        process: "readonly",
        Buffer: "readonly",
      },
    },
  },

  pluginJs.configs.recommended,

  {
    files: ["**/*.{js,mjs,cjs,jsx}"],
    plugins: {
      react: pluginReact,
      "react-hooks": pluginReactHooks,
      "react-compiler": reactCompiler,
      "@tanstack/query": pluginQuery,
    },
    languageOptions: {
      ...pluginReact.configs.flat.recommended.languageOptions,
    },
    rules: {
      ...pluginReact.configs.flat.recommended.rules,
      ...pluginReact.configs.flat["jsx-runtime"].rules,
      ...pluginQuery.configs["flat/recommended"].rules,
      ...pluginReactHooks.configs.recommended.rules,
      "react-compiler/react-compiler": "error",
      "react/prop-types": "off",
      "react-hooks/exhaustive-deps": "warn",
    },
    settings: {
      react: {
        version: "detect",
      },
    },
  },

  {
    files: ["src/components/Gallery/**/*.{js,jsx}"],
    plugins: {
      "@react-three": ReactThree,
    },
    rules: {
      ...ReactThree.configs.recommended.rules,
      "react/no-unknown-property": "off",
    },
  },

  eslintConfigPrettier,
]
</file>

<file path="index.html">
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Cheminova</title>

    <!-- Favicon -->
    <link rel="icon" href="/favicon.ico" sizes="any" />
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
  </head>
  <body>
    <div id="root"></div>
    <noscript>
      This application requires JavaScript to run. Please enable JavaScript in
      your browser and try again.
    </noscript>
    <script type="module" src="/src/main.jsx"></script>
  </body>
</html>
</file>

<file path="jsconfig.json">
{
  "compilerOptions": {
    "baseUrl": ".",
    "checkJs": false,
    "allowJs": true,
    "paths": {
      "@/*": ["src/*"],
      "@components/*": ["src/components/*"],
      "@hooks/*": ["src/hooks/*"],
      "@api/*": ["src/api/*"],
      "@ui/*": ["src/components/UI/*"],
      "@theme/*": ["src/theme/*"]
    }
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules"]
}
</file>

<file path="react-router.md">
# React Router Integration Guide

## High-Level Overview

The application now uses the React Router data APIs to drive the entire screen flow. Instead of keeping screen names inside component state, we declare a nested route tree and let the router own navigation, data prefetching, and error handling. Each screen exports a `loader` that guarantees the right slice of CMS content is available before the component renders. TanStack Query supplies caching and deduplication for CMS calls, and the router loaders hydrate that cache before React renders the route.

## Route Hierarchy

```
/
├── (root)                 → <Root /> layout
│   ├── index              → <Welcome />
│   └── characters/:id     → <CharacterLayout />
│       ├── index          → Redirect → introduction
│       ├── introduction   → <Introduction />
│       ├── photo-capture  → <PhotoCapture />
│       ├── exploration    → <Exploration />
│       ├── perspective    → <Perspective />
│       ├── upload         → <Upload />
│       ├── gallery        → <Gallery />
│       └── ending         → <Ending />
└── error boundary         → <AppLayout><ErrorPage /></ErrorPage>
```

- `Root` renders the global layout, modal handling, and mobile guard. Its loader ensures the CMS tree is fetched so children have content.
- `CharacterLayout` validates `:characterId`, sets the global `currentCharacterIndex`, and guards against unknown characters.
- Each leaf screen consumes loader data via `useLoaderData()` with no extra fetch calls when the cache is warm.

## Loader Pattern

Every route exposes a `loader` factory that accepts the shared `queryClient`. The pattern looks like this:

```js
export const loader =
  (queryClient) =>
  async ({ params }) => {
    const locale = getCurrentLocale()
    const query = allContentQuery(locale)
    const content = await queryClient.ensureQueryData(query)
    // ...derive content for this route...
    return { characterIndex, introduction }
  }
```

Key details:

- **Locale-aware**: `getCurrentLocale()` now safely normalises the current language (no more `.trim()` on `undefined`).
- **Shared query options**: `allContentQuery(locale)` returns the canonical query config for the entire CMS tree, so every loader hits the same cache entry.
- **Prefetch via `ensureQueryData`**: If the data exists, React Query returns it synchronously; otherwise it fetches and caches before React renders the route element.
- **Validation**: Loaders throw `new Response("Character not found", { status: 404 })` when params are invalid, letting React Router surface the 404 within our error boundary.

## Loader Data Consumption

Components read loader data only through `useLoaderData()` or (for nested components under `Welcome`) `useRouteLoaderData("welcome")`. Examples:

- `Introduction` receives `{ characterIndex, character, introduction }` and renders synchronised content.
- `PhotoCapture` uses loader data for `photography` task metadata while local state tracks captured images.
- `Gallery` combines loader content (headings/buttons) with TanStack query data for uploaded pictures.

No component calls `useAllContent()` directly anymore, eliminating duplicate fetches.

## TanStack Query + Router

- A single `QueryClient` is created in `main.jsx` and shared with both loaders and the app via `QueryClientProvider`.
- Loaders seed the cache with `ensureQueryData` before React renders.
- Screen-level hooks (`useGalleryImages`, `useUploadImage`, etc.) still use TanStack Query for sections that rely on user state or mutations, complementing loader-provided CMS data.
- React Query Devtools remain available for debugging (`<ReactQueryDevtools />`).

## Navigation & Redirects

- `Navigate to="introduction" replace` ensures `/characters/:id` immediately redirects to the first step.
- Components use `useNavigate()` and URL paths (`navigate(/characters/${characterIndex}/perspective)`), keeping navigation declarative and URL-driven.
- Global state (`StateProvider`) still tracks non-route concerns (captured images, modal state).

## Error Handling & Hydration

- `Root` uses `errorElement` to render `<AppLayout><ErrorPage /></AppLayout>` when loaders throw.
- `ErrorPage` now displays stack traces in a `<pre>` outside the `<p>`, avoiding hydration warnings.
- `RouterProvider` is configured with both `fallbackElement={null}` and `hydrateFallbackElement={<></>}` to satisfy React Router’s hydration requirements alongside our Suspense fallback.

## Welcome Screen Sharing

`Welcome` loader returns `{ welcome, characterOverview, characters }`. Nested components (`CharacterShowcase`, `CharacterCarousel`, `Intro`) read that data via `useLoaderData()` / `useRouteLoaderData("welcome")`, so they render instantly without issuing new requests, yet still react to global state updates.

## Mutations & Upload Flow

- `useUploadImage` still uses its own query/mutation because it deals with user-generated uploads, not static CMS content. It reads the current character from route params and invalidates image queries on success.

## What Changed Conceptually

1. **URL-driven state**: Character and screen progression reflect in the URL, enabling deep linking and back/forward support.
2. **Data preloading**: Loaders and TanStack Query cooperate so each screen has its CMS slice ready before render.
3. **Safer locale management**: New helpers guard against invalid language codes and fall back gracefully.
4. **Improved error UX**: Proper error boundary layout and hydration-safe markup.
5. **Hydration configuration**: Explicit fallback elements prevent runtime warnings while keeping initial render blank.

This structure provides a foundation for extending the flow (e.g., adding new child routes or data loaders) while keeping CMS access centralised and cached. For new screens, follow the same loader pattern: validate params, call `ensureQueryData`, extract the required subtree with `extractFromContentTree`, and return those slices for `useLoaderData()` to consume.
</file>

<file path="README.md">
# Cheminova Frontend

## Prerequisites

- node
- npm

## Development

**Install dependencies:**

```bash
npm i
```

**Start the Vite development server**

```bash
npm run dev
```

Open http://localhost:5173 in your browser. The server automatically reloads on file changes.

### Bundling

To bundle the application with vite which uses rollup, run the following command in the cli from the root directory of project:

```bash
npm run build
```

### Enable prettier (VSCode)

```json
{
  "editor.formatOnSave": true,
  "editor.defaultFormatter": "esbenp.prettier-vscode",
  "[javascript]": {
    ".editor.defaultFormatter": "esbenp.prettier-vscode"
  }
}
```

# Talk

## Performance Opimization

**Reducing Bundle Size:**

- https://shaxadd.medium.com/optimizing-your-react-vite-application-a-guide-to-reducing-bundle-size-6b7e93891c96

```JSX
import React, { Suspense } from 'react';

const MyComponent = React.lazy(() => import('./MyComponent'));
function App() {
  return (
    <Suspense fallback={<div>Loading...</div>}>
      <MyComponent />
    </Suspense>
  );
}
export default App;
```
</file>

<file path=".github/instructions/react.instructions.md">
---
description: "ReactJS development standards and best practices"
applyTo: "**/*.jsx, **/*.tsx, **/*.js, **/*.ts, **/*.css, **/*.scss"
---

# ReactJS Development Instructions

Instructions for building high-quality ReactJS applications with modern patterns, hooks, and best practices following the official React documentation at https://react.dev.

## Project Context

- Latest React version (React 19+)
- TypeScript for type safety (when applicable)
- Functional components with hooks as default
- Follow React's official style guide and best practices
- Use modern build tools (Vite, Create React App, or custom Webpack setup)
- Implement proper component composition and reusability patterns

## Development Standards

### Architecture

- Use functional components with hooks as the primary pattern
- Implement component composition over inheritance
- Organize components by feature or domain for scalability
- Separate presentational and container components clearly
- Use custom hooks for reusable stateful logic
- Implement proper component hierarchies with clear data flow

### TypeScript Integration

- Use TypeScript interfaces for props, state, and component definitions
- Define proper types for event handlers and refs
- Implement generic components where appropriate
- Use strict mode in `tsconfig.json` for type safety
- Leverage React's built-in types (`React.FC`, `React.ComponentProps`, etc.)
- Create union types for component variants and states

### Component Design

- Follow the single responsibility principle for components
- Use descriptive and consistent naming conventions
- Implement proper prop validation with TypeScript or PropTypes
- Design components to be testable and reusable
- Keep components small and focused on a single concern
- Use composition patterns (render props, children as functions)

### State Management

- Use `useState` for local component state
- Implement `useReducer` for complex state logic
- Leverage `useContext` for sharing state across component trees
- Consider external state management (Redux Toolkit, Zustand) for complex applications
- Implement proper state normalization and data structures
- Use React Query or SWR for server state management

### Hooks and Effects

- Use `useEffect` with proper dependency arrays to avoid infinite loops
- Implement cleanup functions in effects to prevent memory leaks
- Use `useMemo` and `useCallback` for performance optimization when needed
- Create custom hooks for reusable stateful logic
- Follow the rules of hooks (only call at the top level)
- Use `useRef` for accessing DOM elements and storing mutable values

### Styling

- Use CSS Modules, Styled Components, or modern CSS-in-JS solutions
- Implement responsive design with mobile-first approach
- Follow BEM methodology or similar naming conventions for CSS classes
- Use CSS custom properties (variables) for theming
- Implement consistent spacing, typography, and color systems
- Ensure accessibility with proper ARIA attributes and semantic HTML

### Performance Optimization

- Use `React.memo` for component memoization when appropriate
- Implement code splitting with `React.lazy` and `Suspense`
- Optimize bundle size with tree shaking and dynamic imports
- Use `useMemo` and `useCallback` judiciously to prevent unnecessary re-renders
- Implement virtual scrolling for large lists
- Profile components with React DevTools to identify performance bottlenecks

### Data Fetching

- Use modern data fetching libraries (React Query, SWR, Apollo Client)
- Implement proper loading, error, and success states
- Handle race conditions and request cancellation
- Use optimistic updates for better user experience
- Implement proper caching strategies
- Handle offline scenarios and network errors gracefully

### Error Handling

- Implement Error Boundaries for component-level error handling
- Use proper error states in data fetching
- Implement fallback UI for error scenarios
- Log errors appropriately for debugging
- Handle async errors in effects and event handlers
- Provide meaningful error messages to users

### Forms and Validation

- Use controlled components for form inputs
- Implement proper form validation with libraries like Formik, React Hook Form
- Handle form submission and error states appropriately
- Implement accessibility features for forms (labels, ARIA attributes)
- Use debounced validation for better user experience
- Handle file uploads and complex form scenarios

### Routing

- Use React Router for client-side routing
- Implement nested routes and route protection
- Handle route parameters and query strings properly
- Implement lazy loading for route-based code splitting
- Use proper navigation patterns and back button handling
- Implement breadcrumbs and navigation state management

### Testing

- Write unit tests for components using React Testing Library
- Test component behavior, not implementation details
- Use Jest for test runner and assertion library
- Implement integration tests for complex component interactions
- Mock external dependencies and API calls appropriately
- Test accessibility features and keyboard navigation

### Security

- Sanitize user inputs to prevent XSS attacks
- Validate and escape data before rendering
- Use HTTPS for all external API calls
- Implement proper authentication and authorization patterns
- Avoid storing sensitive data in localStorage or sessionStorage
- Use Content Security Policy (CSP) headers

### Accessibility

- Use semantic HTML elements appropriately
- Implement proper ARIA attributes and roles
- Ensure keyboard navigation works for all interactive elements
- Provide alt text for images and descriptive text for icons
- Implement proper color contrast ratios
- Test with screen readers and accessibility tools

## Implementation Process

1. Plan component architecture and data flow
2. Set up project structure with proper folder organization
3. Define TypeScript interfaces and types
4. Implement core components with proper styling
5. Add state management and data fetching logic
6. Implement routing and navigation
7. Add form handling and validation
8. Implement error handling and loading states
9. Add testing coverage for components and functionality
10. Optimize performance and bundle size
11. Ensure accessibility compliance
12. Add documentation and code comments

## Additional Guidelines

- Follow React's naming conventions (PascalCase for components, camelCase for functions)
- Use meaningful commit messages and maintain clean git history
- Implement proper code splitting and lazy loading strategies
- Document complex components and custom hooks with JSDoc
- Use ESLint and Prettier for consistent code formatting
- Keep dependencies up to date and audit for security vulnerabilities
- Implement proper environment configuration for different deployment stages
- Use React Developer Tools for debugging and performance analysis

## Common Patterns

- Higher-Order Components (HOCs) for cross-cutting concerns
- Render props pattern for component composition
- Compound components for related functionality
- Provider pattern for context-based state sharing
- Container/Presentational component separation
- Custom hooks for reusable logic extracti
</file>

<file path="src/components/Ending/index.js">
export { default, loader } from "./Ending"
</file>

<file path="src/components/Ending/README.md">
# Ending and Perspective Components

This document describes the enhanced Ending and Perspective components that integrate with the backend API to provide dynamic, personalized content for the Cheminova experience.

## Overview

The Ending and Perspective components have been enhanced with:

- Dynamic content loading from the backend API
- Background image support
- Loading states and error handling
- Personalized content based on user journey
- Improved UI/UX with animations and visual feedback
- Multilingual support with fallback content

## Components

### Ending Component

The Ending component serves as the final screen of the user journey, providing closure and thanks to the user for their participation.

#### Features

- **Dynamic Content**: Fetches personalized ending content from the backend
- **Background Images**: Supports dynamic background images from the CMS
- **Celebration Animation**: Animated celebration message with delayed appearance
- **Graceful Fallback**: Falls back to static translations if API fails
- **Loading States**: Shows loading spinner while fetching content
- **Error Handling**: Displays user-friendly error messages

#### Props

```jsx
<Ending goToWelcome={() => setState("welcome")} />
```

- `goToWelcome` (function): Callback to navigate back to welcome screen

#### API Integration

The component uses the `useEndingContent` hook to fetch data from:

```
/api/ending-screen/{id}/
```

The content is structured hierarchically:

```
Welcome → CharacterOverview → ChooseCharacter → IntroSearchAndCollect →
PhotographyScreen → YourCollection → PerspectiveScreen → EndingScreen
```

### Perspective Component

The Perspective component bridges the exploration phase with the upload phase, encouraging users to contribute their photos to the collective gallery.

#### Features

- **Dynamic Content**: Fetches personalized perspective content from the backend
- **Background Images**: Supports dynamic background images from the CMS
- **Content Personalization**: Shows content based on user's selected character/path
- **Responsive Design**: Adapts to different screen sizes
- **Loading States**: Provides visual feedback during content loading
- **Error Recovery**: Handles API failures gracefully

#### Props

```jsx
<Perspective goToUpload={() => setState("upload")} />
```

- `goToUpload` (function): Callback to navigate to upload screen

#### API Integration

The component uses the `usePerspectiveContent` hook to fetch data from:

```
/api/perspective-screen/{id}/
```

## Custom Hooks

### usePerspectiveContent

Hook for fetching perspective screen content.

```jsx
const {
  data: perspectiveData,
  isLoading,
  error,
  isError,
} = usePerspectiveContent()
```

**Returns:**

- `data`: Transformed perspective screen data
- `isLoading`: Boolean loading state
- `error`: Error object if request fails
- `isError`: Boolean error state

### useEndingContent

Hook for fetching ending screen content.

```jsx
const { data: endingData, isLoading, error, isError } = useEndingContent()
```

**Returns:**

- `data`: Transformed ending screen data
- `isLoading`: Boolean loading state
- `error`: Error object if request fails
- `isError`: Boolean error state

## Utilities

### apiUtils.js

Utility functions for API operations:

- `parseRichText(richText)`: Parses various rich text formats
- `navigateToScreen(localeContent, targetType)`: Navigates content hierarchy
- `transformScreenData(screenData, fallbackTitle, fallbackDescription)`: Standardizes screen data
- `handleApiError(error, context)`: Provides user-friendly error messages
- `processImageUrl(imageData, baseUrl)`: Processes and validates image URLs

## Data Structure

### Screen Data Format

Both components expect data in the following format:

```javascript
{
  id: number,
  title: string,
  description: string, // HTML content
  backgroundImage: {
    file: string // URL to image
  },
  locale: string
}
```

### Content Hierarchy

The backend content follows a hierarchical structure:

```
Welcome (Page)
└── CharacterOverview (Page)
    └── ChooseCharacter (Page) × 3
        └── IntroSearchAndCollect (Page)
            └── PhotographyScreen (Page)
                └── YourCollection (Page)
                    └── PerspectiveScreen (Page)
                        └── EndingScreen (Page)
```

## Localization

Both components support multiple languages with fallback behavior:

1. **Primary**: Dynamic content from API in user's language
2. **Fallback**: Static translations from i18n files
3. **Default**: English content as last resort

### Translation Keys

#### Perspective Component

- `perspective.title`
- `perspective.description`
- `perspective.loading`
- `perspective.success`

#### Ending Component

- `ending.title`
- `ending.description`
- `ending.loading`
- `ending.celebration`
- `ending.thankYouMessage`

## Styling

Both components use styled-components with:

- Responsive design patterns
- CSS-in-JS for dynamic styling
- Animation support with keyframes
- Theme-aware color schemes
- Accessibility considerations

### Key Style Features

- **Background Images**: Dynamic background with overlay
- **Loading States**: Opacity transitions during loading
- **Error States**: Distinctive error message styling
- **Animations**: Smooth transitions and celebratory animations
- **Typography**: Consistent font hierarchy using Bricolage Grotesque

## Error Handling

The components implement comprehensive error handling:

1. **Network Errors**: Connection issues, timeouts
2. **API Errors**: Server errors, not found responses
3. **Content Errors**: Missing or malformed content
4. **Image Errors**: Failed image loads, invalid URLs

### Error Recovery

- **Retry Logic**: Automatic retry with exponential backoff
- **Graceful Degradation**: Falls back to static content
- **User Feedback**: Clear error messages in user's language
- **Logging**: Comprehensive error logging for debugging

## Performance Considerations

### Optimizations

- **Image Preloading**: Background images are preloaded
- **Query Caching**: API responses cached for 10 minutes
- **Lazy Loading**: Content loaded only when needed
- **Memory Management**: Proper cleanup of resources

### Bundle Size

- **Tree Shaking**: Only required utilities are bundled
- **Code Splitting**: Components can be lazy-loaded
- **Asset Optimization**: Images processed through build pipeline

## Testing

### Component Testing

Test both components for:

- Rendering with mock data
- Loading states
- Error states
- User interactions
- API integration

### Hook Testing

Test custom hooks for:

- Data fetching
- Error handling
- Retry logic
- Caching behavior

### Integration Testing

Test the complete flow:

- API data fetching
- Content transformation
- UI rendering
- User navigation

## Development Workflow

1. **Backend First**: Ensure CMS content is populated
2. **API Testing**: Verify API endpoints return expected data
3. **Component Development**: Build components with mock data
4. **Integration**: Connect components to real API
5. **Testing**: Comprehensive testing across scenarios
6. **Optimization**: Performance and accessibility improvements

## Troubleshooting

### Common Issues

1. **Content Not Loading**
   - Check API endpoint availability
   - Verify content hierarchy in CMS
   - Check console for API errors

2. **Images Not Displaying**
   - Verify image URLs are accessible
   - Check CORS configuration
   - Validate image file formats

3. **Translation Issues**
   - Ensure translation files are complete
   - Check i18n configuration
   - Verify language detection

### Debug Mode

Enable debug logging by setting:

```javascript
localStorage.setItem("DEBUG", "cheminova:*")
```

This will show detailed API request/response logging and component state changes.
</file>

<file path="src/components/ExampleQueries/index.js">
export {}
</file>

<file path="src/components/Exploration/CameraIcon.jsx">
export default function CameraIcon() {
  return (
    <svg
      xmlns="http://www.w3.org/2000/svg"
      width="32"
      height="25"
      viewBox="0 0 32 25"
      fill="none"
    >
      <rect
        x="1"
        y="1"
        width="53"
        height="53"
        rx="26.5"
        transform="matrix(0 1 1 0 0 0)"
        stroke="white"
        strokeWidth="2"
      />
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M11.0226 1.0001C10.4679 1.0001 9.99746 1.27542 9.70104 1.62147C9.40462 1.96752 9.23371 2.36952 9.08513 2.75504C9.08512 2.75642 9.08512 2.7578 9.08513 2.75918L8.53708 4.17837H2.73293C1.50438 4.17837 0.5 5.16814 0.5 6.37204V21.8053C0.5 23.0092 1.50438 24 2.73293 24H29.2702C30.4988 24 31.5 23.0092 31.5 21.8053V6.37205C31.5 5.16815 30.4988 4.17837 29.2702 4.17837H23.4661L22.918 2.75912C22.918 2.75877 22.918 2.75947 22.918 2.75912C22.918 2.75877 22.918 2.75738 22.918 2.75703C22.918 2.75668 22.918 2.75738 22.918 2.75703C22.918 2.75668 22.918 2.75529 22.918 2.75494C22.7694 2.36952 22.5985 1.96742 22.3021 1.62137C22.0057 1.27532 21.5352 1 20.9805 1L11.0226 1.0001ZM11.0226 2.04592H20.9805C21.2227 2.04592 21.3282 2.11378 21.4816 2.29284C21.6349 2.4719 21.7855 2.7765 21.92 3.12541L22.5986 4.88341C22.6364 4.98257 22.7042 5.06816 22.7929 5.12883C22.8817 5.1895 22.9872 5.2224 23.0955 5.22318H29.2702C29.9201 5.22318 30.4342 5.72407 30.4342 6.37205V21.8053C30.4342 22.4533 29.9201 22.9542 29.2702 22.9542H2.73293C2.08307 22.9542 1.56897 22.4533 1.56897 21.8053V6.37205C1.56897 5.72407 2.08307 5.22318 2.73293 5.22318H8.90766C9.01595 5.2224 9.12145 5.1895 9.21018 5.12883C9.29892 5.06816 9.3667 4.98257 9.40457 4.88341L10.0831 3.12541C10.2176 2.7765 10.3682 2.47189 10.5216 2.29284C10.6749 2.11377 10.7804 2.04592 11.0226 2.04592ZM16.0021 7.22809C12.1593 7.22809 9.03815 10.3075 9.03815 14.0887C9.03815 17.8699 12.1593 20.9533 16.0021 20.9533C19.8449 20.9533 22.965 17.8699 22.965 14.0887C22.965 10.3075 19.8449 7.22809 16.0021 7.22809ZM27.3473 7.43828C27.2473 7.43861 27.1484 7.45819 27.0561 7.4959C26.9638 7.53362 26.8801 7.58873 26.8096 7.65808C26.7391 7.72743 26.6833 7.80968 26.6454 7.90011C26.6074 7.99054 26.588 8.0874 26.5884 8.18515C26.5891 8.38167 26.6693 8.56995 26.8114 8.70892C26.9536 8.84788 27.1462 8.92625 27.3473 8.92691C27.4474 8.92739 27.5466 8.90857 27.6393 8.87153C27.7319 8.8345 27.8162 8.77997 27.8873 8.71108C27.9583 8.64219 28.0148 8.56027 28.0534 8.47003C28.0921 8.37978 28.1122 8.28298 28.1125 8.18515C28.1129 8.08688 28.0933 7.98953 28.0549 7.89869C28.0166 7.80786 27.9602 7.72534 27.8891 7.65591C27.818 7.58647 27.7335 7.5315 27.6405 7.49414C27.5475 7.45679 27.4479 7.4378 27.3473 7.43828ZM16.0021 8.27391C19.2622 8.27391 21.896 10.8673 21.896 14.0887C21.896 17.3101 19.2622 19.9085 16.0021 19.9085C12.742 19.9085 10.1071 17.3101 10.1071 14.0887C10.1071 10.8673 12.742 8.27391 16.0021 8.27391Z"
        fill="black"
      />
      <path
        d="M22.918 2.75912L23.4661 4.17837H29.2702C30.4988 4.17837 31.5 5.16815 31.5 6.37205V21.8053C31.5 23.0092 30.4988 24 29.2702 24H2.73293C1.50438 24 0.5 23.0092 0.5 21.8053V6.37204C0.5 5.16814 1.50438 4.17837 2.73293 4.17837H8.53708L9.08513 2.75918C9.08512 2.7578 9.08512 2.75642 9.08513 2.75504C9.23371 2.36952 9.40462 1.96752 9.70104 1.62147C9.99746 1.27542 10.468 1.0001 11.0226 1.0001L20.9805 1C21.5352 1 22.0057 1.27532 22.3021 1.62137C22.5985 1.96742 22.7694 2.36952 22.918 2.75494C22.918 2.75529 22.918 2.75668 22.918 2.75703M22.918 2.75912C22.918 2.75877 22.918 2.75947 22.918 2.75912ZM22.918 2.75912C22.918 2.75877 22.918 2.75738 22.918 2.75703M22.918 2.75703C22.918 2.75668 22.918 2.75738 22.918 2.75703ZM11.0226 2.04592H20.9805C21.2227 2.04592 21.3282 2.11378 21.4816 2.29284C21.6349 2.4719 21.7855 2.7765 21.92 3.12541L22.5986 4.88341C22.6364 4.98257 22.7042 5.06816 22.7929 5.12883C22.8817 5.1895 22.9872 5.2224 23.0955 5.22318H29.2702C29.9201 5.22318 30.4342 5.72407 30.4342 6.37205V21.8053C30.4342 22.4533 29.9201 22.9542 29.2702 22.9542H2.73293C2.08307 22.9542 1.56897 22.4533 1.56897 21.8053V6.37205C1.56897 5.72407 2.08307 5.22318 2.73293 5.22318H8.90766C9.01595 5.2224 9.12145 5.1895 9.21018 5.12883C9.29892 5.06816 9.3667 4.98257 9.40457 4.88341L10.0831 3.12541C10.2176 2.7765 10.3682 2.47189 10.5216 2.29284C10.6749 2.11377 10.7804 2.04592 11.0226 2.04592ZM16.0021 7.22809C12.1593 7.22809 9.03815 10.3075 9.03815 14.0887C9.03815 17.8699 12.1593 20.9533 16.0021 20.9533C19.8449 20.9533 22.965 17.8699 22.965 14.0887C22.965 10.3075 19.8449 7.22809 16.0021 7.22809ZM27.3473 7.43828C27.2473 7.43861 27.1484 7.45819 27.0561 7.4959C26.9638 7.53362 26.8801 7.58872 26.8096 7.65808C26.7391 7.72743 26.6833 7.80968 26.6454 7.90011C26.6074 7.99054 26.588 8.0874 26.5884 8.18515C26.5891 8.38167 26.6693 8.56995 26.8114 8.70892C26.9536 8.84788 27.1463 8.92625 27.3473 8.92691C27.4474 8.92739 27.5466 8.90856 27.6393 8.87153C27.7319 8.8345 27.8162 8.77997 27.8873 8.71108C27.9583 8.64219 28.0148 8.56027 28.0534 8.47003C28.0921 8.37978 28.1122 8.28298 28.1125 8.18515C28.1129 8.08688 28.0933 7.98953 28.0549 7.89869C28.0166 7.80786 27.9602 7.72534 27.8891 7.65591C27.818 7.58647 27.7335 7.53149 27.6405 7.49414C27.5475 7.45679 27.4479 7.4378 27.3473 7.43828ZM16.0021 8.27391C19.2622 8.27391 21.896 10.8673 21.896 14.0887C21.896 17.3101 19.2622 19.9085 16.0021 19.9085C12.742 19.9085 10.1071 17.3101 10.1071 14.0887C10.1071 10.8673 12.742 8.27391 16.0021 8.27391Z"
        stroke="black"
      />
    </svg>
  )
}
</file>

<file path="src/components/Exploration/index.js">
export { default, loader } from "./Exploration"
</file>

<file path="src/components/Gallery/components/CameraController.jsx">
import { useFrame, useThree } from "@react-three/fiber"
import { useEffect, useRef } from "react"

import {
  CAMERA_DEFAULT_Z,
  CAMERA_LERP,
  DEBUG_GALLERY,
  DETAIL_CAMERA_Z,
} from "../config"

export default function CameraController({ detailMode }) {
  const { camera } = useThree()
  const lastCamLogRef = useRef(0)

  useEffect(() => {
    if (!detailMode) {
      camera.position.set(
        camera.position.x,
        camera.position.y,
        CAMERA_DEFAULT_Z,
      )
    }
  }, [detailMode, camera])

  useFrame(() => {
    if (!detailMode) return
    const dz = DETAIL_CAMERA_Z - camera.position.z
    if (Math.abs(dz) < 0.001) return
    camera.position.set(
      camera.position.x,
      camera.position.y,
      camera.position.z + dz * CAMERA_LERP,
    )
    if (DEBUG_GALLERY) {
      const now = performance.now()
      if (now - lastCamLogRef.current > 500) {
        console.debug("[Camera] pos", {
          x: camera.position.x.toFixed(2),
          y: camera.position.y.toFixed(2),
          z: camera.position.z.toFixed(2),
        })
        lastCamLogRef.current = now
      }
    }
  })
  return null
}
</file>

<file path="src/components/Gallery/components/GalleryContent.jsx">
import { useThree } from "@react-three/fiber"
import { useEffect, useMemo, useRef } from "react"

import {
  ANIMATION_DURATION,
  BASE_IMAGE_SCALE,
  DEBUG_GALLERY,
  DISPLACEMENT_RATIO,
  MAX_RANDOM_DELAY,
  PERSONAL_SCALE_MULTIPLIER,
} from "../config"
import {
  buildDelays,
  buildTileData,
  computeGridMetrics,
  selectCentralIndices,
} from "../utils"
import AnimatingTile from "./AnimatingTile"

export default function GalleryContent({
  imagePool,
  targetTilesPerRow,
  personalImages,
  onAllAnimationsDone,
  detailMode,
  setDetailMode,
  canEnterDetail,
  activeIndex,
  setActiveIndex,
  detailStackScale,
  setDetailStackScale,
  onStackSizeChange,
  switchInfo,
  onDebugDataUpdate,
}) {
  const { viewport } = useThree()
  const vw = viewport.width
  const vh = viewport.height
  const ready = vw > 0 && vh > 0

  const { tileData, personalAnimationStartTime } = useMemo(() => {
    if (!ready) return { tileData: [], personalAnimationStartTime: 0 }

    const tilesPerRow = targetTilesPerRow
    const { idealTileWidth, tilesPerColumn, zeroX, zeroY } = computeGridMetrics(
      {
        viewportWidth: vw,
        viewportHeight: vh,
        tilesPerRow,
      },
    )

    const totalTiles = Math.min(tilesPerRow * tilesPerColumn, imagePool.length)
    const images = imagePool.slice(0, totalTiles)

    const personalIndices = selectCentralIndices({
      totalTiles,
      tilesPerRow,
      tilesPerColumn,
      count: personalImages.length,
      seed: totalTiles * 31 + tilesPerRow * 17 + tilesPerColumn * 13,
    })

    const delays = buildDelays(
      images.length,
      MAX_RANDOM_DELAY,
      totalTiles * 97 + tilesPerRow * 71 + tilesPerColumn * 53,
    )
    const maxDelay = Math.max(...delays)
    const personalAnimationStartTime = maxDelay + ANIMATION_DURATION

    const responsiveBaseScale =
      vw <= 480 ? Math.min(1.2, BASE_IMAGE_SCALE) * 0.9 : BASE_IMAGE_SCALE
    const responsivePersonalMultiplier =
      vw <= 480
        ? Math.min(1.2, PERSONAL_SCALE_MULTIPLIER)
        : PERSONAL_SCALE_MULTIPLIER

    const tileData = buildTileData({
      images,
      tilesPerRow,
      idealTileWidth,
      zeroX,
      zeroY,
      displacementRatio: DISPLACEMENT_RATIO,
      delays,
      maxDelay,
      personalImages: { indices: personalIndices, urls: personalImages },
      baseImageScale: responsiveBaseScale,
      personalScaleMultiplier: responsivePersonalMultiplier,
      seed: totalTiles * 7 + tilesPerRow * 11 + tilesPerColumn * 19,
    })

    return {
      tileData,
      personalAnimationStartTime,
      responsiveBaseScale,
      idealTileWidth,
    }
  }, [ready, vw, vh, targetTilesPerRow, imagePool, personalImages])

  const frozenRef = useRef({ tileData: null, personalStart: 0 })
  const prevDetailRef = useRef(false)
  useEffect(() => {
    if (detailMode && !prevDetailRef.current) {
      frozenRef.current = {
        tileData,
        personalStart: personalAnimationStartTime,
      }
    } else if (!detailMode && prevDetailRef.current) {
      frozenRef.current = { tileData: null, personalStart: 0 }
    }
    prevDetailRef.current = detailMode
  }, [detailMode, tileData, personalAnimationStartTime])

  const effectiveTileData =
    detailMode && frozenRef.current.tileData
      ? frozenRef.current.tileData
      : tileData
  const effectivePersonalStart =
    detailMode && frozenRef.current.personalStart
      ? frozenRef.current.personalStart
      : personalAnimationStartTime

  // If not yet captured, default to the first tile’s scale; once captured, keep it until exit
  const computedDefaultDetailScale = useMemo(() => {
    if (!ready || !tileData.length) return 1
    return tileData[0].scale
  }, [ready, tileData])

  const completedRef = useRef(0)
  const total = effectiveTileData.length
  useEffect(() => {
    completedRef.current = 0
  }, [total])

  const handleTileCompleted = () => {
    completedRef.current += 1
    if (completedRef.current === total && onAllAnimationsDone)
      onAllAnimationsDone()
  }

  useEffect(() => {
    onStackSizeChange && onStackSizeChange(effectiveTileData.length)
  }, [effectiveTileData.length, onStackSizeChange])

  const currentPositionsRef = useRef({})

  const handlePositionUpdate = (tileIndex, position) => {
    currentPositionsRef.current[tileIndex] = position
    if (onDebugDataUpdate && effectiveTileData.length > 0) {
      const updatedTileData = effectiveTileData.map((tile, idx) => ({
        ...tile,
        currentPosition: currentPositionsRef.current[idx] || tile.position,
      }))
      onDebugDataUpdate(updatedTileData)
    }
  }

  useEffect(() => {
    if (onDebugDataUpdate && effectiveTileData.length > 0) {
      const updatedTileData = effectiveTileData.map((tile, idx) => ({
        ...tile,
        currentPosition: currentPositionsRef.current[idx] || tile.position,
      }))
      onDebugDataUpdate(updatedTileData)
    }
  }, [effectiveTileData, onDebugDataUpdate])

  return (
    <group>
      {effectiveTileData.map((tile, idx) => (
        <AnimatingTile
          key={tile.key}
          position={tile.position}
          url={tile.image}
          delay={tile.delay}
          isPersonal={tile.isPersonal}
          personalAnimationStartTime={effectivePersonalStart}
          targetScale={tile.scale}
          onCompleted={handleTileCompleted}
          onClick={() => {
            if (canEnterDetail && setDetailMode) {
              if (setActiveIndex) {
                setActiveIndex(idx)
                DEBUG_GALLERY &&
                  console.debug("[GalleryContent] enter detail idx", idx)
              }
              if (!detailStackScale && setDetailStackScale) {
                setDetailStackScale(tile.scale)
              }
              setDetailMode(true)
            }
          }}
          detailMode={detailMode}
          canEnterDetail={canEnterDetail}
          detailStackScale={detailStackScale || computedDefaultDetailScale}
          isActive={detailMode && idx === activeIndex}
          stackIndex={idx}
          stackSize={effectiveTileData.length}
          activeIndex={activeIndex}
          switchInfo={switchInfo}
          onPositionUpdate={DEBUG_GALLERY ? handlePositionUpdate : undefined}
        />
      ))}
    </group>
  )
}
</file>

<file path="src/components/Gallery/components/StackBump.jsx">
import { useFrame } from "@react-three/fiber"
import { useRef } from "react"

import {
  DEBUG_GALLERY,
  STACK_BUMP_AMPLITUDE,
  STACK_SWITCH_DUR,
} from "../config"

export default function StackBump({
  switchDir,
  switchStartRef,
  children,
  onEnd,
}) {
  const groupRef = useRef()
  const endCalledForStartRef = useRef(0)

  useFrame(() => {
    const g = groupRef.current
    if (!g) return
    if (!switchDir || !switchStartRef.current) {
      g.position.y = g.position.y + (0 - g.position.y) * 0.3
      return
    }
    const now = performance.now()
    const elapsed = (now - switchStartRef.current) / 1000
    const progress = Math.min(1, Math.max(0, elapsed / STACK_SWITCH_DUR))
    const bump = Math.sin(Math.PI * progress) * STACK_BUMP_AMPLITUDE
    g.position.y = g.position.y + (bump - g.position.y) * 0.3
    if (
      DEBUG_GALLERY &&
      (progress === 0 || progress === 1 || Math.abs(progress - 0.5) < 0.02)
    ) {
      console.debug(
        "[StackBump] progress",
        progress.toFixed(2),
        "bump",
        bump.toFixed(3),
      )
    }
    if (progress >= 1 && onEnd) {
      if (endCalledForStartRef.current !== switchStartRef.current) {
        endCalledForStartRef.current = switchStartRef.current
        onEnd()
      }
    }
  })
  return <group ref={groupRef}>{children}</group>
}
</file>

<file path="src/components/Gallery/hooks/useImagePreloader.js">
// Moved from src/hooks/useImagePreloader.js
import { useEffect, useRef, useState } from "react"

const useImagePreloader = (imageUrls = [], shouldPreload = true) => {
  const preloadedImages = useRef(new Set())
  const imageElements = useRef(new Map())
  const [preloadedCount, setPreloadedCount] = useState(0)

  useEffect(() => {
    if (!shouldPreload || !imageUrls.length) return

    const imagesMap = imageElements.current
    const preloadedSet = preloadedImages.current

    const preloadImages = () => {
      imageUrls.forEach((url) => {
        if (preloadedSet.has(url)) return

        const img = new Image()

        img.onload = () => {
          preloadedSet.add(url)
          setPreloadedCount(preloadedSet.size)
        }

        imagesMap.set(url, img)
        img.src = url
      })
    }

    const timeoutId = setTimeout(preloadImages, 100)
    return () => {
      clearTimeout(timeoutId)
      imagesMap.clear()
    }
  }, [imageUrls, shouldPreload])

  useEffect(() => {
    const imagesMap = imageElements.current
    const preloadedSet = preloadedImages.current
    return () => {
      imagesMap.clear()
      preloadedSet.clear()
      setPreloadedCount(0)
    }
  }, [])

  return {
    isPreloaded: (url) => preloadedImages.current.has(url),
    preloadedCount,
    totalCount: imageUrls.length,
    isAllPreloaded: imageUrls.length > 0 && preloadedCount === imageUrls.length,
  }
}

export default useImagePreloader
</file>

<file path="src/components/Gallery/hooks/useResponsiveTilesPerRow.js">
// Moved from src/hooks/useResponsiveTilesPerRow.js
import { useEffect, useState } from "react"

export default function useResponsiveTilesPerRow() {
  const compute = () => {
    const w = window.innerWidth
    return w <= 1200 ? 5 : 6
  }

  const [tiles, setTiles] = useState(compute())

  useEffect(() => {
    const onResize = () => setTiles(compute())
    window.addEventListener("resize", onResize)
    return () => window.removeEventListener("resize", onResize)
  }, [])

  return tiles
}
</file>

<file path="src/components/Gallery/animationUtils.js">
import { easing } from "maath"

import ANIMATION_CONFIG from "./config"

export const clamp01 = (v) => Math.max(0, Math.min(1, v))
export const easeOut = easing.cubic.out

export const applyTransform = (node, { scale, opacity, z }) => {
  if (scale != null) node.scale.set(scale, scale, 1)
  if (opacity != null && node.material) node.material.opacity = opacity
  if (z != null) node.position.z = z
}

export const setGrayscale = (mat, value) => {
  if (mat && mat.grayscale !== undefined) mat.grayscale = value
}

export const animatePersonal = ({
  img,
  mat,
  elapsedTime,
  adjustedStart,
  targetScale,
  targetZ,
  flags,
}) => {
  const { startScale, startOpacity, endOpacity, startZ, duration } =
    ANIMATION_CONFIG.personal

  if (elapsedTime < adjustedStart) {
    applyTransform(img, { scale: startScale, opacity: 0, z: startZ })
    return
  }

  const t = clamp01((elapsedTime - adjustedStart) / duration)
  const k = easeOut(t)

  const scale = startScale + (targetScale - startScale) * k
  const opacity = startOpacity + (endOpacity - startOpacity) * k
  const z = startZ + (targetZ - startZ) * k

  applyTransform(img, { scale, opacity, z })
  setGrayscale(mat, 0)

  if (t >= 1) flags.initialDone.current = true
}

export const animateNormal = ({
  img,
  mat,
  elapsedTime,
  delay,
  targetScale,
  targetZ,
  grayscaleStart,
  flags,
}) => {
  const { startScale, startOpacity, endOpacity, startZ, duration } =
    ANIMATION_CONFIG.normal
  const {
    start: gsStart,
    end: gsEnd,
    duration: gsDur,
  } = ANIMATION_CONFIG.grayscale

  if (elapsedTime < delay) return

  const t = clamp01((elapsedTime - delay) / duration)
  const k = easeOut(t)

  const scale = startScale + (targetScale - startScale) * k
  const opacity = startOpacity + (endOpacity - startOpacity) * k
  const z = startZ + (targetZ - startZ) * k

  applyTransform(img, { scale, opacity, z })

  if (elapsedTime >= grayscaleStart) {
    const g = clamp01((elapsedTime - grayscaleStart) / gsDur)
    const kg = easeOut(g)
    const gs = gsStart + (gsEnd - gsStart) * kg
    setGrayscale(mat, gs)
    if (g >= 1) flags.grayscaleDone.current = true
  } else {
    setGrayscale(mat, gsStart)
  }

  if (t >= 1) flags.initialDone.current = true
}
</file>

<file path="src/components/Gallery/UploadedImagesGallery.jsx">
import { useGalleryImages } from "@/hooks/useGallery"
import { useState } from "react"
import { useTranslation } from "react-i18next"
import { styled } from "styled-components"

const GalleryContainer = styled.div`
  width: 100%;
  padding: 20px;
  background: #1a1a1a;
  color: white;
  min-height: 100vh;
`

const Title = styled.h1`
  font-size: 2rem;
  margin-bottom: 1.5rem;
  text-align: center;
  color: #ffffff;
`

const Subtitle = styled.h2`
  font-size: 1.2rem;
  margin-bottom: 1rem;
  color: #cccccc;
`

const FilterButtons = styled.div`
  display: flex;
  gap: 0.5rem;
  margin-bottom: 1.5rem;
  flex-wrap: wrap;
  justify-content: center;
`

const FilterButton = styled.button`
  padding: 0.5rem 1rem;
  background: ${({ active }) => (active ? "#6c5ce7" : "#333")};
  color: white;
  border: none;
  border-radius: 0.25rem;
  cursor: pointer;
  font-size: 0.9rem;

  &:hover {
    background: ${({ active }) => (active ? "#5b4bd7" : "#444")};
  }
`

const ImagesGrid = styled.div`
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 1rem;
  margin-bottom: 2rem;
`

const ImageCard = styled.div`
  background: #2a2a2a;
  border-radius: 0.5rem;
  overflow: hidden;
  cursor: pointer;
  transition: transform 0.2s;

  &:hover {
    transform: scale(1.02);
  }
`

const ImageWrapper = styled.div`
  width: 100%;
  height: 200px;
  overflow: hidden;
  background: #333;
`

const Image = styled.img`
  width: 100%;
  height: 100%;
  object-fit: cover;
`

const ImageInfo = styled.div`
  padding: 0.75rem;
`

const ImageTitle = styled.h3`
  font-size: 1rem;
  margin: 0 0 0.5rem 0;
  color: #ffffff;
`

const ImageDate = styled.p`
  font-size: 0.8rem;
  color: #888;
  margin: 0;
`

const TaskBadge = styled.span`
  display: inline-block;
  padding: 0.25rem 0.5rem;
  font-size: 0.7rem;
  background: #4a90e2;
  color: white;
  border-radius: 0.25rem;
  margin-top: 0.5rem;
`

const LoadingMessage = styled.div`
  text-align: center;
  font-size: 1.2rem;
  color: #888;
  padding: 2rem;
`

const ErrorMessage = styled.div`
  text-align: center;
  font-size: 1.2rem;
  color: #ff6b6b;
  padding: 2rem;
`

const Modal = styled.div`
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.9);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
`

const ModalImage = styled.img`
  max-width: 90%;
  max-height: 90%;
  object-fit: contain;
`

const CloseButton = styled.button`
  position: absolute;
  top: 1rem;
  right: 1rem;
  background: rgba(255, 255, 255, 0.2);
  color: white;
  border: none;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  cursor: pointer;
  font-size: 1.2rem;

  &:hover {
    background: rgba(255, 255, 255, 0.3);
  }
`

const NoImagesMessage = styled.div`
  text-align: center;
  padding: 3rem;
  color: #888;
  font-size: 1.1rem;
`

export default function UploadedImagesGallery() {
  const { t } = useTranslation()
  const [filter, setFilter] = useState("all")
  const [selectedImage, setSelectedImage] = useState(null)

  // Fetch all gallery images
  const {
    data: allImages,
    isLoading,
    error,
  } = useGalleryImages({ enabled: true })

  const displayImages = allImages?.images || []

  // Filter images by type
  const filteredImages = displayImages.filter((item) => {
    if (filter === "all") return true
    return item.task_type === filter
  })

  // Count images by type
  const taskCounts = {
    all: displayImages.length,
    la_nau: displayImages.filter((item) => item.task_type === "la_nau").length,
    surroundings: displayImages.filter(
      (item) => item.task_type === "surroundings",
    ).length,
    special: displayImages.filter((item) => item.task_type === "special")
      .length,
  }

  const formatDate = (dateString) => {
    return new Date(dateString).toLocaleDateString()
  }

  if (isLoading) {
    return (
      <GalleryContainer>
        <LoadingMessage>
          {t("gallery.loading", "Loading images...")}
        </LoadingMessage>
      </GalleryContainer>
    )
  }

  if (error) {
    return (
      <GalleryContainer>
        <ErrorMessage>
          {t("gallery.error", "Error loading images")}: {error.message}
        </ErrorMessage>
      </GalleryContainer>
    )
  }

  return (
    <GalleryContainer>
      <Title>{t("gallery.uploadedImages", "Uploaded Images")}</Title>

      <FilterButtons>
        <FilterButton
          active={filter === "all"}
          onClick={() => setFilter("all")}
        >
          {t("gallery.all", "All")} ({taskCounts.all})
        </FilterButton>
        <FilterButton
          active={filter === "la_nau"}
          onClick={() => setFilter("la_nau")}
        >
          La Nau ({taskCounts.la_nau})
        </FilterButton>
        <FilterButton
          active={filter === "surroundings"}
          onClick={() => setFilter("surroundings")}
        >
          {t("gallery.surroundings", "Surroundings")} ({taskCounts.surroundings}
          )
        </FilterButton>
        <FilterButton
          active={filter === "special"}
          onClick={() => setFilter("special")}
        >
          {t("gallery.special", "Special")} ({taskCounts.special})
        </FilterButton>
      </FilterButtons>

      {filteredImages.length === 0 ? (
        <NoImagesMessage>
          {filter === "all"
            ? t("gallery.noImages", "No images uploaded yet")
            : t("gallery.noImagesForFilter", `No ${filter} images found`)}
        </NoImagesMessage>
      ) : (
        <>
          <Subtitle>
            {filter === "all" && t("gallery.allImages", "All Images")}
            {filter === "la_nau" && "La Nau"}
            {filter === "surroundings" &&
              t("gallery.surroundings", "Surroundings")}
            {filter === "special" && t("gallery.special", "Special")} (
            {filteredImages.length})
          </Subtitle>

          <ImagesGrid>
            {filteredImages.map((item) => (
              <ImageCard
                key={item.image.id}
                onClick={() => setSelectedImage(item.image)}
              >
                <ImageWrapper>
                  <Image
                    src={item.image.image}
                    alt={item.image.title}
                    loading="lazy"
                  />
                </ImageWrapper>
                <ImageInfo>
                  <ImageTitle>{item.image.title}</ImageTitle>
                  <ImageDate>{formatDate(item.image.created_at)}</ImageDate>
                  <TaskBadge taskType={item.task_type}>
                    {item.task_display}
                  </TaskBadge>
                </ImageInfo>
              </ImageCard>
            ))}
          </ImagesGrid>
        </>
      )}

      {selectedImage && (
        <Modal onClick={() => setSelectedImage(null)}>
          <CloseButton onClick={() => setSelectedImage(null)}>×</CloseButton>
          <ModalImage
            src={selectedImage.image}
            alt={selectedImage.title}
            onClick={(e) => e.stopPropagation()}
          />
        </Modal>
      )}
    </GalleryContainer>
  )
}
</file>

<file path="src/components/Gallery/utils.js">
export const computeGridMetrics = ({
  viewportWidth,
  viewportHeight,
  tilesPerRow,
}) => {
  const idealTileWidth = viewportWidth / tilesPerRow
  const tilesPerColumn = Math.floor(viewportHeight / idealTileWidth)
  const gridWidth = tilesPerRow * idealTileWidth
  const gridHeight = tilesPerColumn * idealTileWidth
  const zeroX = -gridWidth / 2 + idealTileWidth / 2
  const zeroY = gridHeight / 2 - idealTileWidth / 2

  return {
    idealTileWidth,
    tilesPerColumn,
    gridWidth,
    gridHeight,
    zeroX,
    zeroY,
  }
}

const chebyshev = (r1, c1, r2, c2) =>
  Math.max(Math.abs(r1 - r2), Math.abs(c1 - c2))

const mulberry32 = (seed) => {
  let t = seed >>> 0
  return () => {
    t += 0x6d2b79f5
    let r = Math.imul(t ^ (t >>> 15), 1 | t)
    r ^= r + Math.imul(r ^ (r >>> 7), 61 | r)
    return ((r ^ (r >>> 14)) >>> 0) / 4294967296
  }
}

const seededShuffle = (arr, seed) => {
  const rand = mulberry32(seed)
  const a = [...arr]
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(rand() * (i + 1))
    ;[a[i], a[j]] = [a[j], a[i]]
  }
  return a
}

export const selectCentralIndices = ({
  totalTiles,
  tilesPerRow,
  tilesPerColumn,
  count,
  seed = 12345,
}) => {
  const primaryMinRow = Math.max(1, Math.floor(tilesPerColumn * 0.25))
  const primaryMaxRow = Math.min(
    tilesPerColumn - 2,
    Math.floor(tilesPerColumn * 0.75),
  )
  const primaryMinCol = Math.max(1, Math.floor(tilesPerRow * 0.25))
  const primaryMaxCol = Math.min(
    tilesPerRow - 2,
    Math.floor(tilesPerRow * 0.75),
  )

  const collect = (minRow, maxRow, minCol, maxCol) => {
    const acc = []
    for (let row = minRow; row <= maxRow; row++) {
      for (let col = minCol; col <= maxCol; col++) {
        const index = row * tilesPerRow + col
        if (index < totalTiles) acc.push(index)
      }
    }
    return acc
  }

  const primary = collect(
    primaryMinRow,
    primaryMaxRow,
    primaryMinCol,
    primaryMaxCol,
  )

  let pool = [...primary]
  if (pool.length < count) {
    const fbMinRow = Math.max(0, Math.floor(tilesPerColumn * 0.2))
    const fbMaxRow = Math.min(
      tilesPerColumn - 1,
      Math.floor(tilesPerColumn * 0.8),
    )
    const fbMinCol = Math.max(0, Math.floor(tilesPerRow * 0.2))
    const fbMaxCol = Math.min(tilesPerRow - 1, Math.floor(tilesPerRow * 0.8))
    const fallback = collect(fbMinRow, fbMaxRow, fbMinCol, fbMaxCol)
    pool = [...new Set([...primary, ...fallback])]
  }

  const shuffled = seededShuffle(pool, seed)
  const selected = []
  const noTouchDistance = 2

  const respectsNoTouch = (candidate) => {
    const r = Math.floor(candidate / tilesPerRow)
    const c = candidate % tilesPerRow
    return selected.every((sel) => {
      const sr = Math.floor(sel / tilesPerRow)
      const sc = sel % tilesPerRow
      return chebyshev(r, c, sr, sc) >= noTouchDistance
    })
  }

  for (const candidate of shuffled) {
    if (selected.length >= count) break
    if (selected.length === 0 || respectsNoTouch(candidate)) {
      selected.push(candidate)
    }
  }

  if (selected.length >= count) return selected

  const remaining = count - selected.length
  const remainingPool = shuffled.filter((i) => !selected.includes(i))

  for (let i = 0; i < remaining && remainingPool.length; i++) {
    let bestIdx = 0
    let bestScore = -Infinity
    for (let j = 0; j < remainingPool.length; j++) {
      const cand = remainingPool[j]
      const r = Math.floor(cand / tilesPerRow)
      const c = cand % tilesPerRow
      const score = selected.reduce((acc, sel) => {
        const sr = Math.floor(sel / tilesPerRow)
        const sc = sel % tilesPerRow
        return acc + chebyshev(r, c, sr, sc)
      }, 0)
      if (score > bestScore) {
        bestScore = score
        bestIdx = j
      }
    }
    selected.push(remainingPool[bestIdx])
    remainingPool.splice(bestIdx, 1)
  }

  return selected
}

export const buildDelays = (count, maxDelay, seed = 98765) => {
  const rand = mulberry32(seed)
  return Array.from({ length: count }, () => rand() * maxDelay)
}

export const buildTileData = ({
  images,
  tilesPerRow,
  idealTileWidth,
  zeroX,
  zeroY,
  displacementRatio,
  delays,
  maxDelay,
  personalImages,
  baseImageScale,
  personalScaleMultiplier,
  seed = 424242,
}) => {
  const rand = mulberry32(seed)
  return images.map((image, index) => {
    const row = Math.floor(index / tilesPerRow)
    const column = index % tilesPerRow
    const x = zeroX + column * idealTileWidth
    const y = zeroY - row * idealTileWidth

    const displacementRange = idealTileWidth * displacementRatio
    const jx = (rand() - 0.5) * 2
    const jy = (rand() - 0.5) * 2
    const randomX = jx * displacementRange
    const randomY = jy * displacementRange

    const personalIdx = personalImages.indices.indexOf(index)
    const isPersonal = personalIdx !== -1

    const normalizedDelay = delays[index] / maxDelay
    const zOffset = isPersonal ? normalizedDelay * 0.2 : normalizedDelay * -0.2

    const position = [x + randomX, y + randomY, zOffset]

    return {
      key: isPersonal
        ? `personal-${personalIdx}-${index}`
        : `${image}-${index}`,
      position,
      image: isPersonal ? personalImages.urls[personalIdx] : image,
      isPersonal,
      delay: delays[index],
      scale: isPersonal
        ? idealTileWidth * personalScaleMultiplier
        : idealTileWidth * baseImageScale,
    }
  })
}
</file>

<file path="src/components/Perspective/index.js">
export { default, loader } from "./Perspective"
</file>

<file path="src/components/PhotoCapture/PhotoCaptureMetadata.jsx">
import { useState } from "react"
import { useTranslation } from "react-i18next"

import SmallButton from "@ui/SmallButton"

import {
  MetadataActions,
  MetadataContainer,
  MetadataInput,
  MetadataLabel,
  MetadataSection,
  MetadataTextarea,
} from "./styles"

export default function PhotoCaptureMetadata({
  onSave,
  onSkip,
  taskIndex,
  taskTitle,
}) {
  const { t } = useTranslation()
  const [comment, setComment] = useState("")
  const [username, setUsername] = useState("")

  const handleSave = () => {
    onSave({
      text: comment.trim(),
      userName: username.trim(),
      taskIndex,
    })
  }

  const handleSkip = () => {
    onSkip(taskIndex)
  }

  return (
    <MetadataContainer>
      <MetadataSection>
        <h3>
          {t("photoCapture.metadata.title", {
            defaultValue: "Add details for your photo",
          })}
        </h3>
        {taskTitle && <p>{taskTitle}</p>}
      </MetadataSection>

      <MetadataSection>
        <MetadataLabel htmlFor={`comment-${taskIndex}`}>
          {t("photoCapture.metadata.comment", {
            defaultValue: "Comment (optional)",
          })}
        </MetadataLabel>
        <MetadataTextarea
          id={`comment-${taskIndex}`}
          value={comment}
          onChange={(e) => setComment(e.target.value)}
          placeholder={t("photoCapture.metadata.commentPlaceholder", {
            defaultValue: "Share your thoughts about this photo...",
          })}
          maxLength={255}
          rows={3}
        />
      </MetadataSection>

      <MetadataSection>
        <MetadataLabel htmlFor={`username-${taskIndex}`}>
          {t("photoCapture.metadata.username", {
            defaultValue: "Your name (optional)",
          })}
        </MetadataLabel>
        <MetadataInput
          id={`username-${taskIndex}`}
          type="text"
          value={username}
          onChange={(e) => setUsername(e.target.value)}
          placeholder={t("photoCapture.metadata.usernamePlaceholder", {
            defaultValue: "Enter your name",
          })}
          maxLength={150}
        />
      </MetadataSection>

      <MetadataActions>
        <SmallButton onClick={handleSkip}>
          {t("photoCapture.metadata.skip", { defaultValue: "Skip" })}
        </SmallButton>
        <SmallButton onClick={handleSave}>
          {t("photoCapture.metadata.save", { defaultValue: "Save" })}
        </SmallButton>
      </MetadataActions>
    </MetadataContainer>
  )
}
</file>

<file path="src/components/UI/LanguageSelector/index.js">
export { default } from "./LanguageSelector"
</file>

<file path="src/components/UI/LoadingSpinner/index.js">
export { default } from "./LoadingSpinner"
</file>

<file path="src/components/UI/LoadingSpinner/LoadingSpinner.jsx">
import { keyframes, styled } from "styled-components"

const spin = keyframes`
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
`

const pulse = keyframes`
  0%, 100% { opacity: 1; }
  50% { opacity: 0.3; }
`

const SpinnerContainer = styled.div`
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
`

const Spinner = styled.div`
  width: ${(props) => props.$size || "24px"};
  height: ${(props) => props.$size || "24px"};
  border: 2px solid rgba(255, 255, 255, 0.2);
  border-top: 2px solid #fff;
  border-radius: 50%;
  animation: ${spin} 1s linear infinite;
`

const LoadingText = styled.span`
  color: #fff;
  font-family: "Bricolage Grotesque";
  font-size: 0.875rem;
  font-weight: 500;
  animation: ${pulse} 1.5s ease-in-out infinite;
`

const LoadingSpinner = ({
  size = "24px",
  text = "Loading...",
  showText = true,
  className = "",
}) => {
  return (
    <SpinnerContainer className={className}>
      <Spinner $size={size} />
      {showText && <LoadingText>{text}</LoadingText>}
    </SpinnerContainer>
  )
}

export default LoadingSpinner
</file>

<file path="src/components/UI/Headline.jsx">
import { motion } from "motion/react"
import { styled } from "styled-components"

const Headline = styled(motion.div)`
  color: ${({ theme }) => theme.colors.background.paper};
  text-align: center;
  font-size: 2.625rem;
  font-style: normal;
  font-weight: 700;
  line-height: normal;
  position: relative;
  z-index: 3;
  width: 100%;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  justify-content: center;
  align-items: center;
`

export default Headline
</file>

<file path="src/components/UI/LegalNotice.jsx">
import { styled } from "styled-components"

const LegalNoticeContainer = styled.div`
  display: flex;
  flex-direction: row;
  justify-content: center;
  flex-shrink: 0;

  text-align: center;
  font-size: 0.75rem;
  font-style: normal;
  font-weight: 400;
  line-height: normal;
`

const LinkSpan = styled.span`
  text-decoration: underline;
`

export default function LegalNotice({ setShowScreen }) {
  return (
    <LegalNoticeContainer>
      <LinkSpan onClick={() => setShowScreen("imprint")}>Legal Notice</LinkSpan>
      &nbsp;&amp;&nbsp;
      <LinkSpan onClick={() => setShowScreen("privacy")}>
        Privacy Policy
      </LinkSpan>
    </LegalNoticeContainer>
  )
}
</file>

<file path="src/components/UI/MainLayout.jsx">
import { styled } from "styled-components"

import Description from "@ui/Description"
import Header from "@ui/Header"
import Navigation from "@ui/Navigation"
import Vignette from "@ui/Vignette"

const Layout = styled.div`
  display: flex;
  width: 100dvw;
  height: 100dvh;
  flex-direction: column;
  align-items: flex-start;
  gap: 0.625rem;
  background-color: ${({ theme }) => theme.colors.background.dark};
  background-image: ${({ $backgroundImage }) => `url(${$backgroundImage})`};
  background-size: cover;
  background-position: center;
  position: absolute;
  top: 0;
  left: 0;
`

const TextLayout = styled.div`
  display: flex;
  width: 24.5625rem;
  margin: 0 auto;
  flex-direction: column;
  justify-content: ${({ $hasDescription }) =>
    $hasDescription ? "space-between" : "flex-start"};
  align-items: flex-start;
  gap: 0;
  flex: 1 0 0;
`

const ChildrenContainer = styled.div`
  position: fixed;
  top: 0;
  left: 0;
  width: 100dvw;
  height: 100dvh;
  z-index: 1;
`

export default function MainLayout({
  headline,
  subheadline,
  descriptionTitle,
  descriptionText,
  onPrev,
  onNext,
  onSelect,
  backgroundImage,
  children,
  vignetteIntensity,
  navigationMode,
  singleButtonVariant,
  navigationPosition,
  isFirstPage,
  screenIndex,
  setShowScreen,
}) {
  if (children && !headline && !descriptionTitle && !navigationMode) {
    return <Layout>{children}</Layout>
  }

  return (
    <Layout $backgroundImage={backgroundImage}>
      {children && <ChildrenContainer>{children}</ChildrenContainer>}
      <Vignette
        intensity={vignetteIntensity || 25}
        isCharacterScreen={screenIndex === 1}
        screenIndex={screenIndex || 0}
      />
      {(headline || descriptionTitle) && (
        <TextLayout $hasDescription={!!descriptionTitle}>
          {headline && (
            <Header
              headline={headline}
              subheadline={subheadline}
              legalNotice={isFirstPage}
              setShowScreen={setShowScreen}
            />
          )}
          {descriptionTitle && (
            <Description
              title={descriptionTitle}
              text={descriptionText}
              headline={headline}
              subheadline={subheadline}
            />
          )}
        </TextLayout>
      )}
      <Navigation
        mode={navigationMode || "dual"}
        onPrev={onPrev}
        onNext={onNext}
        onSelect={onSelect}
        singleButtonVariant={singleButtonVariant || "arrowDown"}
        position={navigationPosition || "default"}
      />
    </Layout>
  )
}
</file>

<file path="src/components/UI/SmallButton.jsx">
import { styled } from "styled-components"

const StyledSmallButton = styled.button`
  width: 7.8125rem;
  height: 2.4375rem;
  border-radius: 2.75rem;
  border: 1px solid black; /* Can be overridden by parent wrapper */
  background: transparent;
  display: flex;
  justify-content: center;
  align-items: center;
  color: black;
  text-align: center;
  font-size: 1rem;
  font-style: normal;
  font-weight: 700;
  line-height: normal;

  &:active {
    transform: scale(0.98);
  }

  &:disabled {
    opacity: 0.5;
  }
`

export default function SmallButton({ children, ...props }) {
  return <StyledSmallButton {...props}>{children}</StyledSmallButton>
}
</file>

<file path="src/components/Upload/index.js">
export { default, loader } from "./Upload"
</file>

<file path="src/components/Welcome/CharacterShowcase/utils/transformUtils.js">
export const CAROUSEL_ANIMATION = {
  type: "spring",
  stiffness: 300,
  damping: 30,
  duration: 0.5,
}

export const DRAG_CONFIG = {
  elastic: 0.2,
  momentum: false,
}
</file>

<file path="src/components/Welcome/CharacterShowcase/constants.js">
import Amara from "./assets/amara.png"
import AmaraSelected from "./assets/amaraSelected.png"
import Mateo from "./assets/mateo.png"
import MateoSelected from "./assets/mateoSelected.png"
import Nova from "./assets/nova.png"
import NovaSelected from "./assets/novaSelected.png"

export const CHARACTER_DATA = [
  {
    id: 1,
    image: Amara,
    selectedImage: AmaraSelected,
    name: "Amara",
    title: "The Artist",
    description:
      "Join Amara and transform your visit into a living work of art.",
  },
  {
    id: 2,
    image: Mateo,
    selectedImage: MateoSelected,
    name: "Mateo",
    title: "The Janitor",
    description:
      "Follow Mateo through the legendary halls where football history was made.",
  },
  {
    id: 3,
    image: Nova,
    selectedImage: NovaSelected,
    name: "Nova",
    title: "The Visitor from the Future.",
    description:
      "Discover with Nova the hidden stories and secrets of Camp Nou.",
  },
]

export const DRAG_THRESHOLD = 100
</file>

<file path="src/components/Welcome/CharacterShowcase/index.js">
export { default } from "./CharacterShowcase"
</file>

<file path="src/components/Welcome/CharacterShowcase/styles.js">
import { motion as m } from "motion/react"
import { styled } from "styled-components"

export const Container = styled(m.div)`
  position: relative;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100dvh;
  width: 100%;
  overflow: hidden;
  perspective: 93.75rem;
`

export const MainLayoutContainer = styled.div`
  position: relative;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100dvh;
  width: 100dvw;
  overflow: hidden;
  perspective: 93.75rem;
  padding-bottom: 6rem;
`

export const CharactersContainer = styled.div`
  display: flex;
  align-items: center;
  justify-content: center;
  width: 100%;
  position: relative;
  height: 80dvh;
  touch-action: none;
`

export const CharacterBox = styled(m.div)`
  width: 70dvw;
  height: 60dvh;
  border-radius: 1rem;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 1.5rem;
  font-weight: bold;
  position: absolute;
  overflow: hidden;

  &.selected {
    z-index: 3;
  }

  &.left {
    transform-origin: center right;
  }

  &.right {
    transform-origin: center left;
  }
`

export const CharacterImage = styled(m.img)`
  width: auto;
  height: 80%;
  object-fit: contain;
  object-position: center;
  transition: filter 0.3s ease;
  position: relative;
  z-index: 2;
`

export const NavigationButton = styled(m.button)`
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  background-color: white;
  border: none;
  border-radius: 50%;
  width: 4.375rem;
  height: 4.375rem;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.75rem;
  filter: drop-shadow(0 0.25rem 0.9375rem rgba(0, 0, 0, 0.2));
  z-index: 10;
  color: #333;
  transition: all 0.2s ease;

  &:disabled {
    opacity: 0.3;
  }

  &.left {
    left: 1.875rem;
  }

  &.right {
    right: 1.875rem;
  }
`

export const Particles = styled.div`
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  overflow: hidden;
  pointer-events: none;
`

export const IntroContainer = styled(m.div)`
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-end;
  padding-bottom: 5rem;
  width: 100%;
  height: 100dvh;
`

export const IntroCharactersRow = styled(m.div)`
  display: flex;
  align-items: end;
  justify-content: center;
  width: 100%;
  gap: 1.25rem;
`

export const IntroCharacterItem = styled(m.div)`
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-end;
  width: 25dvw;
  height: 50dvh;
  position: relative;
`

export const IntroCharacterImage = styled(m.img)`
  width: 15.1875rem;
  height: 27rem;
  aspect-ratio: 9/16;
  object-fit: contain;
`

export const CharacterButtonLayout = styled.div`
  position: absolute;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  align-items: center;
  z-index: 1000;
`
</file>

<file path="src/components/Welcome/constants.js">
export const STEP = Object.freeze({
  INTRO: 0,
  CHARACTER: 1,
})
</file>

<file path="src/components/Welcome/index.js">
export { default, loader } from "./Welcome"
</file>

<file path="src/config/language.js">
export const LANGUAGE_CONFIG = {
  STORAGE_KEY: "cheminova-language",
  CACHE_TIME: 60 * 60 * 1000,
  STALE_TIME: 5 * 60 * 1000,
  ALL_LOCALES_STALE_TIME: 30 * 60 * 1000,
  RETRY_ATTEMPTS: 2,
  RETRY_DELAY: 1000,
}

export const DETECTION_CONFIG = {
  ORDER: ["localStorage", "navigator", "htmlTag"],
  CACHES: ["localStorage"],
  LOOKUP_LOCAL_STORAGE: "cheminova-language",
}

export const BACKEND_CONFIG = {
  LOAD_PATH: "/locales/{{lng}}/translation.json",
}

export const REACT_I18N_CONFIG = {
  USE_SUSPENSE: true,
}

export const INTERPOLATION_CONFIG = {
  ESCAPE_VALUE: false,
}

export const NAMESPACE_CONFIG = {
  DEFAULT_NS: "translation",
  NS: ["translation"],
}

export const LANGUAGE_LIST = {
  en: "English",
  de: "German",
  es: "Spanish",
  fr: "French",
}

export const DEFAULT_LANGUAGE = "en"

export const getLanguageCodes = () => Object.keys(LANGUAGE_LIST)

export const findLanguageByCode = (code) => LANGUAGE_LIST[code]
</file>

<file path="src/hooks/useDevicePlatform.js">
import { useEffect, useState } from "react"

export default function useDevicePlatform() {
  const [platform, setPlatform] = useState({
    os: "unknown",
    isIOS: false,
    isAndroid: false,
  })

  useEffect(() => {
    const userAgent = navigator.userAgent

    const isIOS =
      /iPhone|iPod/.test(userAgent) ||
      (/iPad/.test(userAgent) && !window.MSStream)
    const isAndroid = /android/i.test(userAgent)

    const os = isIOS
      ? "iOS"
      : isAndroid
        ? "Android"
        : /Windows/.test(userAgent)
          ? "Windows"
          : /Macintosh|Mac OS X/.test(userAgent)
            ? "MacOS"
            : /Linux/.test(userAgent)
              ? "Linux"
              : "unknown"

    setPlatform({ os, isIOS, isAndroid })
  }, [])

  return platform
}
</file>

<file path="src/hooks/useEndingContent.js">
import {
  handleApiError,
  navigateToScreen,
  transformScreenData,
} from "@/utils/apiUtils"

import { useLocalizedQuery } from "./useLocalizedQuery"

const useEndingContent = () => {
  return useLocalizedQuery({
    queryKey: ["ending-content"],
    queryFn: (localeContent) => {
      try {
        const endingScreen = navigateToScreen(localeContent, "EndingScreen")

        return transformScreenData(
          endingScreen,
          "Thank You",
          "Thank you for contributing to this monument and keeping it alive. Now take a further look around La Nau.",
        )
      } catch (error) {
        const errorDetails = handleApiError(error, "Ending content loading")
        throw new Error(errorDetails.message)
      }
    },
    enabled: true,
    staleTime: 10 * 60 * 1000,
    gcTime: 30 * 60 * 1000,
    retry: 2,
    retryDelay: (attemptIndex) => Math.min(1000 * 2 ** attemptIndex, 30000),
  })
}

export default useEndingContent
</file>

<file path="src/hooks/useGlobalState.js">
import { StateContext } from "@/GlobalState"
import { useContext } from "react"

export default function useGlobalState() {
  return useContext(StateContext)
}
</file>

<file path="src/hooks/usePerspectiveContent.js">
import {
  handleApiError,
  navigateToScreen,
  transformScreenData,
} from "@/utils/apiUtils"

import { useLocalizedQuery } from "./useLocalizedQuery"

const usePerspectiveContent = () => {
  return useLocalizedQuery({
    queryKey: ["perspective-content"],
    queryFn: (localeContent) => {
      try {
        const perspectiveScreen = navigateToScreen(
          localeContent,
          "PerspectiveScreen",
        )

        return transformScreenData(
          perspectiveScreen,
          "Your Perspective", // fallback title
          "You've seen the monument through new eyes. Now, add your vision to a living collage, together with others who care, just like you.", // fallback description
        )
      } catch (error) {
        const errorDetails = handleApiError(
          error,
          "Perspective content loading",
        )
        throw new Error(errorDetails.message)
      }
    },
    enabled: true,
    staleTime: 10 * 60 * 1000, // 10 minutes
    gcTime: 30 * 60 * 1000, // 30 minutes
    retry: 2,
    retryDelay: (attemptIndex) => Math.min(1000 * 2 ** attemptIndex, 30000),
  })
}

export default usePerspectiveContent
</file>

<file path="src/hooks/usePhotoTasks.js">
// (Moved) usePhotoTasks now lives in components/PhotoCapture/hooks/usePhotoTasks.js
export { default } from "@components/PhotoCapture/hooks/usePhotoTasks"
</file>

<file path="src/GlobalStyles.jsx">
import { createGlobalStyle } from "styled-components"

const GlobalStyles = createGlobalStyle`
  /* Global reset & interaction tuning */
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
    touch-action: manipulation;
    user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -webkit-touch-callout: none;
    -webkit-tap-highlight-color: transparent;
  }

  /* CSS custom properties for safe areas & z-index scale */
  :root {
    --safe-inset-top: env(safe-area-inset-top, 0px);
    --safe-inset-bottom: env(safe-area-inset-bottom, 0px);
    --z-base: 0;
    --z-overlay: 10;
    --z-modal: 100;
  }

  html,
  body {
    background-color: ${(props) => props.theme.colors.background.dark};
    width: 100%;
    height: 100%;
    min-height: 100dvh; /* Support dynamic viewport on mobile browsers */
    overflow: hidden; /* Kiosk-style: lock scroll intentionally */
    color: ${(props) => props.theme.colors.text.primary};
    font-family: "Bricolage Grotesque", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    font-optical-sizing: auto;
    font-style: normal;
    font-variation-settings: "wdth" 100;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }

  #root {
    width: 100%;
    height: 100%;
    overflow: hidden;
    display: grid;
    place-items: center;
  }

  input, textarea, select { font-family: inherit; }
`

export default GlobalStyles
</file>

<file path=".env.local.example">
# Copy this file to .env and adjust for your setup

# For production with CMS under /cms/api
VITE_API_BASE_URL=/cms/api

# For local development (uncomment if needed)
# VITE_API_BASE_URL=http://localhost:8000
</file>

<file path=".github/copilot-instructions.md">
# Copilot Coding Agent Onboarding Guide

## 1. Repository Summary

- **Purpose**: Interactive photo gallery web app for cultural heritage site (La Nau). Users take photos, select guide characters, explore content through linear screen flow ending with 3D gallery.
- **Stack**: React 19, Vite 7, styled-components, motion (Framer Motion), React Three Fiber (R3F), TanStack Query, i18next
- **Size**: ~50 components, multi-screen flow (Welcome → PhotoCapture → Exploration → Gallery), CMS-driven content
- **Runtime**: Browser (ESM). Development uses Django CMS backend API at `localhost:8080`, production at `/cms/api`
- **Entry Points**: `index.html` → `src/main.jsx` → `src/components/App/App.jsx` (state-based screen router)

## 2. Core Domains & Architecture

| Domain                      | Location                                                             | Notes                                                                                                                                                                  |
| --------------------------- | -------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Screen Flow Router**      | `src/components/App/App.jsx`                                         | State-based routing: `welcome` → `introduction` → `photoCapture` → `exploration` → `perspective` → `upload` → `gallery` → `ending`. No React Router.                   |
| **CMS Data Layer**          | `src/api/djangoApi.js`, `src/api/hooks.js`                           | Fetches tree structure from `/cms/api/all/` endpoint. Uses TanStack Query + custom `useLocalizedQuery` hook.                                                           |
| **Content Tree Navigation** | `src/api/hooks.js` (`extractFromContentTree`)                        | Functions traverse hierarchical CMS data: `getWelcome()` → `getCharacterOverview()` → `getCharacter(index)` → `getIntroduction(index)` → `getPhotography(index)`, etc. |
| **Localization**            | `src/i18n/`, `src/providers/LanguageProvider.jsx`, `public/locales/` | i18next with browser detection + localStorage. Supports EN, DE, ES, FR. CMS content is locale-specific; UI labels use translation files.                               |
| **Global State**            | `src/GlobalState.jsx` (Context API)                                  | Manages character selection, screen navigation history, modal state (privacy/imprint). Use `useGlobalState()` hook.                                                    |
| **3D Gallery**              | `src/components/Gallery/`                                            | React Three Fiber canvas with custom image grid, camera controller, stack bump animation. Uses `@react-three/fiber` + `@react-three/drei`.                             |
| **Styled Components**       | `src/theme/`, inline styled components                               | Theme provider with centralized colors, spacing. Components define styled elements inline (e.g., `styled.div`).                                                        |

**Key Architectural Pattern**: CMS returns nested JSON tree; extractors in `src/api/hooks.js` navigate by character index + screen depth. Example: `useExplorationFromAll(characterIndex)` traverses: Welcome → CharacterOverview → Character[index] → Introduction → Photography → **Exploration**.

## 3. Build & Run Instructions

**Always perform these in order after cloning or pulling changes:**

1. **Install dependencies** (mandatory before anything else):

```bash
npm install
```

2. **Development server** (hot reload):

```bash
npm run dev          # Opens localhost:5173
npm run dev:host     # Exposes to network
```

3. **Type check + build production bundle**:

```bash
npm run build        # Outputs to dist/
```

4. **Preview production build locally**:

```bash
npm run preview
```

5. **Lint** (do this before committing):

```bash
npm run lint
npm run format       # Check formatting
npm run format:write # Fix formatting
```

**Tool Versions**: Node >=18 LTS, React 19, Vite 7. No custom global CLIs required.

## 4. Testing Status

- Currently **no formal test suite** configured (no Jest/Vitest).
- Validation gates: `npm run lint` + `npm run build` + manual testing.
- If adding tests, prefer Vitest (integrates with Vite) and place under `src/__tests__`.

## 5. Validation Checklist Before Submitting Changes

Always ensure:

1. ✅ `npm run lint` passes with no errors
2. ✅ `npm run build` completes without errors
3. ✅ App loads and flows through all screens without console errors
4. ✅ Language switching works (EN/DE/ES/FR) and persists in localStorage
5. ✅ No stray debug `console.log` left (except intentional logs)

## 6. Environment & Configuration

**API Configuration** (`src/config/api.js`):

- Development: `http://localhost:8080` (Django CMS backend)
- Production: `/cms/api` (absolute path works from any subdirectory)
- Override with `.env.local`: `VITE_API_BASE_URL=http://localhost:8000`

**Language Configuration** (`src/config/language.js`):

- Centralized constants: cache times, retry attempts, storage keys
- Languages stored in localStorage key: `cheminova-language`
- Supported: EN (default), DE, ES, FR

**i18next Setup** (`src/i18n/index.js`):

- Auto-detects from: localStorage → navigator → htmlTag
- UI translations: `public/locales/{lng}/translation.json`
- CMS content: locale-specific from Django API

## 7. Critical Development Patterns

### CMS Content Access Pattern

Always use `useLocalizedQuery` for CMS data (not raw `useQuery`). Example:

```javascript
const { data: explorationData } = useExplorationFromAll(characterIndex)
```

### Screen State Navigation

Do NOT add React Router. Use state machine in `App.jsx`:

```javascript
setState("exploration") // Valid states: see App.jsx
```

### Language Detection Flow

1. `LanguageProvider` fetches all locales from `/cms/api/all/`
2. `i18next` detects user language (localStorage → browser → fallback)
3. `useLocalizedQuery` automatically filters CMS tree by current locale
4. Components never call `getContentForLocale` directly

### Styled Components Pattern

Use inline styled definitions with theme access:

```javascript
const Button = styled.button`
  background: ${theme.colors.primary.main};
`
```

### 3D Gallery Architecture

- Canvas setup: `src/components/Gallery/Gallery.jsx`
- Camera control: `CameraController.jsx` (drag-based navigation)
- Image tiles: `AnimatingTile.jsx` (custom bump animation)
- Stack effect: `StackBump.jsx` (entry animation)

## 8. Common Pitfalls & Solutions

| Pitfall                     | Solution                                                                                            |
| --------------------------- | --------------------------------------------------------------------------------------------------- |
| Accessing CMS data directly | Always use `extractFromContentTree` functions or provided hooks                                     |
| Hardcoded UI text           | Check `public/locales/{lng}/translation.json` first; use `useTranslation()`                         |
| Missing character context   | Components like Exploration/Introduction need `characterIndex` from global state                    |
| CMS tree traversal errors   | Structure: Welcome → CharacterOverview → Character → Introduction → Photography → Exploration → ... |
| Language not switching      | Verify localStorage key is `cheminova-language`, not a generic one                                  |
| New screen in flow          | Add to `App.jsx` state machine AND update navigation handlers                                       |
| R3F performance issues      | Avoid state updates in `useFrame`; use refs or imperative Three.js calls                            |

## 9. Directory Layout (Key Files)

Root important files:

```
package.json            # scripts & deps
vite.config.js          # Vite + React plugins, path aliases
eslint.config.js        # ESLint flat config (React 19 + Prettier)
jsconfig.json           # path alias resolution for IDE
API_CONFIGURATION.md    # CMS endpoint setup (dev vs prod)
CMS_IMPLEMENTATION_SUMMARY.md  # Complete CMS field mapping
LANGUAGE_SYSTEM_FLOW.md        # Deep dive into i18n architecture
index.html              # entry point
src/                    # application source
public/locales/         # i18n translation files (en, de, es, fr)
```

`src/` notable structure:

```
main.jsx                # React root with providers (QueryClient, Language, Theme, GlobalState)
GlobalState.jsx         # Context API for character selection & navigation
i18n/index.js           # i18next initialization
api/
  djangoApi.js          # API request wrapper + locale filtering
  hooks.js              # extractFromContentTree + all content hooks
config/
  api.js                # API_BASE_URL resolution (dev/prod)
  language.js           # centralized i18n constants
providers/
  LanguageProvider.jsx  # fetches all locales, provides supported languages
components/
  App/App.jsx           # state-based screen router
  Welcome/              # character selection carousel
  Introduction/         # character intro screen
  PhotoCapture/         # camera interface for user photos
  Exploration/          # CMS-driven content exploration
  Perspective/          # conclusion/transition screen
  Upload/               # user photo upload to CMS
  Gallery/              # React Three Fiber 3D gallery
    components/         # AnimatingTile, CameraController, StackBump, etc.
  UI/                   # reusable UI components
hooks/                  # custom hooks (useGlobalState, useLocalizedQuery, etc.)
theme/                  # styled-components theme provider
```

## 10. Common Pitfalls & Guidance

| Pitfall                         | Guidance                                                                           |
| ------------------------------- | ---------------------------------------------------------------------------------- |
| Forgetting install before build | Always run `npm install` after pulling new lockfile changes.                       |
| Adding React Router             | This app uses state-based routing in `App.jsx` - do NOT add react-router-dom.      |
| Direct CMS data access          | Use `extractFromContentTree` functions; respect the tree hierarchy.                |
| Mixing translation sources      | CMS content uses Django API; UI labels use `public/locales/` files. Keep separate. |
| Wrong hook for CMS data         | Use `useLocalizedQuery` (not raw `useQuery`) for automatic locale filtering.       |
| New global state                | Add to `GlobalState.jsx` context, not component-level state.                       |
| Performance in R3F              | Minimize React state updates in `useFrame` callbacks; use refs.                    |
| Missing character index         | Many components need `currentCharacterIndex` from `useGlobalState()`.              |

## 11. Path Aliases (jsconfig.json)

```javascript
@/           → src/
@components  → src/components
@hooks       → src/hooks
@api         → src/api
@ui          → src/components/UI
@theme       → src/theme
```

## 12. React 19 Features in Use

- **React Compiler** enabled (babel-plugin-react-compiler) - avoid manual memo/useCallback
- **Concurrent features** via Suspense boundaries for i18n and data fetching
- **New JSX runtime** (no React import needed in .jsx files)

## 13. CI / Automation

- **No GitHub Actions** configured yet; treat local lint + build as pre-merge gate.
- **Husky + lint-staged**: runs on pre-commit (check `package.json` prepare script).
- If adding CI, replicate: `npm ci && npm run lint && npm run build`.

## 14. Trust These Instructions

The agent should follow these steps verbatim. Only search the codebase when:

- Adding a feature not covered here, or
- An instruction unexpectedly fails (record the failure & adjust docs).
  Otherwise rely on this guide to minimize exploratory overhead.

---

End of onboarding guide.
</file>

<file path="src/components/ExampleQueries/ExampleQueries.jsx">
export default function ExampleQueries() {
  return null
}
</file>

<file path="src/components/Gallery/components/AnimatingTile.jsx">
import {
  animateNormal,
  animatePersonal,
} from "@components/Gallery/animationUtils"
import ANIMATION_CONFIG, {
  CAMERA_DEFAULT_Z,
  DEBUG_GALLERY,
  DEBUG_THROTTLE_MS,
  DECK_OFFSET_AMPLITUDE,
  DECK_ROTATION_MAX,
  DETAIL_ACTIVE_LIFT,
  DETAIL_CAMERA_Z,
  ENABLE_DECK_EFFECT,
  RESTORE_LERP,
  SCALE_COMP_MAX,
  SCALE_COMP_MIN,
  STACK_ASSEMBLY_DUR,
  STACK_FADE_LERP,
  STACK_LERP,
  STACK_SWITCH_DUR,
  WRAP_EXTRA_DEPTH,
  WRAP_ROTATION,
} from "@components/Gallery/config"
import { Image } from "@react-three/drei"
import { extend, useFrame, useThree } from "@react-three/fiber"
import { geometry } from "maath"
import { useEffect, useMemo, useRef } from "react"
import { Vector3 } from "three"

extend({ RoundedPlaneGeometry: geometry.RoundedPlaneGeometry })

export default function AnimatingTile({
  url,
  position,
  delay,
  isPersonal,
  personalAnimationStartTime,
  targetScale,
  onCompleted,
  onClick,
  detailMode,
  detailStackScale,
  isActive,
  stackIndex,
  stackSize,
  activeIndex,
  switchInfo,
}) {
  const { camera, size } = useThree()
  const imageRef = useRef()
  const originalZRef = useRef(position[2])
  const deckSeedRef = useRef(position[2])
  const baseScaleRef = useRef(targetScale)
  const lastLogMsRef = useRef(0)
  const switchRef = useRef({ dir: 0, startMs: 0 })
  const tunedMatRef = useRef(false)
  const lastActiveLogRef = useRef(0)
  const tmpVecRef = useRef(new Vector3())
  const detailEnterMsRef = useRef(0)

  useEffect(() => {
    switchRef.current = switchInfo || { dir: 0, startMs: 0 }
  }, [switchInfo])
  const flags = {
    initialDone: useRef(false),
    grayscaleDone: useRef(false),
  }
  const completedSent = useRef(false)

  const targetZ = position[2]
  const personalDelay = useRef(
    isPersonal ? Math.random() * ANIMATION_CONFIG.personal.delayMax : 0,
  )
  const adjustedPersonalStartTime =
    personalAnimationStartTime + personalDelay.current
  const grayscaleStartTime =
    personalAnimationStartTime +
    ANIMATION_CONFIG.personal.delayMax +
    ANIMATION_CONFIG.personal.duration

  useFrame((state) => {
    const img = imageRef.current
    const mat = img?.material
    if (!img || !mat) return

    if (detailMode) {
      if (!tunedMatRef.current) {
        mat.transparent = true
        mat.depthWrite = false
        mat.depthTest = false
        if (typeof mat.opacity !== "number") mat.opacity = 1
        tunedMatRef.current = true
      }
      let assemblyK = 1
      if (detailEnterMsRef.current) {
        const elapsed = (performance.now() - detailEnterMsRef.current) / 1000
        assemblyK = Math.min(1, Math.max(0, elapsed / STACK_ASSEMBLY_DUR))
        if (typeof mat.opacity === "number") {
          mat.opacity = mat.opacity + (1 - mat.opacity) * STACK_FADE_LERP
        }
      }
      const originalZ = originalZRef.current
      let tx = 0
      let ty = 0
      if (ENABLE_DECK_EFFECT) {
        const seed = (deckSeedRef.current ?? originalZ) * 31.4159
        const sx = Math.sin(seed)
        const sy = Math.cos(seed)
        tx = sx * DECK_OFFSET_AMPLITUDE * assemblyK
        ty = sy * DECK_OFFSET_AMPLITUDE * 0.6 * assemblyK
        const r = sx * DECK_ROTATION_MAX
        img.rotation.z = img.rotation.z + (r - img.rotation.z) * 0.12
      }
      let depthOffset = 0
      let sideOffset = 0
      let relativeDistance = 0
      let shortest = 0

      let effectiveActiveTransform = activeIndex
      let effectiveActiveRender = activeIndex
      let switchProgress = 1
      const sw = switchRef.current
      if (
        typeof stackSize === "number" &&
        stackSize > 0 &&
        sw &&
        sw.dir &&
        sw.startMs
      ) {
        const elapsed = (performance.now() - sw.startMs) / 1000
        switchProgress = Math.min(1, Math.max(0, elapsed / STACK_SWITCH_DUR))
        const prevActive =
          (((activeIndex - sw.dir) % stackSize) + stackSize) % stackSize
        if (switchProgress < 0.5) {
          effectiveActiveTransform = prevActive
        }
        effectiveActiveRender = activeIndex
      }
      if (
        typeof stackIndex === "number" &&
        typeof stackSize === "number" &&
        stackSize > 0 &&
        typeof activeIndex === "number"
      ) {
        const raw = stackIndex - effectiveActiveTransform
        const half = Math.floor(stackSize / 2)
        shortest = raw
        if (raw > half) shortest = raw - stackSize
        else if (raw < -half) shortest = raw + stackSize

        const diff = Math.abs(shortest)
        const capped = Math.min(diff, 6)
        depthOffset = Math.max(-0.12, -0.02 * capped)
        sideOffset = 0
        relativeDistance = diff

        if (sw && sw.dir && sw.startMs) {
          const dir = sw.dir
          const progress = switchProgress
          const outgoingIndex =
            (((activeIndex - dir) % stackSize) + stackSize) % stackSize
          const isOutgoing = stackIndex === outgoingIndex
          if (isOutgoing) {
            const k = Math.sin(Math.PI * progress)
            depthOffset += WRAP_EXTRA_DEPTH * k
            const extraRot = dir * WRAP_ROTATION * k
            img.rotation.z = img.rotation.z + (extraRot - img.rotation.z) * 0.2
            if (DEBUG_GALLERY) {
              const now = performance.now()
              if (now - lastLogMsRef.current > DEBUG_THROTTLE_MS) {
                console.debug("[Tile] wrapping", {
                  stackIndex,
                  activeIndex,
                  dir,
                  progress: progress.toFixed(2),
                })
                lastLogMsRef.current = now
              }
            }
          }
        }
      }
      const isEffectiveActive =
        detailMode &&
        typeof stackIndex === "number" &&
        typeof stackSize === "number" &&
        stackSize > 0 &&
        typeof activeIndex === "number"
          ? stackIndex === effectiveActiveRender
          : isActive
      const ringPos =
        typeof stackSize === "number" && stackSize > 0
          ? (stackIndex - effectiveActiveRender + stackSize) % stackSize
          : 0
      img.renderOrder =
        10000 +
        (isEffectiveActive ? 10000 : 0) +
        (stackSize ? (stackSize - relativeDistance) * 100 : 0) +
        (shortest >= 0 ? 50 : 0) +
        ringPos
      img.position.x =
        img.position.x + (tx + sideOffset - img.position.x) * STACK_LERP
      img.position.y = img.position.y + (ty - img.position.y) * STACK_LERP

      const baseScale = detailStackScale || baseScaleRef.current
      const camZ = camera.position.z
      const lift = DETAIL_ACTIVE_LIFT * (DETAIL_CAMERA_Z / CAMERA_DEFAULT_Z)
      const focusZTarget =
        originalZ + (isEffectiveActive ? lift : 0.0) + depthOffset
      const denom = Math.max(0.001, camZ - focusZTarget)
      const numer = Math.max(0.001, camZ - img.position.z)
      let comp = numer / denom
      comp = Math.max(SCALE_COMP_MIN, Math.min(SCALE_COMP_MAX, comp))
      const focusScaleTarget = isEffectiveActive
        ? baseScale * 1.08 * comp
        : baseScale
      img.scale.x = img.scale.x + (focusScaleTarget - img.scale.x) * 0.18
      img.scale.y = img.scale.y + (focusScaleTarget - img.scale.y) * 0.18
      img.position.z = img.position.z + (focusZTarget - img.position.z) * 0.18

      if (DEBUG_GALLERY && isActive) {
        const now = performance.now()
        if (now - lastActiveLogRef.current > 200) {
          const dist = camera.position.distanceTo(img.position)
          const ndc = tmpVecRef.current.copy(img.position)
          ndc.project(camera)
          const sx = ((ndc.x + 1) / 2) * size.width
          const sy = ((-ndc.y + 1) / 2) * size.height
          console.debug("[Tile] active pose", {
            stackIndex,
            pos: {
              x: img.position.x.toFixed(2),
              y: img.position.y.toFixed(2),
              z: img.position.z.toFixed(2),
            },
            scale: img.scale.x.toFixed(2),
            renderOrder: img.renderOrder,
            rotZ: img.rotation.z.toFixed(3),
            opacity: mat.opacity.toFixed(2),
            dist: dist.toFixed(2),
            screen: { x: Math.round(sx), y: Math.round(sy) },
          })
          lastActiveLogRef.current = now
        }
      }
      return
    }

    const { elapsedTime } = state.clock

    if (isPersonal) {
      animatePersonal({
        img,
        mat,
        elapsedTime,
        adjustedStart: adjustedPersonalStartTime,
        targetScale,
        targetZ,
        flags,
      })
    } else {
      animateNormal({
        img,
        mat,
        elapsedTime,
        delay,
        targetScale,
        targetZ,
        grayscaleStart: grayscaleStartTime,
        flags,
      })
    }

    if (!detailMode) {
      img.position.x =
        img.position.x + (position[0] - img.position.x) * RESTORE_LERP
      img.position.y =
        img.position.y + (position[1] - img.position.y) * RESTORE_LERP
      mat.depthWrite = true
      mat.depthTest = true
      mat.transparent = true
    }

    if (!completedSent.current) {
      const done = isPersonal
        ? flags.initialDone.current
        : flags.initialDone.current && flags.grayscaleDone.current
      if (done && onCompleted) {
        completedSent.current = true
        onCompleted()
      }
    }
  })

  const initialScale = isPersonal
    ? ANIMATION_CONFIG.personal.startScale
    : ANIMATION_CONFIG.normal.startScale
  const initialOpacity = isPersonal
    ? ANIMATION_CONFIG.personal.startOpacity
    : ANIMATION_CONFIG.normal.startOpacity
  const initialZ = isPersonal
    ? ANIMATION_CONFIG.personal.startZ
    : ANIMATION_CONFIG.normal.startZ
  const initialPosition = useMemo(
    () => [position[0], position[1], initialZ],
    [position, initialZ],
  )

  useEffect(() => {
    const img = imageRef.current
    if (!img) return
    const mat = img.material
    img.position.set(initialPosition[0], initialPosition[1], initialPosition[2])
    img.scale.set(initialScale, initialScale, 1)
    if (mat) {
      mat.transparent = true
      mat.opacity = initialOpacity
    }
    originalZRef.current = position[2]
    deckSeedRef.current = position[2]
    if (!detailMode) {
      baseScaleRef.current = targetScale
    }
    tunedMatRef.current = false
  }, [
    initialPosition,
    initialScale,
    initialOpacity,
    position,
    targetScale,
    detailMode,
  ])

  useEffect(() => {
    if (detailMode) {
      detailEnterMsRef.current = performance.now()
      originalZRef.current = 0
    } else {
      detailEnterMsRef.current = 0
    }
  }, [detailMode])

  return (
    <Image
      ref={imageRef}
      url={url}
      transparent
      frustumCulled={false}
      onClick={onClick}
    >
      <roundedPlaneGeometry args={[1, 1, 0.08]} />
    </Image>
  )
}
</file>

<file path="src/components/Gallery/components/GalleryLoader.jsx">
import theme from "@theme"
import { motion } from "motion/react"
import { styled } from "styled-components"

const Wrapper = styled.div`
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 90vh;
  width: 100%;
  background-color: ${theme.colors.background.dark};
  color: ${theme.colors.background.paper};
  font-family: ${theme.fontFamily};
`

const SpinnerRing = styled(motion.div)`
  width: ${(p) => p.$size}px;
  height: ${(p) => p.$size}px;
  border: 3px solid ${theme.colors.background.paper}30;
  border-top: 3px solid ${theme.colors.background.paper};
  border-radius: 50%;
`

const Title = styled.h2`
  margin: 20px 0 10px 0;
  font-size: 24px;
  font-weight: 300;
  color: ${theme.colors.background.paper};
`

const Subtitle = styled.p`
  margin: 0 0 20px 0;
  font-size: 16px;
  color: ${theme.colors.background.paper};
  opacity: 0.8;
`

const ProgressBar = styled.div`
  width: 300px;
  height: 4px;
  background-color: ${theme.colors.background.paper}30;
  border-radius: 2px;
  overflow: hidden;
`

const ProgressFill = styled(motion.div)`
  height: 100%;
  background-color: ${theme.colors.background.paper};
  border-radius: 2px;
`

const Hint = styled.p`
  margin: 10px 0 0 0;
  font-size: 14px;
  text-align: center;
  max-width: 400px;
  color: ${theme.colors.background.paper};
  opacity: 0.6;
`

export default function GalleryLoader({ loadedCount, totalImages }) {
  const progress = (loadedCount / totalImages) * 100

  return (
    <Wrapper>
      <SpinnerRing
        $size={60}
        animate={{ rotate: 360 }}
        transition={{ duration: 1, ease: "linear", repeat: Infinity }}
      />

      <Title>Loading Gallery</Title>

      <Subtitle>
        {loadedCount} of {totalImages} images loaded
      </Subtitle>

      <ProgressBar>
        <ProgressFill
          initial={{ width: "0%" }}
          animate={{ width: `${progress}%` }}
          transition={{ duration: 0.3, ease: "easeInOut" }}
        />
      </ProgressBar>

      <Hint>Please wait while we prepare your image gallery experience</Hint>
    </Wrapper>
  )
}
</file>

<file path="src/components/Gallery/config.js">
export const DISPLACEMENT_RATIO = 0.05
export const BASE_IMAGE_SCALE = 1.25
export const PERSONAL_SCALE_MULTIPLIER = 1.25

export const ANIMATION_DURATION = 5.2
export const MAX_RANDOM_DELAY = 5.5

export const CAMERA_DEFAULT_Z = 5
export const DETAIL_CAMERA_Z = 2.1
export const CAMERA_LERP = 0.06
export const DETAIL_ACTIVE_LIFT = 0.4

export const STACK_LERP = 0.12
export const ENABLE_DECK_EFFECT = true
export const DECK_OFFSET_AMPLITUDE = 0.12
export const DECK_ROTATION_MAX = 0.04

export const STACK_SWITCH_DUR = 0.5
export const STACK_BUMP_AMPLITUDE = 0.12
export const WRAP_EXTRA_DEPTH = -0.45
export const WRAP_ROTATION = 0.12

export const SCALE_COMP_MIN = 0.9
export const SCALE_COMP_MAX = 1.15

export const RESTORE_LERP = 0.2

export const STACK_ASSEMBLY_DUR = 0.35
export const STACK_FADE_LERP = 0.18

export const DEBUG_GALLERY = import.meta.env.DEV
export const DEBUG_THROTTLE_MS = 150

export const ANIMATION_CONFIG = {
  normal: {
    startScale: 0.3,
    startOpacity: 0,
    endOpacity: 1,
    startZ: -2,
    duration: 5.2,
  },
  personal: {
    startScale: 3,
    startOpacity: 0,
    endOpacity: 1,
    startZ: 2,
    duration: 3.5,
    delayMax: 2,
  },
  grayscale: {
    duration: 2.0,
    start: 0.7,
    end: 0,
  },
}

export default ANIMATION_CONFIG
</file>

<file path="src/components/PhotoCapture/styles.js">
import { styled } from "styled-components"

export const PhotoCaptureContainer = styled.div`
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  width: 100%;
  padding: 0 0 34.75rem 0;
`

export const HeaderContainer = styled.div`
  display: flex;
  width: 21.4375rem;
  flex-direction: column;
  align-items: flex-start;
  padding: 1.5625rem;
`

export const HeaderText = styled.h1`
  color: #fff;
  font-size: 1.5rem;
  font-style: normal;
  font-weight: 700;
  line-height: normal;
  margin: 0;
  text-align: center;
`

export const TasksContainer = styled.div`
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
  width: 100%;
  align-items: flex-start;
`

export const TaskCard = styled.div`
  display: flex;
  width: 23rem;
  height: 9.4375rem;
  padding: 1.75rem 1.625rem;
  flex-direction: column;
  align-items: flex-start;
  gap: 1.125rem;
  flex-shrink: 0;
  border-radius: 0 1.75rem 1.75rem 0;
  background-color: #f1ece1;
  position: relative;
`

export const TaskHeadline = styled.h2`
  color: #000;
  font-size: 1.3rem;
  font-style: normal;
  font-weight: 700;
  line-height: normal;
  margin: 0;
`

export const TaskDescription = styled.div`
  color: #000;
  font-size: 0.3rem;
  font-style: normal;
  font-weight: 400;
  line-height: 1.5;
  margin: 0;

  p {
    margin: 0;
  }
`

export const TaskContent = styled.div`
  display: flex;
  align-items: center;
  gap: 1rem;
  width: 100%;
`

export const TaskImage = styled.img`
  width: 7rem;
  height: 7rem;
  position: absolute;
  right: 0;
  top: 50%;
  transform: translateY(-50%);
  margin-right: 2rem;
  border-radius: 1rem;
  object-fit: cover;
`

export const HiddenInput = styled.input`
  display: none;
`

export const MetadataContainer = styled.div`
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: #f1ece1;
  border-radius: 1.75rem;
  padding: 2rem;
  width: 90%;
  max-width: 25rem;
  z-index: 1000;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
`

export const MetadataSection = styled.div`
  margin-bottom: 1.5rem;

  h3 {
    color: #000;
    font-size: 1.2rem;
    font-weight: 700;
    margin: 0 0 0.5rem 0;
  }

  p {
    color: #666;
    font-size: 0.9rem;
    margin: 0;
  }
`

export const MetadataLabel = styled.label`
  display: block;
  color: #000;
  font-size: 1rem;
  font-weight: 600;
  margin-bottom: 0.5rem;
`

export const MetadataInput = styled.input`
  width: 100%;
  padding: 0.75rem;
  border: 2px solid #ccc;
  border-radius: 0.5rem;
  font-size: 1rem;
  font-family: inherit;
  transition: border-color 0.2s;

  &:focus {
    outline: none;
    border-color: #666;
  }
`

export const MetadataTextarea = styled.textarea`
  width: 100%;
  padding: 0.75rem;
  border: 2px solid #ccc;
  border-radius: 0.5rem;
  font-size: 1rem;
  font-family: inherit;
  resize: vertical;
  transition: border-color 0.2s;

  &:focus {
    outline: none;
    border-color: #666;
  }
`

export const MetadataActions = styled.div`
  display: flex;
  gap: 1rem;
  justify-content: flex-end;
  margin-top: 2rem;
`

export const MetadataOverlay = styled.div`
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  z-index: 999;
`
</file>

<file path="src/components/UI/Header.jsx">
import { AnimatePresence, motion } from "motion/react"
import { styled } from "styled-components"

import Headline from "@ui/Headline"
import LegalNotice from "@ui/LegalNotice"
import SubHeadline from "@ui/SubHeadline"

const HeaderLayout = styled(motion.div)`
  display: flex;
  width: 100%;
  height: 10.5625rem;
  padding: 3.625rem 0.625rem 0.625rem 0.625rem;
  flex-direction: column;
  align-items: center;
  z-index: 3;
`

export default function Header({
  headline,
  subheadline,
  legalNotice,
  setShowScreen,
}) {
  return (
    <HeaderLayout>
      <AnimatePresence mode="popLayout">
        {subheadline && (
          <SubHeadline
            key={`subheadline-${subheadline}`}
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
          >
            {legalNotice && (
              <LegalNotice key="test-dino" setShowScreen={setShowScreen} />
            )}
            {subheadline}
          </SubHeadline>
        )}
        <Headline
          key={`headline-${headline}`}
          layoutId="headline"
          initial={{ opacity: 0 }}
          animate={{
            opacity: 1,
            transition: { duration: 0.5, ease: "easeInOut", delay: 0.5 },
          }}
          exit={{ opacity: 0 }}
          transition={{ layout: { duration: 0.2, ease: "easeInOut" } }}
        >
          {headline}
        </Headline>
      </AnimatePresence>
    </HeaderLayout>
  )
}
</file>

<file path="src/components/UI/IconButton.jsx">
import { styled } from "styled-components"

const StyledButton = styled.button`
  all: unset;
  width: 3.4375rem;
  height: 3.4375rem;
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  &[data-color="black"] svg rect {
    stroke: black;
  }
  &[data-color="black"] svg path {
    fill: black;
  }
  &[data-color="black"]:disabled svg rect {
    stroke: #444;
  }
  &[data-color="black"]:disabled svg path {
    fill: #444;
  }

  &:disabled {
    svg rect {
      stroke: #888;
    }

    svg path {
      fill: #888;
    }
  }
`

const ICON_VARIANTS = {
  arrowDown: {
    svg: (
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="55"
        height="55"
        viewBox="0 0 55 55"
        fill="none"
      >
        <rect
          x="1"
          y="1"
          width="53"
          height="53"
          rx="26.5"
          transform="matrix(0 1 1 0 0 0)"
          stroke="white"
          strokeWidth="2"
        />
        <path
          d="M26 16.5C26 15.9477 26.4477 15.5 27 15.5C27.5523 15.5 28 15.9477 28 16.5H26ZM27.7071 40.2071C27.3166 40.5976 26.6834 40.5976 26.2929 40.2071L19.9289 33.8431C19.5384 33.4526 19.5384 32.8195 19.9289 32.4289C20.3195 32.0384 20.9526 32.0384 21.3431 32.4289L27 38.0858L32.6569 32.4289C33.0474 32.0384 33.6805 32.0384 34.0711 32.4289C34.4616 32.8195 34.4616 33.4526 34.0711 33.8431L27.7071 40.2071ZM27 16.5H28V39.5H27H26V16.5H27Z"
          fill="white"
        />
      </svg>
    ),
    label: "Arrow down",
  },

  camera: {
    svg: (
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="55"
        height="55"
        viewBox="0 0 55 55"
        fill="none"
      >
        <rect
          x="1"
          y="1"
          width="53"
          height="53"
          rx="26.5"
          stroke="black"
          strokeWidth="2"
        />
        <path
          fillRule="evenodd"
          clipRule="evenodd"
          d="M22.5226 15.0001C21.9679 15.0001 21.4975 15.2754 21.201 15.6215C20.9046 15.9675 20.7337 16.3695 20.5851 16.755C20.5851 16.7564 20.5851 16.7578 20.5851 16.7592L20.0371 18.1784H14.2329C13.0044 18.1784 12 19.1681 12 20.372V35.8053C12 37.0092 13.0044 38 14.2329 38H40.7702C41.9988 38 43 37.0092 43 35.8053V20.3721C43 19.1681 41.9988 18.1784 40.7702 18.1784H34.9661L34.418 16.7591C34.418 16.7588 34.418 16.7595 34.418 16.7591C34.418 16.7588 34.418 16.7574 34.418 16.757C34.418 16.7567 34.418 16.7574 34.418 16.757C34.418 16.7567 34.418 16.7553 34.418 16.7549C34.2694 16.3695 34.0985 15.9674 33.8021 15.6214C33.5057 15.2753 33.0352 15 32.4805 15L22.5226 15.0001ZM22.5226 16.0459H32.4805C32.7227 16.0459 32.8282 16.1138 32.9816 16.2928C33.1349 16.4719 33.2855 16.7765 33.42 17.1254L34.0986 18.8834C34.1364 18.9826 34.2042 19.0682 34.2929 19.1288C34.3817 19.1895 34.4872 19.2224 34.5955 19.2232H40.7702C41.4201 19.2232 41.9342 19.7241 41.9342 20.372V35.8053C41.9342 36.4533 41.4201 36.9542 40.7702 36.9542H14.2329C13.5831 36.9542 13.069 36.4533 13.069 35.8053V20.372C13.069 19.7241 13.5831 19.2232 14.2329 19.2232H20.4077C20.516 19.2224 20.6215 19.1895 20.7102 19.1288C20.7989 19.0682 20.8667 18.9826 20.9046 18.8834L21.5831 17.1254C21.7176 16.7765 21.8682 16.4719 22.0216 16.2928C22.1749 16.1138 22.2804 16.0459 22.5226 16.0459ZM27.5021 21.2281C23.6593 21.2281 20.5382 24.3075 20.5382 28.0887C20.5382 31.8699 23.6593 34.9533 27.5021 34.9533C31.3449 34.9533 34.465 31.8699 34.465 28.0887C34.465 24.3075 31.3449 21.2281 27.5021 21.2281ZM38.8473 21.4383C38.7473 21.4386 38.6484 21.4582 38.5561 21.4959C38.4638 21.5336 38.3801 21.5887 38.3096 21.6581C38.2391 21.7274 38.1833 21.8097 38.1454 21.9001C38.1074 21.9905 38.088 22.0874 38.0884 22.1852C38.0891 22.3817 38.1693 22.57 38.3114 22.7089C38.4536 22.8479 38.6462 22.9263 38.8473 22.9269C38.9474 22.9274 39.0466 22.9086 39.1393 22.8715C39.2319 22.8345 39.3162 22.78 39.3873 22.7111C39.4583 22.6422 39.5148 22.5603 39.5534 22.47C39.5921 22.3798 39.6122 22.283 39.6125 22.1852C39.6129 22.0869 39.5933 21.9895 39.5549 21.8987C39.5166 21.8079 39.4602 21.7253 39.3891 21.6559C39.318 21.5865 39.2335 21.5315 39.1405 21.4941C39.0475 21.4568 38.9479 21.4378 38.8473 21.4383ZM27.5021 22.2739C30.7622 22.2739 33.396 24.8673 33.396 28.0887C33.396 31.3101 30.7622 33.9085 27.5021 33.9085C24.242 33.9085 21.6071 31.3101 21.6071 28.0887C21.6071 24.8673 24.242 22.2739 27.5021 22.2739Z"
          fill="black"
        />
      </svg>
    ),
    label: "Camera",
  },

  arrowLeft: {
    svg: (
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="55"
        height="55"
        viewBox="0 0 55 55"
        fill="none"
      >
        <rect
          x="1"
          y="1"
          width="53"
          height="53"
          rx="26.5"
          stroke="white"
          strokeWidth="2"
        />
        <path
          d="M38.5 27C38.5 27.5523 38.0523 28 37.5 28C36.9477 28 36.5 27.5523 36.5 27H38.5ZM14.7929 27.7071C14.4024 27.3166 14.4024 26.6834 14.7929 26.2929L21.1569 19.9289C21.5474 19.5384 22.1805 19.5384 22.5711 19.9289C22.9616 20.3195 22.9616 20.9526 22.5711 21.3431L16.9142 27L22.5711 32.6569C22.9616 33.0474 22.9616 33.6805 22.5711 34.0711C22.1805 34.4616 21.5474 34.4616 21.1569 34.0711L14.7929 27.7071ZM38.5 27H15.5V26H38.5V27Z"
          fill="white"
        />
      </svg>
    ),
    label: "Arrow left",
  },

  arrowRight: {
    svg: (
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="55"
        height="55"
        viewBox="0 0 55 55"
        fill="none"
      >
        <rect
          x="1"
          y="1"
          width="53"
          height="53"
          rx="26.5"
          stroke="white"
          strokeWidth="2"
        />
        <path
          d="M16.5 27C16.5 26.4477 16.9477 26 17.5 26C18.0523 26 18.5 26.4477 18.5 27H16.5ZM40.2071 26.2929C40.5976 26.6834 40.5976 27.3166 40.2071 27.7071L33.8431 34.0711C33.4526 34.4616 32.8195 34.4616 32.4289 34.0711C32.0384 33.6805 32.0384 33.0474 32.4289 32.6569L38.0858 27L32.4289 21.3431C32.0384 20.9526 32.0384 20.3195 32.4289 19.9289C32.8195 19.5384 33.4526 19.5384 33.8431 19.9289L40.2071 26.2929ZM16.5 27H39.5V28H16.5V27Z"
          fill="white"
        />
      </svg>
    ),
    label: "Arrow right",
  },
}

export default function IconButton({
  variant,
  onClick,
  disabled,
  color,
  ...props
}) {
  const iconVariant = ICON_VARIANTS[variant || "arrowDown"]

  return (
    <StyledButton
      type="button"
      onClick={onClick}
      disabled={disabled}
      data-color={color}
      {...props}
    >
      {iconVariant.svg}
    </StyledButton>
  )
}
</file>

<file path="src/components/UI/MobileOnlyGuard.jsx">
import useDevicePlatform from "@/hooks/useDevicePlatform"
import { useEffect, useState } from "react"
import { styled } from "styled-components"

const Overlay = styled.div`
  position: fixed;
  inset: 0;
  background: #1f1f1f;
  color: #ffffff;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
  padding: 2rem;
  font-family: inherit;
  z-index: 1000;
`

const Headline = styled.h1`
  font-size: 2rem;
  font-weight: 700;
  margin: 0 0 1rem;
`

const Text = styled.p`
  margin: 0;
  font-size: 1rem;
  line-height: 1.4;
  max-width: 32rem;
  opacity: 0.85;
`

const BypassButton = styled.button`
  margin-top: 2rem;
  background: transparent;
  color: #ffffff;
  border: 1px solid #ffffff;
  padding: 0.75rem 1.5rem;
  border-radius: 2rem;
  font-size: 0.875rem;
  font-weight: 600;
  cursor: pointer;
  letter-spacing: 0.5px;
  transition:
    background 0.2s,
    color 0.2s;
  &:hover {
    background: #ffffff;
    color: #1f1f1f;
  }
`

// Shows a blocking overlay on non-mobile platforms (Windows, MacOS, Linux)
export default function MobileOnlyGuard({ children }) {
  const { isAndroid, isIOS } = useDevicePlatform()
  const [isClient, setIsClient] = useState(false)
  const [bypassed, setBypassed] = useState(false)
  useEffect(() => setIsClient(true), [])

  if (!isClient) return null
  const isMobile = isAndroid || isIOS

  if (!isMobile && !bypassed) {
    return (
      <Overlay>
        <Headline>Please use a mobile device</Headline>
        <Text>
          This experience is designed for mobile sensors and camera access. Open
          this URL on your phone or tablet to continue.
        </Text>
        <BypassButton onClick={() => setBypassed(true)}>
          Continue anyway
        </BypassButton>
      </Overlay>
    )
  }

  return children
}
</file>

<file path="src/components/UI/RiveAnimation.jsx">
import { Alignment, Fit, Layout, useRive } from "@rive-app/react-canvas"
import styled from "styled-components"

const RiveContainer = styled.div`
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
`

export default function RiveAnimation({
  src,
  stateMachines,
  autoplay = true,
  onLoad,
  ...otherProps
}) {
  const { rive, RiveComponent } = useRive({
    src,
    stateMachines,
    autoplay,
    layout: new Layout({
      fit: Fit.FitHeight,
      alignment: Alignment.BottomRight,
    }),
    onLoad: onLoad ? () => onLoad(rive) : undefined,
  })

  return (
    <RiveContainer {...otherProps}>
      <RiveComponent />
    </RiveContainer>
  )
}
</file>

<file path="src/components/UI/Vignette.jsx">
import { styled } from "styled-components"

const GradientWelcome = styled.div`
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 14.4375rem;
  pointer-events: none;
  z-index: 1;
  background: linear-gradient(
    0deg,
    rgba(0, 0, 0, 0) 0.68%,
    rgba(0, 0, 0, 0.72) 46.21%,
    #1f1f1f 86.99%
  );
`

const GradientCharacter = styled.div`
  position: absolute;
  bottom: 0;
  left: 0;
  width: 100%;
  height: 18.25rem;
  pointer-events: none;
  z-index: 1;
  background: linear-gradient(
    179deg,
    rgba(31, 31, 31, 0) 0.68%,
    #1f1f1f 36.25%
  );
`

export default function Vignette() {
  return (
    <>
      <GradientWelcome />
      <GradientCharacter />
    </>
  )
}
</file>

<file path="src/components/Welcome/hooks/useWelcomeBackground.js">
import LaNau from "@ui/assets/LaNau.webp"

import { STEP } from "../constants"

export function useWelcomeBackground(step, welcomeData, characterOverviewData) {
  if (step === STEP.INTRO && welcomeData?.backgroundImage?.file) {
    return welcomeData.backgroundImage.file
  } else if (
    step === STEP.CHARACTER &&
    characterOverviewData?.backgroundImage?.file
  ) {
    return characterOverviewData.backgroundImage.file
  }
  return LaNau
}
</file>

<file path="src/components/Welcome/hooks/useWelcomeSteps.js">
import { useState } from "react"

import { STEP } from "../constants"

export function useWelcomeSteps({
  goToIntroduction,
  showIntro,
  setShowIntro,
  currentCharacterIndex,
  setCurrentCharacterIndex,
  charactersData,
  initialStep = STEP.INTRO,
}) {
  const [step, setStep] = useState(initialStep)

  const advanceFromIntro = () => setStep(STEP.CHARACTER)

  const confirmCharacter = () => {
    setShowIntro(false)
  }

  const onSelect = () => {
    if (step === STEP.INTRO) return advanceFromIntro()
    if (step === STEP.CHARACTER && showIntro) return confirmCharacter()
    if (step === STEP.CHARACTER && !showIntro) return goToIntroduction()
  }

  const handleCharacterPrev = () => {
    if (currentCharacterIndex === 0) return
    setCurrentCharacterIndex(currentCharacterIndex - 1)
  }

  const handleCharacterNext = () => {
    const totalCharacters = charactersData?.length || 0
    const last = totalCharacters - 1
    if (currentCharacterIndex === last) return
    setCurrentCharacterIndex(currentCharacterIndex + 1)
  }

  // Calculate navigation props based on current state
  const getNavigationProps = (navigationMode) => {
    const totalCharacters = charactersData?.length || 0
    const currentCharacter = charactersData?.[currentCharacterIndex]

    return {
      mode: !showIntro ? "select" : navigationMode,
      onSelect,
      onPrev: handleCharacterPrev,
      onNext: handleCharacterNext,
      prevDisabled: currentCharacterIndex === 0,
      nextDisabled: currentCharacterIndex === totalCharacters - 1,
      selectLabel:
        !showIntro && currentCharacter?.selectButtonText
          ? currentCharacter.selectButtonText
          : undefined,
    }
  }

  return {
    step,
    setStep,
    onSelect,
    handleCharacterPrev,
    handleCharacterNext,
    getNavigationProps,
  }
}
</file>

<file path="src/components/Welcome/styles.jsx">
import { styled } from "styled-components"

export const Layout = styled.div`
  display: flex;
  flex-direction: column;
  width: 100dvw;
  height: 100dvh;
  /* Safe area padding for devices with notches */
  padding-top: var(--safe-inset-top);
  padding-bottom: var(--safe-inset-bottom);
  background: ${({ theme, $backgroundImage }) =>
    `${theme.colors.background.dark} url(${$backgroundImage}) center / cover no-repeat`};
  /* If large background images cause repaints during scroll (not expected in kiosk),
     consider: background-attachment: local; or further optimization via preloading. */
  position: relative; /* Removed absolute: rely on root grid centering */
`

export const TextLayout = styled.div`
  display: flex;
  flex-direction: column;
  width: 100%;
  max-width: 24.5625rem;
  margin: 0 auto;
  padding: 0 1rem; /* Prevent edge clipping on narrower screens */
  justify-content: ${({ $hasDescription }) =>
    $hasDescription ? "space-between" : "flex-start"};
  align-items: flex-start;
  flex: 1 0 auto;
`

export const ChildrenContainer = styled.div`
  position: fixed;
  inset: 0;
  width: 100dvw;
  height: 100dvh;
  /* Layering note: This acts as an overlay (character carousel / animations).
     If it ever blocks underlying interactive text unintentionally,
     you can enable pass-through: pointer-events: none; and re-enable
     on specific interactive descendants with pointer-events: auto. */
`

export const LanguageSelectorContainer = styled.div`
  position: fixed;
  top: 2rem;
  right: 2rem;
  z-index: 1000;
`
</file>

<file path="src/hooks/useCharacterCarousel.js">
export * from "@components/Welcome/CharacterShowcase/hooks/useCharacterCarousel"
</file>

<file path="src/hooks/useImagePreloader.js">
export { default } from "@components/Gallery/hooks/useImagePreloader"
</file>

<file path="src/hooks/useResponsiveTilesPerRow.js">
// (Moved) useResponsiveTilesPerRow now lives in components/Gallery/hooks/useResponsiveTilesPerRow.js
export { default } from "@components/Gallery/hooks/useResponsiveTilesPerRow"
</file>

<file path="src/hooks/useSwipeGesture.js">
export default function useSwipeGesture() {
  throw new Error("useSwipeGesture has been removed")
}
</file>

<file path="src/theme/index.js">
export const theme = {
  fontFamily: '"Bricolage Grotesque", system-ui, -apple-system, sans-serif',
  colors: {
    background: {
      dark: "#1F1F1F", // base dark background (perspective & upload screens)
      paper: "#F1ECE1",
      light: "#FFFFFF",
    },
    text: {
      primary: "#000000",
    },
  },
}

export default theme
</file>

<file path="src/utils/languageErrors.js">
export const handleLanguageError = (error) => {
  throw error
}
</file>

<file path="src/main.jsx">
import StateProvider from "@/GlobalState"
import GlobalStyles from "@/GlobalStyles"
import LanguageProvider from "@/providers/LanguageProvider"
import CharacterLayout, {
  loader as characterLoader,
} from "@/routes/CharacterLayout"
import ErrorPage from "@/routes/ErrorPage"
import Root, { AppLayout, loader as rootLoader } from "@/routes/Root"
import Ending, { loader as endingLoader } from "@components/Ending"
import Exploration, {
  loader as explorationLoader,
} from "@components/Exploration"
import Gallery, { loader as galleryLoader } from "@components/Gallery"
import Introduction, {
  loader as introductionLoader,
} from "@components/Introduction"
import Perspective, {
  loader as perspectiveLoader,
} from "@components/Perspective"
import PhotoCapture, {
  loader as photoCaptureLoader,
} from "@components/PhotoCapture"
import Upload, { loader as uploadLoader } from "@components/Upload"
import Welcome, { loader as welcomeLoader } from "@components/Welcome"
import { QueryClient, QueryClientProvider } from "@tanstack/react-query"
import { ReactQueryDevtools } from "@tanstack/react-query-devtools"
import AppThemeProvider from "@theme/ThemeProvider"
import { StrictMode, Suspense } from "react"
import ReactDOM from "react-dom/client"
import { createBrowserRouter, Navigate, RouterProvider } from "react-router-dom"

// Initialize i18n
import "@/i18n"

const queryClient = new QueryClient()

const router = createBrowserRouter([
  {
    id: "root",
    element: <Root />,
    loader: rootLoader(queryClient),
    errorElement: (
      <AppLayout>
        <ErrorPage />
      </AppLayout>
    ),
    children: [
      {
        index: true,
        id: "welcome",
        loader: welcomeLoader(queryClient),
        element: <Welcome />,
      },
      {
        path: "characters/:characterId",
        id: "character",
        loader: characterLoader(queryClient),
        element: <CharacterLayout />,
        children: [
          {
            index: true,
            element: <Navigate to="introduction" replace />,
          },
          {
            path: "introduction",
            loader: introductionLoader(queryClient),
            element: <Introduction />,
          },
          {
            path: "photo-capture",
            loader: photoCaptureLoader(queryClient),
            element: <PhotoCapture />,
          },
          {
            path: "exploration",
            loader: explorationLoader(queryClient),
            element: <Exploration />,
          },
          {
            path: "perspective",
            loader: perspectiveLoader(queryClient),
            element: <Perspective />,
          },
          {
            path: "upload",
            loader: uploadLoader(queryClient),
            element: <Upload />,
          },
          {
            path: "gallery",
            loader: galleryLoader(queryClient),
            element: <Gallery />,
          },
          {
            path: "ending",
            loader: endingLoader(queryClient),
            element: <Ending />,
          },
        ],
      },
    ],
  },
])

ReactDOM.createRoot(document.getElementById("root")).render(
  <StrictMode>
    <QueryClientProvider client={queryClient}>
      <LanguageProvider>
        <StateProvider>
          <AppThemeProvider>
            <GlobalStyles />
            <Suspense fallback={null}>
              <RouterProvider
                router={router}
                fallbackElement={null}
                hydrateFallbackElement={<></>}
              />
              <ReactQueryDevtools />
            </Suspense>
          </AppThemeProvider>
        </StateProvider>
      </LanguageProvider>
    </QueryClientProvider>
  </StrictMode>,
)
</file>

<file path="src/components/Introduction/styles.js">
import { motion } from "motion/react"
import { styled } from "styled-components"

import IntroductionBackground from "./IntroductionBackground.png"

export const IntroductionContainer = styled.div`
  position: relative;
  width: 100%;
  height: 100vh;
  overflow-y: auto;
  overflow-x: hidden;
  background-image: url(${IntroductionBackground});
  background-size: contain;
  background-position: center;
  background-repeat: no-repeat;
`

export const CharacterImageContainer = styled.div`
  position: absolute;
  top: 0;
  right: 0;
  z-index: 1;
`

export const CharacterImage = styled.img`
  width: 100%;
  height: 100%;
  object-fit: contain;
`

export const ContentContainer = styled(motion.div)`
  position: absolute;
  top: 38.3125rem;
  left: 50%;
  display: flex;
  width: 90%;
  height: 59.5625rem;
  padding: 1.75rem 1.5rem;
  flex-direction: column;
  align-items: flex-start;
  gap: 2rem;
  flex-shrink: 0;
  border-radius: 1.75rem;
  background: #f1ece1;
  z-index: 2;
`

export const Headline = styled.h1`
  color: #000;
  font-size: 1.5rem;
  font-style: normal;
  font-weight: 600;
  line-height: 94%;
  margin: 0;
`

export const TextBlock = styled.p`
  color: #000;
  font-size: 1rem;
  font-style: normal;
  font-weight: 400;
  line-height: normal;
  letter-spacing: -0.01rem;
  height: 12.125rem;
  flex-shrink: 0;
  align-self: stretch;
  margin: 0;
  white-space: pre-line;
`

export const Image = styled.img`
  width: 18.4375rem;
  height: 13.4375rem;
  border-radius: 1.75rem;
`

export const RiveAnimationContainer = styled.div`
  position: absolute;
  top: 0;
  right: 0;
  width: 100%;
  height: 100%;
  z-index: 0;
  overflow: hidden;
`

export const CameraButtonContainer = styled.div`
  display: flex;
  height: 7.1875rem;
  padding: 3.75rem 0;
  margin-bottom: 10rem;
  flex-direction: column;
  justify-content: flex-end;
  align-items: center;
  flex-shrink: 0;
  align-self: stretch;
`
</file>

<file path="src/components/Upload/styles.js">
import theme from "@/theme"
import { styled } from "styled-components"

export const UploadContainer = styled.div`
  width: 100%;
  height: 100%;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 1.75rem 0 7rem; /* leave bottom space for nav */
  box-sizing: border-box;
  gap: 1.75rem;
  color: #fff;
`

export const ImagesGrid = styled.div`
  display: flex;
  flex-direction: column;
  width: 100%;
  gap: 2rem;
  justify-content: flex-start;
`

export const ImageRow = styled.div`
  display: flex;
  align-items: center;
  gap: 1rem;
  background: #f1ece1;
  border-radius: 0 1.25rem 1.25rem 0;
  padding: 0.75rem 0.75rem 0.75rem 1rem;
  position: relative;
  min-height: 6.25rem;
  overflow: hidden;
  width: 80%;
`

export const TaskLabel = styled.h2`
  margin: 0;
  font-size: 1.05rem;
  font-weight: 700;
  color: #000;
  flex: 1;
`

export const Preview = styled.img`
  width: 5.5rem;
  height: 5.5rem;
  object-fit: cover;
  border-radius: 0.75rem;
  background: #ccc;
`

export const Missing = styled.div`
  width: 5.5rem;
  height: 5.5rem;
  border-radius: 0.75rem;
  background: #d9d9d9;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.75rem;
  color: #333;
  font-weight: 600;
`

export const QuestionBlock = styled.div`
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 5rem;
  text-align: center;
  max-width: 32rem;
  width: 80%;
`

export const Question = styled.h1`
  font-size: 1.6rem;
  margin: 0;
  font-weight: 700;
`

export const Actions = styled.div`
  display: flex;
  gap: 1rem;
  & > button {
    border-color: ${theme.colors.background.light};
    color: ${theme.colors.background.light};
  }
`

export const StatusIndicator = styled.span`
  margin-left: 8px;
  font-size: 0.7rem;
  color: ${({ $status }) => {
    switch ($status) {
      case "success":
        return "#4ecdc4"
      case "error":
        return "#ff6b6b"
      default:
        return "#ffa500"
    }
  }};
`

export const ProgressMessage = styled.div`
  color: ${({ $hasErrors }) => ($hasErrors ? "#ff6b6b" : "#4ecdc4")};
  margin-bottom: 1rem;
  font-size: 0.9rem;
  text-align: center;
`

export const ErrorList = styled.div`
  color: #ff6b6b;
  margin-bottom: 1rem;
  font-size: 0.8rem;
  text-align: center;

  div {
    margin-bottom: 0.25rem;
  }
`
</file>

<file path="src/components/Welcome/CharacterShowcase/components/Intro.jsx">
import {
  IntroCharacterImage,
  IntroCharacterItem,
  IntroCharactersRow,
  IntroContainer,
} from "@components/Welcome/CharacterShowcase/styles"
import { useTranslation } from "react-i18next"
import { useRouteLoaderData } from "react-router-dom"

export default function Intro({ onCharacterSelect }) {
  const { t } = useTranslation()
  const loaderData = useRouteLoaderData("welcome")
  const charactersData = loaderData?.characters ?? []

  // Return early if no characters data is available yet
  if (!charactersData || charactersData.length === 0) {
    return (
      <IntroContainer>
        {t("loading.characters", "Loading characters...")}
      </IntroContainer>
    )
  }

  return (
    <IntroContainer>
      <IntroCharactersRow
        initial={{ y: 50, opacity: 0 }}
        animate={{ y: 0, opacity: 1 }}
        transition={{ duration: 0.6, delay: 0.4 }}
      >
        {charactersData.map((character, index) => (
          <IntroCharacterItem
            key={character.id || character.name}
            initial={{ y: 30, opacity: 0 }}
            animate={{ y: 0, opacity: 1 }}
            transition={{
              duration: 0.5,
              delay: 0.6 + index * 0.1,
              ease: "easeOut",
            }}
            onClick={() => onCharacterSelect(index)}
          >
            <IntroCharacterImage
              src={character.image || character.characterImage?.file}
              initial={{ scale: 0.8, opacity: 0 }}
              animate={{ scale: 1, opacity: 1 }}
              transition={{
                duration: 0.4,
                delay: 0.8 + index * 0.1,
                ease: "easeOut",
              }}
            />
          </IntroCharacterItem>
        ))}
      </IntroCharactersRow>
    </IntroContainer>
  )
}
</file>

<file path="src/components/Welcome/CharacterShowcase/hooks/useCharacterCarousel.js">
// Moved from src/hooks/useCharacterCarousel.js
import { animate, useMotionValue } from "motion/react"
import { useEffect, useRef, useState } from "react"

export const useCharacterCarousel = (
  selectedIndex,
  charactersLength,
  onSelectionChange,
) => {
  const x = useMotionValue(0)
  const lastDragX = useRef(0)
  const dragStartX = useRef(0)
  const dragStartTime = useRef(0)
  const [spacing, setSpacing] = useState(0)

  useEffect(() => {
    const updateSpacing = () => {
      const viewportWidth =
        document.documentElement.clientWidth || window.innerWidth
      setSpacing(viewportWidth)
    }

    setTimeout(updateSpacing, 100)

    window.addEventListener("resize", updateSpacing)
    window.addEventListener("orientationchange", updateSpacing)

    return () => {
      window.removeEventListener("resize", updateSpacing)
      window.removeEventListener("orientationchange", updateSpacing)
    }
  }, [])

  useEffect(() => {
    const targetPosition = -spacing * selectedIndex
    animate(x, targetPosition, {
      type: "spring",
      stiffness: 300,
      damping: 30,
    })
  }, [selectedIndex, spacing, x])

  const MIN_DRAG_RATIO = 0.3 // fraction of spacing (reduced for sensitivity)
  const MIN_VELOCITY_PX_MS = 0.3 // swipe speed threshold

  const handleDragStart = () => {
    dragStartX.current = x.get()
    lastDragX.current = dragStartX.current
    dragStartTime.current = performance.now()
  }

  const handleDragEnd = () => {
    const endX = x.get()
    const delta = endX - dragStartX.current
    const durationMs = Math.max(performance.now() - dragStartTime.current, 1)
    const velocity = delta / durationMs // px per ms

    let targetIndex = selectedIndex
    const dragThreshold = spacing * MIN_DRAG_RATIO

    if (spacing > 0) {
      if (delta < -dragThreshold || velocity < -MIN_VELOCITY_PX_MS) {
        // swipe left -> next (clamp at upper bound)
        targetIndex = Math.min(selectedIndex + 1, charactersLength - 1)
      } else if (delta > dragThreshold || velocity > MIN_VELOCITY_PX_MS) {
        // swipe right -> prev (clamp at lower bound)
        targetIndex = Math.max(selectedIndex - 1, 0)
      } else {
        // fallback to nearest index without wrapping
        const calculatedIndex = Math.round(-endX / spacing)
        targetIndex = Math.min(
          Math.max(calculatedIndex, 0),
          charactersLength - 1,
        )
      }
    }

    if (targetIndex !== selectedIndex) {
      onSelectionChange(targetIndex)
    }

    animate(x, -targetIndex * spacing, {
      type: "spring",
      stiffness: 300,
      damping: 30,
    })
  }

  // Disable hard constraints to allow continuity in perception; still limit visually via snapping
  const dragConstraints = false

  return {
    x,
    spacing,
    handleDragStart,
    handleDragEnd,
    dragConstraints,
  }
}
</file>

<file path="src/components/Welcome/hooks/useWelcomeContent.js">
import { useTranslation } from "react-i18next"

import { STEP } from "../constants"

export function useWelcomeContent(
  step,
  showIntro,
  currentCharacterIndex,
  data,
) {
  const { t } = useTranslation()
  const { charactersData, characterOverviewData } = data

  const getContent = () => {
    if (step === STEP.INTRO) {
      return {
        headline: t("welcome.title"),
        subHeadline: t("welcome.subtitle"),
        description: {
          title: "",
          text: t("welcome.description"),
        },
        navigationMode: "single",
      }
    } else if (step === STEP.CHARACTER && showIntro) {
      // Use CMS data - it's localized based on current language
      return {
        headline: characterOverviewData?.title,
        subHeadline: characterOverviewData?.siteName,
        description: {
          title: "",
          text: characterOverviewData?.onboarding
            ? characterOverviewData.onboarding.replace(/<[^>]*>/g, "")
            : "",
        },
        navigationMode: "single",
      }
    } else if (
      step === STEP.CHARACTER &&
      !showIntro &&
      charactersData &&
      charactersData[currentCharacterIndex]
    ) {
      const character = charactersData[currentCharacterIndex]
      return {
        headline: character.name,
        subHeadline: character.characterType || character.role,
        description: {
          title: "",
          text: character.description.replace(/<[^>]*>/g, ""),
        },
        navigationMode: "double",
      }
    }
  }

  return getContent() || {}
}
</file>

<file path="src/hooks/useFetchPosts.js">
export default function useFetchPosts() {
  throw new Error("useFetchPosts has been removed")
}
</file>

<file path="src/hooks/useGallery.js">
import { API_BASE_URL } from "@/config/api"
import { useQuery } from "@tanstack/react-query"

export const useGalleryImages = (options = {}) => {
  const { enabled = true } = options

  return useQuery({
    queryKey: ["gallery-images"],
    queryFn: async () => {
      const response = await fetch(`${API_BASE_URL}/gallery/all-images/`)

      if (!response.ok) {
        throw new Error(`Failed to fetch gallery images: ${response.status}`)
      }

      return response.json()
    },
    enabled,
    staleTime: 5 * 60 * 1000,
    cacheTime: 10 * 60 * 1000,
  })
}
</file>

<file path="src/hooks/useHistoryNavigation.js">
import { useEffect, useRef, useState } from "react"

export default function useHistoryNavigation(initialPage = "welcome") {
  const [currentPage, setCurrentPage] = useState(initialPage)
  const basePathRef = useRef(import.meta.env.BASE_URL || "/")

  const getFullPath = (page) => {
    const base = basePathRef.current.endsWith("/")
      ? basePathRef.current.slice(0, -1)
      : basePathRef.current
    return `${base}/${page}`
  }

  const navigateToPage = (page) => {
    setCurrentPage(page)
    window.history.pushState({ page }, "", getFullPath(page))
  }

  useEffect(() => {
    window.history.replaceState(
      { page: initialPage },
      "",
      getFullPath(initialPage),
    )

    const handlePopState = (event) => {
      if (event.state?.page) {
        setCurrentPage(event.state.page)
      }
    }

    window.addEventListener("popstate", handlePopState)

    return () => {
      window.removeEventListener("popstate", handlePopState)
    }
  }, [initialPage])

  return [currentPage, navigateToPage]
}
</file>

<file path="src/hooks/useLocalizedQuery.js">
import { fetchAllLocalesContent, getContentForLocale } from "@/api/djangoApi"
import { DEFAULT_LANGUAGE } from "@/config/language"
import { useQuery } from "@tanstack/react-query"
import { useTranslation } from "react-i18next"

export const useLocalizedQuery = (options) => {
  const { i18n } = useTranslation()
  const currentLocale = i18n.language || DEFAULT_LANGUAGE

  const localizedOptions = {
    ...options,
    queryKey: [...(options.queryKey || []), "locale", currentLocale],
    queryFn: async () => {
      const allLocalesContent = await fetchAllLocalesContent()
      const localeContent = getContentForLocale(
        allLocalesContent,
        currentLocale,
      )
      return options.queryFn
        ? await options.queryFn(localeContent)
        : localeContent
    },
  }

  return useQuery(localizedOptions)
}

export const useLocalizedContent = (queryFn, queryKey, options = {}) => {
  return useLocalizedQuery({
    queryFn,
    queryKey,
    ...options,
  })
}

export default useLocalizedQuery
</file>

<file path="src/hooks/useSupportedLanguages.js">
export {
  useLanguages as default,
  useLanguages,
} from "@/providers/LanguageProvider"
</file>

<file path="src/hooks/useUploadPost.js">
export default function useUploadPost() {
  throw new Error("useUploadPost has been removed")
}
</file>

<file path="src/utils/apiUtils.js">
export const MAX_SEARCH_DEPTH = 10

export const parseRichText = (richText) => {
  if (typeof richText === "string") return richText
  if (richText.text) return richText.text
  if (Array.isArray(richText)) {
    return richText
      .map((item) => {
        if (typeof item === "string") return item
        if (item.value) return item.value
        if (item.text) return item.text
        return String(item)
      })
      .join(" ")
  }
  return String(richText)
}

export const findContentByType = (localeContent, targetType) => {
  const welcome = localeContent[0]

  const searchHierarchy = (children, depth = 0) => {
    if (depth > MAX_SEARCH_DEPTH) return null
    for (const child of children) {
      if (
        child.__typename === targetType ||
        child.title === targetType ||
        child.title?.includes(targetType.replace(/([A-Z])/g, " $1").trim())
      ) {
        return child
      }
      if (child.children?.length > 0) {
        const found = searchHierarchy(child.children, depth + 1)
        if (found) return found
      }
    }
    return null
  }

  return searchHierarchy(welcome.children)
}

export const navigateToScreen = (localeContent, targetType) => {
  const welcome = localeContent[0]
  const characterOverview = welcome.children.find(
    (child) =>
      child.title === "Character Overview" ||
      child.__typename === "CharacterOverview",
  )

  const chooseCharacter = characterOverview.children[0]
  const introSearchAndCollect = chooseCharacter.children[0]
  const photographyScreen = introSearchAndCollect.children[0]
  const yourCollection = photographyScreen.children[0]

  if (targetType === "PerspectiveScreen") {
    return yourCollection.children.find(
      (child) =>
        child.title === "Perspective Screen" ||
        child.__typename === "PerspectiveScreen",
    )
  }

  if (targetType === "EndingScreen") {
    const perspectiveScreen = yourCollection.children.find(
      (child) =>
        child.title === "Perspective Screen" ||
        child.__typename === "PerspectiveScreen",
    )
    return perspectiveScreen.children.find(
      (child) =>
        child.title === "Ending Screen" || child.__typename === "EndingScreen",
    )
  }

  return null
}

export const transformScreenData = (
  screenData,
  fallbackTitle = "",
  fallbackDescription = "",
) => {
  return {
    id: screenData.id,
    title: screenData.heading || screenData.title || fallbackTitle,
    description: parseRichText(screenData.description) || fallbackDescription,
    backgroundImage: screenData.backgroundImage,
    locale: screenData.locale || "en",
  }
}

export const handleApiError = (error, context = "API request") => {
  let userMessage = "An unexpected error occurred"
  let errorCode = "UNKNOWN_ERROR"

  if (error.name === "NetworkError" || error.message.includes("fetch")) {
    userMessage =
      "Network connection failed. Please check your internet connection."
    errorCode = "NETWORK_ERROR"
  } else if (error.message.includes("404")) {
    userMessage =
      "Content not found. The requested information is not available."
    errorCode = "NOT_FOUND"
  } else if (error.message.includes("500")) {
    userMessage = "Server error. Please try again later."
    errorCode = "SERVER_ERROR"
  } else if (error.message.includes("timeout")) {
    userMessage = "Request timed out. Please try again."
    errorCode = "TIMEOUT"
  }

  return {
    message: userMessage,
    code: errorCode,
    originalError: error,
    context,
  }
}

export const processImageUrl = (imageData, baseUrl = "") => {
  const imageUrl = imageData.file

  if (imageUrl.startsWith("http://") || imageUrl.startsWith("https://")) {
    return imageUrl
  }

  if (baseUrl && imageUrl.startsWith("/")) {
    return baseUrl + imageUrl
  }

  return imageUrl
}

export const delay = (ms) => new Promise((resolve) => setTimeout(resolve, ms))

export const retryWithBackoff = async (
  fn,
  maxAttempts = 3,
  baseDelay = 1000,
) => {
  let lastError

  for (let attempt = 1; attempt <= maxAttempts; attempt++) {
    try {
      return await fn()
    } catch (error) {
      lastError = error

      if (attempt === maxAttempts) {
        throw error
      }

      const delayTime = baseDelay * Math.pow(2, attempt - 1)
      await delay(delayTime)
    }
  }

  throw lastError
}
</file>

<file path=".env.example">
# API Configuration
# API base URL is now automatically configured based on environment:
# - Development (npm run dev): http://localhost:8080
# - Production/Staging: /cms/api
#
# This is configured in src/config/api.js
# You can override it by uncommenting the line below:
# VITE_API_BASE_URL=http://localhost:8080

# For production, examples:
# VITE_API_BASE_URL=/cms/api                    (same domain, CMS under /cms)
# VITE_API_BASE_URL=https://api.yourdomain.com  (different subdomain)

# For staging, set to your staging API URL:
# VITE_API_BASE_URL=https://your-staging-api.com

# Environment Variables for Migration

# Main architecture flag - enables full new architecture
REACT_APP_NEW_ARCH=false

# Component-specific migration flags
# Enable these one by one during migration
REACT_APP_NEW_CHARACTER_SHOWCASE=false
REACT_APP_NEW_INTRODUCTION=false
REACT_APP_NEW_PHOTO_CAPTURE=false
REACT_APP_NEW_GALLERY=false

# Layout enhancement flags
REACT_APP_ENHANCED_MAIN_LAYOUT=false

# Development and debugging flags
REACT_APP_MIGRATION_LOGGING=false
REACT_APP_PERF_MONITORING=false

# Example configuration for testing CharacterShowcase migration:
# REACT_APP_NEW_CHARACTER_SHOWCASE=true
# REACT_APP_MIGRATION_LOGGING=true
# REACT_APP_PERF_MONITORING=true
</file>

<file path="public/locales/de/translation.json">
{
  "navigation": {
    "next": "Weiter",
    "previous": "Zurück",
    "close": "Schließen",
    "select": "Auswählen"
  },
  "welcome": {
    "title": "Willkommen",
    "subtitle": "La Nau",
    "description": "Erleben Sie dieses Monument mit neuen Augen"
  },
  "introduction": {
    "title": "Wählen Sie Ihren Führer",
    "description": "Wählen Sie Ihren Führer für diese immersive Reise durch La Nau."
  },
  "photoCapture": {
    "title": "Rahmen Sie Ihre Perspektive",
    "tasks": {
      "laNau": "La Nau",
      "surroundings": "Ihre Umgebung",
      "special": "Etwas Besonderes"
    },
    "buttons": {
      "takePhoto": "Foto machen",
      "gallery": "Galerie",
      "retake": "Wiederholen"
    },
    "metadata": {
      "title": "Details zu Ihrem Foto hinzufügen",
      "comment": "Kommentar (optional)",
      "commentPlaceholder": "Teilen Sie Ihre Gedanken zu diesem Foto...",
      "username": "Ihr Name (optional)",
      "usernamePlaceholder": "Geben Sie Ihren Namen ein",
      "save": "Speichern",
      "skip": "Überspringen"
    }
  },
  "exploration": {
    "title": "Schau, was ich gefunden habe,",
    "content": {
      "stone1": "Steine mit vielen kleinen Poren (wie Kalkstein), die häufig in alten Monumenten zu finden sind, sind anfälliger für Korrosion, da sie wie kleine Schwämme wirken!",
      "stone2": "Diese porösen Steine absorbieren Feuchtigkeit, Schadstoffe und sogar sauren Regen leichter als dichtere Steine, dieser Mechanismus beschleunigt die Verwitterung.",
      "stone3": "Während ein Monument stark und solide aussehen mag, kämpft es, wenn es aus porösem Stein besteht, tatsächlich jeden Tag einen geheimen Kampf!"
    }
  },
  "perspective": {
    "title": "Ihre Perspektive",
    "description": "Sie haben das Monument mit neuen Augen gesehen. Fügen Sie nun Ihre Vision zu einer lebendigen Collage hinzu, zusammen mit anderen, denen es genauso wichtig ist wie Ihnen.",
    "loading": "Lade Ihre personalisierte Perspektive...",
    "fallback": "Erleben Sie diese einzigartige Perspektive von La Nau",
    "success": "Personalisierte Inhalte erfolgreich geladen"
  },
  "upload": {
    "title": "Sammlung hochladen",
    "question": "Möchten Sie die Sammlung hochladen?",
    "questionWithCharacter": "{{description}} Ihre Fotos werden zu {{character}}s Sammlung hinzugefügt.",
    "noImages": "Keine Bilder zum Hochladen. Bitte machen Sie zuerst einige Fotos.",
    "noCharacterSelected": "Bitte wählen Sie einen Charakter aus, bevor Sie Ihre Fotos hochladen.",
    "buttons": {
      "yes": "Ja",
      "no": "Nein",
      "uploading": "Wird hochgeladen...",
      "retry": "Upload wiederholen",
      "pleaseWait": "Bitte warten...",
      "selectCharacter": "Charakter zuerst auswählen"
    },
    "status": {
      "preparing": "Vorbereitung",
      "uploading": "Wird hochgeladen",
      "uploadingToCharacter": "{{count}} Bilder werden zu {{character}}s Sammlung hochgeladen...",
      "uploadProgress": "{{current}} von {{total}} Bildern zu {{character}}s Sammlung hochgeladen",
      "success": "Upload erfolgreich",
      "error": "Upload fehlgeschlagen",
      "allComplete": "Alle Uploads erfolgreich abgeschlossen!",
      "allCompleteForCharacter": "Alle Uploads für {{character}} erfolgreich abgeschlossen!",
      "partialSuccess": "{{successful}} von {{total}} Uploads abgeschlossen. {{failed}} fehlgeschlagen.",
      "someFailedRetry": "Upload(s) fehlgeschlagen"
    },
    "missing": "Fehlt"
  },
  "gallery": {
    "title": "Galerie",
    "clickImage": "Klicken Sie auf ein Bild",
    "exitGallery": "Galerie verlassen"
  },
  "ending": {
    "title": "Vielen Dank",
    "description": "Vielen Dank, dass Sie zu diesem Monument beigetragen und es am Leben erhalten haben. Schauen Sie sich nun weiter in La Nau um.",
    "loading": "Ihre Reise wird abgeschlossen...",
    "celebration": "Ihr Beitrag wurde aufgezeichnet!",
    "thankYouMessage": "Vielen Dank, dass Sie Teil dieser kulturellen Erhaltungsreise sind!",
    "completionMessage": "Reise abgeschlossen - Ihre Erfahrung wurde personalisiert",
    "preservationNote": "Ihr Beitrag wird helfen, dieses Monument für zukünftige Generationen zu bewahren"
  },
  "errors": {
    "unknown": "Unbekannter Fehler",
    "uploadFailed": "Upload fehlgeschlagen",
    "networkError": "Netzwerkfehler aufgetreten",
    "unexpectedError": "Unerwarteter Fehler aufgetreten",
    "contentLoadFailed": "Personalisierte Inhalte konnten nicht geladen werden",
    "imageLoadFailed": "Hintergrundbild konnte nicht geladen werden",
    "noCharacterSelected": "Kein Charakter ausgewählt. Bitte wählen Sie zuerst einen Charakter aus.",
    "characterNotFound": "Charakter '{{character}}' wurde auf dem Server nicht gefunden. Bitte versuchen Sie, einen anderen Charakter auszuwählen."
  },
  "loading": {
    "default": "Wird geladen...",
    "content": "Inhalte werden geladen...",
    "images": "Bilder werden geladen...",
    "perspective": "Ihre Perspektive wird geladen...",
    "ending": "Ihre Reise wird finalisiert...",
    "characters": "Charaktere werden geladen..."
  }
}
</file>

<file path="public/locales/en/translation.json">
{
  "navigation": {
    "next": "Next",
    "previous": "Previous",
    "close": "Close",
    "select": "Select"
  },
  "welcome": {
    "title": "Welcome",
    "subtitle": "La Nau",
    "description": "Experience this monument through new eyes"
  },
  "introduction": {
    "title": "Choose your guide",
    "description": "Select your guide for this immersive journey through La Nau."
  },
  "photoCapture": {
    "title": "Frame your perspective",
    "tasks": {
      "laNau": "La Nau",
      "surroundings": "Your surroundings",
      "special": "Something special"
    },
    "buttons": {
      "takePhoto": "Take Photo",
      "gallery": "Gallery",
      "retake": "Retake"
    },
    "metadata": {
      "title": "Add details for your photo",
      "comment": "Comment (optional)",
      "commentPlaceholder": "Share your thoughts about this photo...",
      "username": "Your name (optional)",
      "usernamePlaceholder": "Enter your name",
      "save": "Save",
      "skip": "Skip"
    }
  },
  "exploration": {
    "title": "Look, what I've found,",
    "content": {
      "stone1": "Stones with lots of tiny pores (like limestone), frequently found in ancient monuments are more vulnerable to corrosion because they act like little sponges!",
      "stone2": "These porous stones absorb moisture, pollutants, and even acidic rain more easily than denser stones, this mechanism speeds up weathering.",
      "stone3": "So, while a monument may look strong and solid, if it's made of porous stone, it's actually fighting a secret battle everyday!"
    }
  },
  "perspective": {
    "title": "Your Perspective",
    "description": "You've seen the monument through new eyes. Now, add your vision to a living collage, together with others who care, just like you.",
    "loading": "Loading your personalized perspective...",
    "fallback": "Experience this unique perspective of La Nau",
    "success": "Personalized content loaded successfully"
  },
  "upload": {
    "title": "Upload Collection",
    "question": "Do you want to upload collection?",
    "questionWithCharacter": "{{description}} Your photos will be added to {{character}}'s collection.",
    "noImages": "No images to upload. Please take some photos first.",
    "noCharacterSelected": "Please select a character before uploading your photos.",
    "buttons": {
      "yes": "Yes",
      "no": "No",
      "uploading": "Uploading...",
      "retry": "Retry Upload",
      "pleaseWait": "Please wait...",
      "selectCharacter": "Select Character First"
    },
    "status": {
      "preparing": "Preparing",
      "uploading": "Uploading",
      "uploadingToCharacter": "Uploading {{count}} images to {{character}}'s collection...",
      "uploadProgress": "Uploaded {{current}} of {{total}} images to {{character}}'s collection",
      "success": "Upload successful",
      "error": "Upload failed",
      "allComplete": "All uploads completed successfully!",
      "allCompleteForCharacter": "All uploads completed successfully for {{character}}!",
      "partialSuccess": "{{successful}} of {{total}} uploads completed. {{failed}} failed.",
      "someFailedRetry": "upload(s) failed"
    },
    "missing": "Missing"
  },
  "gallery": {
    "title": "Gallery",
    "clickImage": "Click an image",
    "exitGallery": "Exit Gallery"
  },
  "ending": {
    "title": "Thank You",
    "description": "Thank you for contributing to this monument and keeping it alive. Now take a further look around La Nau.",
    "loading": "Completing your journey...",
    "celebration": "Your contribution has been recorded!",
    "thankYouMessage": "Thank you for being part of this cultural preservation journey!",
    "completionMessage": "Journey complete - Your experience has been personalized",
    "preservationNote": "Your contribution will help preserve this monument for future generations"
  },
  "errors": {
    "unknown": "Unknown error",
    "uploadFailed": "Upload failed",
    "networkError": "Network error occurred",
    "unexpectedError": "Unexpected error occurred",
    "contentLoadFailed": "Failed to load personalized content",
    "imageLoadFailed": "Background image could not be loaded",
    "noCharacterSelected": "No character selected. Please select a character first.",
    "characterNotFound": "Character '{{character}}' not found on server. Please try selecting a different character."
  },
  "loading": {
    "default": "Loading...",
    "content": "Loading content...",
    "images": "Loading images...",
    "perspective": "Loading your perspective...",
    "ending": "Finalizing your journey...",
    "characters": "Loading characters..."
  }
}
</file>

<file path="public/locales/es/translation.json">
{
  "navigation": {
    "next": "Siguiente",
    "previous": "Anterior",
    "close": "Cerrar",
    "select": "Seleccionar"
  },
  "welcome": {
    "title": "Bienvenido",
    "subtitle": "La Nau",
    "description": "Experimenta este monumento con nuevos ojos"
  },
  "introduction": {
    "title": "Elige tu guía",
    "description": "Selecciona tu guía para este viaje inmersivo a través de La Nau."
  },
  "photoCapture": {
    "title": "Encuadra tu perspectiva",
    "tasks": {
      "laNau": "La Nau",
      "surroundings": "Tus alrededores",
      "special": "Algo especial"
    },
    "buttons": {
      "takePhoto": "Tomar foto",
      "gallery": "Galería",
      "retake": "Repetir"
    },
    "metadata": {
      "title": "Añade detalles a tu foto",
      "comment": "Comentario (opcional)",
      "commentPlaceholder": "Comparte tus pensamientos sobre esta foto...",
      "username": "Tu nombre (opcional)",
      "usernamePlaceholder": "Ingresa tu nombre",
      "save": "Guardar",
      "skip": "Omitir"
    }
  },
  "exploration": {
    "title": "Mira lo que encontré,",
    "content": {
      "stone1": "Las piedras con muchos poros pequeños (como la piedra caliza), frecuentemente encontradas en monumentos antiguos, son más vulnerables a la corrosión porque actúan como pequeñas esponjas!",
      "stone2": "Estas piedras porosas absorben humedad, contaminantes e incluso lluvia ácida más fácilmente que las piedras más densas, este mecanismo acelera la meteorización.",
      "stone3": "Entonces, aunque un monumento pueda verse fuerte y sólido, si está hecho de piedra porosa, en realidad está luchando una batalla secreta todos los días!"
    }
  },
  "perspective": {
    "title": "Tu Perspectiva",
    "description": "Has visto el monumento con nuevos ojos. Ahora, añade tu visión a un collage viviente, junto con otros que se preocupan, igual que tú."
  },
  "upload": {
    "title": "Subir colección",
    "question": "¿Quieres subir la colección?",
    "questionWithCharacter": "{{description}} Tus fotos se añadirán a la colección de {{character}}.",
    "noImages": "No hay imágenes para subir. Por favor toma algunas fotos primero.",
    "noCharacterSelected": "Por favor selecciona un personaje antes de subir tus fotos.",
    "buttons": {
      "yes": "Sí",
      "no": "No",
      "uploading": "Subiendo...",
      "retry": "Reintentar subida",
      "pleaseWait": "Por favor espera...",
      "selectCharacter": "Seleccionar personaje primero"
    },
    "status": {
      "preparing": "Preparando",
      "uploading": "Subiendo",
      "uploadingToCharacter": "Subiendo {{count}} imágenes a la colección de {{character}}...",
      "uploadProgress": "Subidas {{current}} de {{total}} imágenes a la colección de {{character}}",
      "success": "Subida exitosa",
      "error": "Error en la subida",
      "allComplete": "¡Todas las subidas completadas exitosamente!",
      "allCompleteForCharacter": "¡Todas las subidas completadas exitosamente para {{character}}!",
      "partialSuccess": "{{successful}} de {{total}} subidas completadas. {{failed}} fallaron.",
      "someFailedRetry": "subida(s) fallida(s)"
    },
    "missing": "Faltante"
  },
  "gallery": {
    "title": "Galería",
    "clickImage": "Haz clic en una imagen",
    "exitGallery": "Salir de la galería"
  },
  "ending": {
    "title": "Gracias",
    "description": "Gracias por contribuir a este monumento y mantenerlo vivo. Ahora echa un vistazo más profundo alrededor de La Nau."
  },
  "errors": {
    "unknown": "Error desconocido",
    "uploadFailed": "Error en la subida",
    "networkError": "Error de red ocurrido",
    "unexpectedError": "Error inesperado ocurrido",
    "contentLoadFailed": "Error al cargar contenido personalizado",
    "imageLoadFailed": "No se pudo cargar la imagen de fondo",
    "noCharacterSelected": "No se ha seleccionado ningún personaje. Por favor selecciona un personaje primero.",
    "characterNotFound": "Personaje '{{character}}' no encontrado en el servidor. Por favor intenta seleccionar un personaje diferente."
  },
  "loading": {
    "default": "Cargando...",
    "content": "Cargando contenido...",
    "images": "Cargando imágenes...",
    "perspective": "Cargando tu perspectiva...",
    "ending": "Finalizando tu viaje...",
    "characters": "Cargando personajes..."
  }
}
</file>

<file path="public/locales/fr/translation.json">
{
  "navigation": {
    "next": "Suivant",
    "previous": "Précédent",
    "close": "Fermer",
    "select": "Sélectionner"
  },
  "welcome": {
    "title": "Bienvenue",
    "subtitle": "La Nau",
    "description": "Découvrez ce monument avec de nouveaux yeux"
  },
  "introduction": {
    "title": "Choisissez votre guide",
    "description": "Sélectionnez votre guide pour ce voyage immersif à travers La Nau."
  },
  "photoCapture": {
    "title": "Cadrez votre perspective",
    "tasks": {
      "laNau": "La Nau",
      "surroundings": "Vos environs",
      "special": "Quelque chose de spécial"
    },
    "buttons": {
      "takePhoto": "Prendre une photo",
      "gallery": "Galerie",
      "retake": "Reprendre"
    },
    "metadata": {
      "title": "Ajouter des détails à votre photo",
      "comment": "Commentaire (facultatif)",
      "commentPlaceholder": "Partagez vos réflexions sur cette photo...",
      "username": "Votre nom (facultatif)",
      "usernamePlaceholder": "Entrez votre nom",
      "save": "Enregistrer",
      "skip": "Passer"
    }
  },
  "exploration": {
    "title": "Regardez ce que j'ai trouvé,",
    "content": {
      "stone1": "Les pierres avec beaucoup de petits pores (comme le calcaire), fréquemment trouvées dans les monuments anciens, sont plus vulnérables à la corrosion car elles agissent comme de petites éponges !",
      "stone2": "Ces pierres poreuses absorbent l'humidité, les polluants et même la pluie acide plus facilement que les pierres plus denses, ce mécanisme accélère l'altération.",
      "stone3": "Ainsi, bien qu'un monument puisse paraître fort et solide, s'il est fait de pierre poreuse, il mène en réalité une bataille secrète chaque jour !"
    }
  },
  "perspective": {
    "title": "Votre Perspective",
    "description": "Vous avez vu le monument avec de nouveaux yeux. Maintenant, ajoutez votre vision à un collage vivant, avec d'autres qui s'en soucient, tout comme vous."
  },
  "upload": {
    "title": "Télécharger la collection",
    "question": "Voulez-vous télécharger la collection ?",
    "questionWithCharacter": "{{description}} Vos photos seront ajoutées à la collection de {{character}}.",
    "noImages": "Aucune image à télécharger. Veuillez d'abord prendre quelques photos.",
    "noCharacterSelected": "Veuillez sélectionner un personnage avant de télécharger vos photos.",
    "buttons": {
      "yes": "Oui",
      "no": "Non",
      "uploading": "Téléchargement en cours...",
      "retry": "Réessayer le téléchargement",
      "pleaseWait": "Veuillez patienter...",
      "selectCharacter": "Sélectionner un personnage d'abord"
    },
    "status": {
      "preparing": "Préparation",
      "uploading": "Téléchargement",
      "uploadingToCharacter": "Téléchargement de {{count}} images vers la collection de {{character}}...",
      "uploadProgress": "{{current}} sur {{total}} images téléchargées vers la collection de {{character}}",
      "success": "Téléchargement réussi",
      "error": "Échec du téléchargement",
      "allComplete": "Tous les téléchargements terminés avec succès !",
      "allCompleteForCharacter": "Tous les téléchargements terminés avec succès pour {{character}} !",
      "partialSuccess": "{{successful}} sur {{total}} téléchargements terminés. {{failed}} ont échoué.",
      "someFailedRetry": "téléchargement(s) échoué(s)"
    },
    "missing": "Manquant"
  },
  "gallery": {
    "title": "Galerie",
    "clickImage": "Cliquez sur une image",
    "exitGallery": "Quitter la galerie"
  },
  "ending": {
    "title": "Merci",
    "description": "Merci d'avoir contribué à ce monument et de l'avoir maintenu en vie. Maintenant, jetez un coup d'œil plus approfondi autour de La Nau."
  },
  "errors": {
    "unknown": "Erreur inconnue",
    "uploadFailed": "Échec du téléchargement",
    "networkError": "Erreur réseau survenue",
    "unexpectedError": "Erreur inattendue survenue",
    "contentLoadFailed": "Échec du chargement du contenu personnalisé",
    "imageLoadFailed": "L'image d'arrière-plan n'a pas pu être chargée",
    "noCharacterSelected": "Aucun personnage sélectionné. Veuillez d'abord sélectionner un personnage.",
    "characterNotFound": "Personnage '{{character}}' non trouvé sur le serveur. Veuillez essayer de sélectionner un personnage différent."
  },
  "loading": {
    "default": "Chargement...",
    "content": "Chargement du contenu...",
    "images": "Chargement des images...",
    "perspective": "Chargement de votre perspective...",
    "ending": "Finalisation de votre parcours...",
    "characters": "Chargement des personnages..."
  }
}
</file>

<file path="src/components/Exploration/styles.js">
import { motion } from "motion/react"
import { styled } from "styled-components"

import IntroductionBackground from "./IntroductionBackground.png"

export const IntroductionContainer = styled.div`
  position: relative;
  width: 100%;
  height: 100vh;
  overflow-y: auto;
  overflow-x: hidden;
  background-image: url(${IntroductionBackground});
  background-size: contain;
  background-position: center;
  background-repeat: no-repeat;
`

export const CharacterImageContainer = styled.div`
  position: absolute;
  top: 0;
  right: 0;
  z-index: 1;
`

export const CharacterImage = styled.img`
  width: 100%;
  height: 100%;
  object-fit: contain;
`

export const ContentContainer = styled(motion.div)`
  position: absolute;
  top: 31.3125rem;
  left: 50%;
  display: flex;
  width: 90%;
  height: 80.5625rem;
  padding: 1.75rem 1.5rem;
  flex-direction: column;
  align-items: flex-start;
  gap: 2rem;
  flex-shrink: 0;
  border-radius: 1.75rem 1.75rem;
  margin-bottom: 3rem;
  background: #f1ece1;
  z-index: 2;
`

export const Headline = styled.h1`
  color: #000;
  font-size: 1.5rem;
  font-style: normal;
  font-weight: 600;
  line-height: 94%;
  margin: 0;
`

export const TextBlock = styled.p`
  color: #000;
  font-size: 1rem;
  font-style: normal;
  font-weight: 400;
  line-height: normal;
  letter-spacing: -0.01rem;
  height: 6.125rem;
  flex-shrink: 0;
  align-self: stretch;
  margin: 0;
  white-space: pre-line;
`

export const Image = styled.img`
  width: 18.4375rem;
  height: 13.4375rem;
  border-radius: 1.75rem;
`

export const CameraButtonContainer = styled.div`
  display: flex;
  height: 7.1875rem;
  padding: 1.75rem 0;
  flex-direction: column;
  justify-content: flex-end;
  align-items: center;
  flex-shrink: 0;
  align-self: stretch;
`
</file>

<file path="src/components/Gallery/helpers.js">
export const getPersistedPersonalImages = (defaults, capturedImages = []) => {
  if (Array.isArray(capturedImages) && capturedImages.some(Boolean)) {
    return defaults.map((d, i) => capturedImages[i] || d)
  }
  return defaults
}

export const buildImagePoolFromGlob = (globObj) => {
  const entries = Object.entries(globObj)
  entries.sort(([a], [b]) => a.localeCompare(b))
  return entries.map(([, url]) => url)
}

export const formatUploadedImagesForGallery = (uploadedImages = []) => {
  return uploadedImages.reduce((accumulator, item) => {
    const source = item?.image?.url || item?.image?.file

    if (source) {
      accumulator.push(source)
    }

    return accumulator
  }, [])
}

export const buildCombinedImagePool = (cologneGlobObj, uploadedImages = []) => {
  const cologneImages = buildImagePoolFromGlob(cologneGlobObj)
  const uploadedImageUrls = formatUploadedImagesForGallery(uploadedImages)

  return {
    cologne: cologneImages,
    uploaded: uploadedImageUrls,
    combined: [...cologneImages, ...uploadedImageUrls],
    stats: {
      cologneCount: cologneImages.length,
      uploadedCount: uploadedImageUrls.length,
      totalCount: cologneImages.length + uploadedImageUrls.length,
    },
  }
}
</file>

<file path="src/components/PhotoCapture/hooks/usePhotoTasks.js">
// Simplified usePhotoTasks hook with memory storage only
import { useCallback, useMemo, useState } from "react"
import { useTranslation } from "react-i18next"

export default function usePhotoTasks(options = {}) {
  const { tasks: providedTasks, onImageCaptured, initialImages = [] } = options
  const { t } = useTranslation()

  // Create tasks array with translations
  const tasks = useMemo(() => {
    if (providedTasks && providedTasks.length > 0) {
      return providedTasks
    }
    return [
      t("photoCapture.tasks.laNau"),
      t("photoCapture.tasks.surroundings"),
      t("photoCapture.tasks.special"),
    ]
  }, [providedTasks, t])

  // Simple memory-based state
  const [currentTaskIndex, setCurrentTaskIndex] = useState(0)
  const [taskImages, setTaskImages] = useState(() => {
    // Initialize from initial images if provided
    const initial = {}
    initialImages.forEach((image, index) => {
      if (image) initial[index] = image
    })
    return initial
  })

  const compressImageFile = useCallback(async (file) => {
    const MAX_DIMENSION = 1600
    const TARGET_MIME = "image/jpeg"
    const QUALITY = 0.75

    return new Promise((resolve, reject) => {
      try {
        const img = new Image()
        const objectUrl = URL.createObjectURL(file)

        img.onload = () => {
          try {
            const { width, height } = img
            const scale = Math.min(1, MAX_DIMENSION / Math.max(width, height))
            const targetW = Math.round(width * scale)
            const targetH = Math.round(height * scale)

            const canvas = document.createElement("canvas")
            canvas.width = targetW
            canvas.height = targetH

            const ctx = canvas.getContext("2d")
            ctx.drawImage(img, 0, 0, targetW, targetH)

            const dataUrl = canvas.toDataURL(TARGET_MIME, QUALITY)
            URL.revokeObjectURL(objectUrl)
            resolve(dataUrl)
          } catch (e) {
            URL.revokeObjectURL(objectUrl)
            reject(e)
          }
        }

        img.onerror = () => {
          URL.revokeObjectURL(objectUrl)
          // Fallback: just read the file as data URL without compression
          const reader = new FileReader()
          reader.onload = () => resolve(reader.result)
          reader.onerror = reject
          reader.readAsDataURL(file)
        }

        img.src = objectUrl
      } catch (e) {
        reject(e)
      }
    })
  }, [])

  const addImageForCurrentTask = useCallback(
    (dataUrl) => {
      setTaskImages((prev) => ({
        ...prev,
        [currentTaskIndex]: dataUrl,
      }))

      // Notify parent component
      if (onImageCaptured) {
        onImageCaptured(dataUrl, currentTaskIndex)
      }

      // Auto-advance to next task if not at the end
      if (currentTaskIndex < tasks.length - 1) {
        setCurrentTaskIndex((prev) => prev + 1)
      }
    },
    [currentTaskIndex, tasks.length, onImageCaptured],
  )

  const handleFileObject = useCallback(
    async (file) => {
      const dataUrl = await compressImageFile(file)
      addImageForCurrentTask(dataUrl)
      return dataUrl
    },
    [addImageForCurrentTask, compressImageFile],
  )

  const retake = useCallback((taskIndex) => {
    setTaskImages((prev) => {
      const next = { ...prev }
      delete next[taskIndex]
      return next
    })
    setCurrentTaskIndex(taskIndex)
  }, [])

  // Get all images as an array for upload
  const getAllImages = useCallback(() => {
    return tasks.map((_, index) => taskImages[index] || null)
  }, [tasks, taskImages])

  // Check if all tasks are completed
  const isComplete = useMemo(() => {
    return tasks.every((_, index) => taskImages[index])
  }, [tasks, taskImages])

  return {
    tasks,
    taskImages,
    currentTaskIndex,
    setCurrentTaskIndex,
    addImageForCurrentTask,
    handleFileObject,
    retake,
    getAllImages,
    isComplete,
  }
}
</file>

<file path="src/components/UI/Navigation.jsx">
import { forwardRef } from "react"
import { styled } from "styled-components"

import Button from "@ui/Button"
import IconButton from "@ui/IconButton"

const NavigationContainer = styled.div`
  display: flex;
  width: 90%;
  height: 7.3125rem;
  flex-shrink: 0;
  z-index: 10;
  margin: 0 auto;
  position: ${({ $position }) => ($position === "bottom" ? "fixed" : "static")};
  ${({ $position }) =>
    $position === "bottom" &&
    `
      left: 50%;
      transform: translateX(-50%);
      bottom: 0.75rem;
      pointer-events: none;
      & > * { pointer-events: auto; }
    `};

  ${({ $mode }) => {
    switch ($mode) {
      case "single":
        return `
          padding: 1.9375rem 0;
          justify-content: center;
          align-items: center;
        `
      case "horizontal":
        return `
          padding: 2rem 0 1.875rem 0;
          justify-content: space-between;
          align-items: center;
        `
      case "select":
        return `
          padding: 2rem 0 1.875rem 0;
          justify-content: space-between;
          align-items: center;
        `
      default:
        return `
          padding: 1.9375rem 1.5625rem;
          justify-content: center;
          align-items: flex-start;
          gap: 14.5625rem;
        `
    }
  }}
  /* Ensure container never sits flush off-screen when not using fixed bottom mode */
  margin-bottom: env(safe-area-inset-bottom, 0);
`

const Navigation = forwardRef(function Navigation(
  {
    mode,
    singleButtonVariant,
    position,
    selectLabel,
    iconColor,
    onSelect,
    onNext,
    onPrev,
    className,
    prevDisabled,
    nextDisabled,
    ...rest
  },
  ref,
) {
  const navigationMode = mode || "horizontal"
  const buttonVariant = singleButtonVariant || "arrowDown"
  const navPosition = position || "bottom"
  const label = selectLabel || "Select"

  if (navigationMode === "single") {
    return (
      <NavigationContainer
        ref={ref}
        $mode="single"
        $position={navPosition}
        className={className}
        {...rest}
      >
        <IconButton
          variant={buttonVariant}
          onClick={onSelect}
          color={iconColor}
        />
      </NavigationContainer>
    )
  }

  if (navigationMode === "select") {
    return (
      <NavigationContainer
        ref={ref}
        $mode="select"
        $position={navPosition}
        className={className}
        {...rest}
      >
        <IconButton
          variant="arrowLeft"
          onClick={prevDisabled ? undefined : onPrev}
          disabled={prevDisabled}
          color={iconColor}
        />
        <Button onClick={onSelect}>{label}</Button>
        <IconButton
          variant="arrowRight"
          onClick={nextDisabled ? undefined : onNext}
          disabled={nextDisabled}
          color={iconColor}
        />
      </NavigationContainer>
    )
  }

  if (navigationMode === null) {
    return (
      <NavigationContainer
        ref={ref}
        $position={navPosition}
        className={className}
        {...rest}
      />
    )
  }

  return (
    <NavigationContainer
      ref={ref}
      $mode="horizontal"
      $position={navPosition}
      className={className}
      {...rest}
    >
      <IconButton
        variant="arrowLeft"
        onClick={prevDisabled ? undefined : onPrev}
        disabled={prevDisabled}
        color={iconColor}
      />
      <IconButton
        variant="arrowRight"
        onClick={nextDisabled ? undefined : onNext}
        disabled={nextDisabled}
        color={iconColor}
      />
    </NavigationContainer>
  )
})

export default Navigation
</file>

<file path="src/config/api.js">
const isDevelopment = import.meta.env.DEV

export const API_BASE_URL = isDevelopment
  ? "http://localhost:8080/api" // Direct to Django backend (bypasses Vite proxy)
  : "/cms/api" // Production: relative path

export const getApiConfig = () => ({
  baseUrl: API_BASE_URL,
  isDevelopment,
})
</file>

<file path="src/GlobalState.jsx">
import { createContext, useState } from "react"

export const StateContext = createContext()

export default function StateProvider({ children }) {
  const [currentCharacterIndex, setCurrentCharacterIndex] = useState(0)
  const [showModal, setShowModal] = useState(null)
  const [capturedImages, setCapturedImages] = useState([])

  function setCapturedImageAt(index, imageData) {
    setCapturedImages((prev) => {
      const next = [...prev]
      next[index] = imageData
      return next
    })
  }
  const clearCapturedImages = () => {
    setCapturedImages([])
  }

  const value = {
    currentCharacterIndex,
    setCurrentCharacterIndex,
    showModal,
    setShowModal,
    capturedImages,
    setCapturedImageAt,
    clearCapturedImages,
  }

  return <StateContext.Provider value={value}>{children}</StateContext.Provider>
}
</file>

<file path="vite.config.js">
import { resolve } from "path"
import eslintPlugin from "@nabla/vite-plugin-eslint"
import react from "@vitejs/plugin-react"
import { defineConfig } from "vite"
import webfontDownload from "vite-plugin-webfont-dl"

export default defineConfig(() => ({
  base: process.env.VITE_BASE_PATH || "/",
  plugins: [
    react({
      babel: {
        plugins: [
          ["babel-plugin-react-compiler"],
          ["babel-plugin-styled-components"],
        ],
      },
    }),
    eslintPlugin(),
    webfontDownload(
      [
        "https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,200..800&display=swap",
      ],
      {
        injectAsStyleTag: true,
        minifyCss: true,
        async: true,
        cache: true,
        proxy: false,
        subsetsAllowed: ["latin"],
      },
    ),
  ],

  resolve: {
    alias: {
      "@": resolve(__dirname, "./src"),
      "@components": resolve(__dirname, "./src/components"),
      "@hooks": resolve(__dirname, "./src/hooks"),
      "@api": resolve(__dirname, "./src/api"),
      "@ui": resolve(__dirname, "./src/components/UI"),
      "@theme": resolve(__dirname, "./src/theme"),
    },
  },

  server: {
    proxy: {
      "/api": {
        target: "http://localhost:8080",
        changeOrigin: true,
        secure: false,
        ws: true,
        configure: (proxy) => {
          proxy.on("error", (err) => {
            console.log("proxy error", err)
          })
          proxy.on("proxyReq", (_proxyReq, req) => {
            console.log("Sending Request to the Target:", req.method, req.url)
          })
          proxy.on("proxyRes", (proxyRes, req) => {
            console.log(
              "Received Response from the Target:",
              proxyRes.statusCode,
              req.url,
            )
          })
        },
      },
    },
  },
}))
</file>

<file path="src/api/hooks.js">
import { useLocalizedQuery } from "@/hooks/useLocalizedQuery"
import { useQuery } from "@tanstack/react-query"
import { useMemo } from "react"

import { fetchAll, fetchApiRoot } from "./djangoApi"

export const queryKeys = {
  apiRoot: ["django", "api-root"],
  all: ["django", "all-content"],
}

export const extractFromContentTree = {
  getWelcomeLanguage: (data) => {
    if (!data || !Array.isArray(data) || data.length === 0) return null
    return data[0]
  },

  getWelcomeIntro: (data) => {
    const welcomeLanguage = extractFromContentTree.getWelcomeLanguage(data)
    if (!welcomeLanguage?.children || welcomeLanguage.children.length === 0)
      return null
    return welcomeLanguage.children[0]
  },

  getWelcome: (data) => {
    const welcomeIntro = extractFromContentTree.getWelcomeIntro(data)
    if (!welcomeIntro?.children || welcomeIntro.children.length === 0)
      return null
    return welcomeIntro.children[0]
  },

  getCharacterOverview: (data) => {
    const welcome = extractFromContentTree.getWelcome(data)
    if (!welcome?.children || welcome.children.length === 0) return null
    return welcome.children[0]
  },

  getCharacters: (data) => {
    const characterOverview = extractFromContentTree.getCharacterOverview(data)
    if (!characterOverview?.children) return []
    return characterOverview.children
  },

  getCharacter: (data, index) => {
    const characters = extractFromContentTree.getCharacters(data)
    return characters[index] || null
  },

  getIntroduction: (data, characterIndex) => {
    const character = extractFromContentTree.getCharacter(data, characterIndex)
    if (!character?.children || character.children.length === 0) return null
    return character.children[0]
  },

  getPhotography: (data, characterIndex) => {
    const introduction = extractFromContentTree.getIntroduction(
      data,
      characterIndex,
    )
    if (!introduction?.children || introduction.children.length === 0)
      return null
    return introduction.children[0]
  },

  getExploration: (data, characterIndex) => {
    const photography = extractFromContentTree.getPhotography(
      data,
      characterIndex,
    )
    if (!photography?.children || photography.children.length === 0) return null
    return photography.children[0]
  },

  getPerspective: (data, characterIndex) => {
    const exploration = extractFromContentTree.getExploration(
      data,
      characterIndex,
    )
    if (!exploration?.children || exploration.children.length === 0) return null
    return exploration.children[0]
  },

  getUpload: (data, characterIndex) => {
    const perspective = extractFromContentTree.getPerspective(
      data,
      characterIndex,
    )
    if (!perspective?.children || perspective.children.length === 0) return null
    return perspective.children[0]
  },

  getGallery: (data, characterIndex) => {
    const upload = extractFromContentTree.getUpload(data, characterIndex)
    if (!upload?.children || upload.children.length === 0) return null
    return upload.children[0]
  },

  getEnding: (data, characterIndex) => {
    const gallery = extractFromContentTree.getGallery(data, characterIndex)
    if (!gallery?.children || gallery.children.length === 0) return null
    return gallery.children[0]
  },
}

export const useAllContent = (options = {}) => {
  return useLocalizedQuery({
    queryKey: queryKeys.all,
    queryFn: (localeContent) => localeContent || fetchAll(),
    retry: 3,
    retryDelay: (attemptIndex) => Math.min(1000 * 2 ** attemptIndex, 30000),
    ...options,
  })
}

export const useWelcomeLanguageFromAll = (options = {}) => {
  const { data: allContent, ...queryResult } = useAllContent(options)

  const welcomeLanguageData = useMemo(
    () => extractFromContentTree.getWelcomeLanguage(allContent),
    [allContent],
  )

  return {
    ...queryResult,
    data: welcomeLanguageData,
  }
}

export const useWelcomeIntroFromAll = (options = {}) => {
  const { data: allContent, ...queryResult } = useAllContent(options)

  const welcomeIntroData = useMemo(
    () => extractFromContentTree.getWelcomeIntro(allContent),
    [allContent],
  )

  return {
    ...queryResult,
    data: welcomeIntroData,
  }
}

export const useWelcomeFromAll = (options = {}) => {
  const { data: allContent, ...queryResult } = useAllContent(options)

  const welcomeData = useMemo(
    () => extractFromContentTree.getWelcome(allContent),
    [allContent],
  )

  return {
    ...queryResult,
    data: welcomeData,
  }
}

export const useCharacterOverviewFromAll = (options = {}) => {
  const { data: allContent, ...queryResult } = useAllContent(options)

  const characterOverviewData = useMemo(
    () => extractFromContentTree.getCharacterOverview(allContent),
    [allContent],
  )

  return {
    ...queryResult,
    data: characterOverviewData,
  }
}

export const useCharactersFromAll = (options = {}) => {
  const { data: allContent, ...queryResult } = useAllContent(options)

  const charactersData = useMemo(
    () => extractFromContentTree.getCharacters(allContent),
    [allContent],
  )

  return {
    ...queryResult,
    data: charactersData,
  }
}

export const useIntroductionFromAll = (characterIndex, options = {}) => {
  const { data: allContent, ...queryResult } = useAllContent(options)

  const introductionData = useMemo(
    () => extractFromContentTree.getIntroduction(allContent, characterIndex),
    [allContent, characterIndex],
  )

  return {
    ...queryResult,
    data: introductionData,
  }
}

export const usePhotographyFromAll = (characterIndex, options = {}) => {
  const { data: allContent, ...queryResult } = useAllContent(options)

  const photographyData = useMemo(
    () => extractFromContentTree.getPhotography(allContent, characterIndex),
    [allContent, characterIndex],
  )

  return {
    ...queryResult,
    data: photographyData,
  }
}

export const useExplorationFromAll = (characterIndex, options = {}) => {
  const { data: allContent, ...queryResult } = useAllContent(options)

  const explorationData = useMemo(
    () => extractFromContentTree.getExploration(allContent, characterIndex),
    [allContent, characterIndex],
  )

  return {
    ...queryResult,
    data: explorationData,
  }
}

export const usePerspectiveFromAll = (characterIndex, options = {}) => {
  const { data: allContent, ...queryResult } = useAllContent(options)

  const perspectiveData = useMemo(
    () => extractFromContentTree.getPerspective(allContent, characterIndex),
    [allContent, characterIndex],
  )

  return {
    ...queryResult,
    data: perspectiveData,
  }
}

export const useUploadFromAll = (characterIndex, options = {}) => {
  const { data: allContent, ...queryResult } = useAllContent(options)

  const uploadData = useMemo(
    () => extractFromContentTree.getUpload(allContent, characterIndex),
    [allContent, characterIndex],
  )

  return {
    ...queryResult,
    data: uploadData,
  }
}

export const useGalleryFromAll = (characterIndex, options = {}) => {
  const { data: allContent, ...queryResult } = useAllContent(options)

  const galleryData = useMemo(
    () => extractFromContentTree.getGallery(allContent, characterIndex),
    [allContent, characterIndex],
  )

  return {
    ...queryResult,
    data: galleryData,
  }
}

export const useEndingFromAll = (characterIndex, options = {}) => {
  const { data: allContent, ...queryResult } = useAllContent(options)

  const endingData = useMemo(
    () => extractFromContentTree.getEnding(allContent, characterIndex),
    [allContent, characterIndex],
  )

  return {
    ...queryResult,
    data: endingData,
  }
}

export const useApiRoot = (options = {}) => {
  return useQuery({
    queryKey: queryKeys.apiRoot,
    queryFn: fetchApiRoot,
    staleTime: 5 * 60 * 1000,
    gcTime: 10 * 60 * 1000,
    retry: 3,
    retryDelay: (attemptIndex) => Math.min(1000 * 2 ** attemptIndex, 30000),
    ...options,
  })
}
</file>

<file path="src/components/Ending/Ending.jsx">
import { extractFromContentTree } from "@/api/hooks"
import { allContentQuery } from "@/api/queries"
import { getCurrentLocale } from "@/i18n"
import { useEffect, useState } from "react"
import { useLoaderData, useNavigate } from "react-router-dom"
import { styled } from "styled-components"

import LoadingSpinner from "../UI/LoadingSpinner"
import Navigation from "../UI/Navigation"

const Screen = styled.div`
  position: relative;
  width: 100dvw;
  height: 100dvh;
  padding: var(--safe-inset-top) 1.625rem calc(var(--safe-inset-bottom) + 7rem)
    1.625rem;
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  color: #fff;
  overflow: hidden;
`

const BackgroundImage = styled.div`
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-image: ${(props) =>
    props.$imageUrl ? `url(${props.$imageUrl})` : "none"};
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  opacity: ${(props) => (props.$imageUrl ? "0.4" : "0")};
  z-index: 0;
  transition: opacity 0.5s ease-in-out;
`

const Content = styled.div`
  position: relative;
  z-index: 1;
  display: flex;
  flex-direction: column;
  height: 100%;
  justify-content: center;
  align-items: flex-start;
`

const Headline = styled.h1`
  font-family: "Bricolage Grotesque";
  font-size: 2.625rem;
  font-style: normal;
  padding-top: 2rem;
  font-weight: 700;
  line-height: normal;
  margin-bottom: 2rem;
  opacity: ${(props) => (props.$isLoading ? "0.5" : "1")};
  transition: opacity 0.3s ease-in-out;
  text-align: left;
`

const Description = styled.div`
  width: 21.375rem;
  max-width: 100%;
  font-family: "Bricolage Grotesque";
  font-size: 1.5rem;
  font-style: normal;
  font-weight: 700;
  line-height: 1.4;
  margin-bottom: 3rem;
  opacity: ${(props) => (props.$isLoading ? "0.5" : "1")};
  transition: opacity 0.3s ease-in-out;

  p {
    margin: 0 0 1rem 0;

    &:last-child {
      margin-bottom: 0;
    }
  }

  strong {
    font-weight: 800;
  }

  em {
    font-style: italic;
  }
`

const ThankYouMessage = styled.div`
  background: rgba(255, 255, 255, 0.1);
  border: 2px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  padding: 1.5rem;
  margin-bottom: 2rem;
  backdrop-filter: blur(10px);
  font-family: "Bricolage Grotesque";
  font-size: 1.125rem;
  font-weight: 600;
  text-align: center;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
  transform: ${(props) =>
    props.$visible ? "translateY(0)" : "translateY(20px)"};
  opacity: ${(props) => (props.$visible ? "1" : "0")};
  transition: all 0.5s ease-in-out;
`

const LoadingContainer = styled.div`
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 2rem 0;
`

const NavigationWrapper = styled.div`
  margin-top: auto;
  padding-top: 2rem;
`

export default function Ending() {
  const { ending } = useLoaderData()
  const [imageLoaded, setImageLoaded] = useState(false)
  const [showCelebration, setShowCelebration] = useState(false)
  const navigate = useNavigate()
  const isLoading = false

  useEffect(() => {
    const imageUrl = ending?.backgroundImage?.file
    if (imageUrl) {
      const img = new Image()
      img.onload = () => setImageLoaded(true)
      img.onerror = () => setImageLoaded(false)
      img.src = imageUrl
    } else {
      setImageLoaded(false)
    }
  }, [ending?.backgroundImage])

  useEffect(() => {
    const timer = setTimeout(() => {
      setShowCelebration(true)
    }, 500)

    return () => clearTimeout(timer)
  }, [])

  // Use CMS data - it's localized based on current language
  const heading = ending?.heading || ""
  const description = ending?.description
    ? ending.description.replace(/<[^>]*>/g, "")
    : ""

  const backgroundImageUrl =
    imageLoaded && ending?.backgroundImage?.file
      ? ending.backgroundImage.file
      : null

  return (
    <Screen>
      <BackgroundImage $imageUrl={backgroundImageUrl} />

      <Content>
        <Headline $isLoading={isLoading}>{heading}</Headline>

        {isLoading && (
          <LoadingContainer>
            <LoadingSpinner />
          </LoadingContainer>
        )}

        {!isLoading && description && <Description>{description}</Description>}

        {!isLoading && (
          <ThankYouMessage $visible={showCelebration}>
            {heading}
          </ThankYouMessage>
        )}

        <NavigationWrapper>
          <Navigation
            mode="single"
            onSelect={() => navigate("/")}
            disabled={isLoading}
          />
        </NavigationWrapper>
      </Content>
    </Screen>
  )
}

export const loader =
  (queryClient) =>
  async ({ params }) => {
    const locale = getCurrentLocale()
    const query = allContentQuery(locale)
    const content = await queryClient.ensureQueryData(query)

    const characterId = params.characterId
    const characterIndex = Number.parseInt(characterId ?? "", 10)

    if (Number.isNaN(characterIndex) || characterIndex < 0) {
      throw new Response("Character not found", { status: 404 })
    }

    const ending = extractFromContentTree.getEnding(content, characterIndex)

    return { characterIndex, ending }
  }
</file>

<file path="src/components/Welcome/CharacterShowcase/components/CharacterCarousel.jsx">
import {
  CAROUSEL_ANIMATION,
  DRAG_CONFIG,
} from "@components/Welcome/CharacterShowcase/utils/transformUtils"
import { motion } from "motion/react"
import { useTranslation } from "react-i18next"
import { useRouteLoaderData } from "react-router-dom"
import { styled } from "styled-components"

import { useCharacterCarousel } from "../hooks/useCharacterCarousel"

const CarouselContainer = styled(motion.div)`
  width: 100dvw;
  height: 100%;
  overflow: hidden;
  perspective: 62.5rem;
  display: flex;
  align-items: center;
  justify-content: flex-start;
  position: relative;
`

const DraggableWrapper = styled(motion.div)`
  display: flex;
  height: 100%;
  width: ${(props) => `${props.$charactersLength * 100}dvw`};
`

const CharacterCardContainer = styled(motion.div)`
  flex: 0 0 100dvw;
  height: 100%;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-end;
  user-select: none;
  margin-bottom: 5.25rem;
  transform-origin: bottom;
  z-index: -1;
`

const CharacterImage = styled(motion.img)`
  width: auto;
  height: 60dvh;
  margin-bottom: 5.25rem;
  object-fit: contain;
  filter: ${({ $shadowIntensity }) =>
    `drop-shadow(0 ${0.5 + $shadowIntensity * 0.25}rem ${0.75 + $shadowIntensity * 0.5}rem rgba(0, 0, 0, ${0.4 - $shadowIntensity * 0.1}))`};
`

const CharacterCarousel = ({ selectedIndex, onSelectionChange }) => {
  const { t } = useTranslation()
  const loaderData = useRouteLoaderData("welcome")
  const charactersData = loaderData?.characters ?? []

  const { x, handleDragStart, handleDragEnd, dragConstraints } =
    useCharacterCarousel(
      selectedIndex,
      charactersData?.length || 0,
      onSelectionChange,
    )

  // Return early if no characters data is available yet
  if (!charactersData || charactersData.length === 0) {
    return (
      <CarouselContainer>
        {t("loading.characters", "Loading characters...")}
      </CarouselContainer>
    )
  }

  return (
    <CarouselContainer
      initial={{ opacity: 0 }}
      animate={{ opacity: 1 }}
      transition={{ duration: 0.5, ease: "easeOut" }}
    >
      <DraggableWrapper
        initial={{ x: -100 }}
        animate={{ x: 0 }}
        transition={{ duration: 0.6, delay: 0.2, ease: "easeOut" }}
        style={{ x }}
        $charactersLength={charactersData.length}
        drag="x"
        dragConstraints={dragConstraints}
        dragElastic={DRAG_CONFIG.elastic}
        dragMomentum={DRAG_CONFIG.momentum}
        onDragStart={handleDragStart}
        onDragEnd={handleDragEnd}
      >
        {charactersData.map((character, index) => {
          const offset = index - selectedIndex
          const absoluteOffset = Math.abs(offset)
          return (
            <CharacterCard
              key={character.id || character.name}
              character={character}
              scale={Math.max(1 - absoluteOffset * 0.2, 0.9)}
              shadowIntensity={absoluteOffset}
            />
          )
        })}
      </DraggableWrapper>
    </CarouselContainer>
  )
}

const CharacterCard = ({ character, scale, shadowIntensity }) => (
  <CharacterCardContainer
    initial={{ opacity: 0, y: 20 }}
    animate={{
      opacity: 1,
      y: 0,
      scale,
    }}
    transition={{
      duration: 0.5,
      delay: 0.4,
      ease: "easeOut",
      scale: CAROUSEL_ANIMATION,
    }}
  >
    <CharacterImage
      initial={{ opacity: 0, scale: 0.8 }}
      animate={{ opacity: 1, scale: 1 }}
      transition={{
        duration: 0.6,
        delay: 0.6,
        ease: "easeOut",
      }}
      src={character.image || character.characterImage?.file}
      alt={character.name}
      $shadowIntensity={shadowIntensity}
    />
  </CharacterCardContainer>
)

export default CharacterCarousel
</file>

<file path="src/components/App/screens.js">
import Exploration from "@components/Exploration"
import Gallery from "@components/Gallery"
import Introduction from "@components/Introduction"
import Perspective from "@components/Perspective"
import PhotoCapture from "@components/PhotoCapture"
import Upload from "@components/Upload"

import LaNau from "@ui/assets/LaNau.webp"

export const createScreens = (goNext) => {
  return [
    {
      id: "welcome",
      layout: {
        type: "overlay",
        backgroundImage: LaNau,
        headline: "La Nau",
        subheadline: "Experiencing",
      },
      navigation: {
        mode: "single",
        variant: "arrowDown",
        onNext: goNext,
      },
    },

    {
      id: "character-selection",
      layout: {
        type: "overlay",
        backgroundImage: LaNau,
        headline: "La Nau",
        description: {
          title: "Choose your guide",
          text: "Select your guide for this immersive journey through La Nau.",
        },
      },
      navigation: {
        mode: "single",
      },
    },
    {
      id: "introduction",
      component: Introduction,
      layout: {
        type: "full",
      },
      navigation: {
        mode: "single",
      },
    },

    {
      id: "photo-capture",
      component: PhotoCapture,
      layout: {
        type: "overlay",
      },
      navigation: {
        mode: "single",
        position: "bottom",
      },
    },
    {
      id: "exploration",
      component: Exploration,
      layout: {
        type: "full",
      },
      navigation: {
        mode: "single",
      },
    },

    {
      id: "perspective",
      component: Perspective,
      layout: {
        type: "overlay",
        headline: "Your perspective",
        description: {
          title: "Your perspective",
          text: "You’ve seen the monument through new eyes. Now, add your vision to a living collage, together with others who care, just like you.",
        },
      },
      navigation: {
        mode: "single",
      },
    },

    {
      id: "upload",
      component: Upload,
      layout: {
        type: "full",
      },
      navigation: {
        mode: "single",
      },
    },

    {
      id: "gallery",
      component: Gallery,
      layout: {
        type: "full",
      },
      navigation: {
        mode: "single",
      },
    },
  ]
}

export default createScreens
</file>

<file path="src/components/Perspective/Perspective.jsx">
import { extractFromContentTree } from "@/api/hooks"
import { allContentQuery } from "@/api/queries"
import { getCurrentLocale } from "@/i18n"
import { useEffect, useState } from "react"
import { useLoaderData, useNavigate } from "react-router-dom"
import { styled } from "styled-components"

import LoadingSpinner from "../UI/LoadingSpinner"
import Navigation from "../UI/Navigation"

const Screen = styled.div`
  position: relative;
  width: 100dvw;
  height: 100dvh;
  padding: var(--safe-inset-top) 1.625rem calc(var(--safe-inset-bottom) + 7rem)
    1.625rem;
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  color: #fff;
  overflow: hidden;
`

const BackgroundImage = styled.div`
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-image: ${(props) =>
    props.$imageUrl ? `url(${props.$imageUrl})` : "none"};
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  opacity: ${(props) => (props.$imageUrl ? "0.3" : "0")};
  z-index: 0;
  transition: opacity 0.5s ease-in-out;
`

const Content = styled.div`
  position: relative;
  z-index: 1;
  display: flex;
  flex-direction: column;
  height: 100%;
`

const Headline = styled.h1`
  margin-top: 10.75rem;
  font-family: "Bricolage Grotesque";
  font-size: 2.625rem;
  font-style: normal;
  font-weight: 700;
  line-height: normal;
  margin-bottom: 1.5rem;
  opacity: ${(props) => (props.$isLoading ? "0.5" : "1")};
  transition: opacity 0.3s ease-in-out;
`

const Description = styled.div`
  width: 21.375rem;
  max-width: 100%;
  font-family: "Bricolage Grotesque";
  font-size: 1.5rem;
  font-style: normal;
  font-weight: 700;
  line-height: 1.4;
  margin-bottom: 2rem;
  opacity: ${(props) => (props.$isLoading ? "0.5" : "1")};
  transition: opacity 0.3s ease-in-out;

  p {
    margin: 0 0 1rem 0;

    &:last-child {
      margin-bottom: 0;
    }
  }

  strong {
    font-weight: 800;
  }

  em {
    font-style: italic;
  }
`

const LoadingContainer = styled.div`
  display: flex;
  align-items: center;
  justify-content: center;
  margin-top: 2rem;
  margin-bottom: 2rem;
`

export default function Perspective() {
  const { characterIndex: currentCharacterIndex, perspective } = useLoaderData()
  const [imageLoaded, setImageLoaded] = useState(false)
  const navigate = useNavigate()
  const isLoading = false

  useEffect(() => {
    const imageUrl = perspective?.backgroundImage?.file
    if (imageUrl) {
      const img = new Image()
      img.onload = () => setImageLoaded(true)
      img.onerror = () => setImageLoaded(false)
      img.src = imageUrl
    } else {
      setImageLoaded(false)
    }
  }, [perspective?.backgroundImage])

  const heading = perspective?.heading || ""
  const description = perspective?.description
    ? perspective.description.replace(/<[^>]*>/g, "")
    : ""

  const backgroundImageUrl =
    imageLoaded && perspective?.backgroundImage?.file
      ? perspective.backgroundImage.file
      : null

  return (
    <Screen>
      <BackgroundImage $imageUrl={backgroundImageUrl} />

      <Content>
        <Headline $isLoading={isLoading}>{heading}</Headline>

        {isLoading && (
          <LoadingContainer>
            <LoadingSpinner />
          </LoadingContainer>
        )}

        {!isLoading && description && <Description>{description}</Description>}
      </Content>

      <Navigation
        mode="single"
        onSelect={() => navigate(`/characters/${currentCharacterIndex}/upload`)}
        disabled={isLoading}
      />
    </Screen>
  )
}

export const loader =
  (queryClient) =>
  async ({ params }) => {
    const locale = getCurrentLocale()
    const query = allContentQuery(locale)
    const content = await queryClient.ensureQueryData(query)

    const characterId = params.characterId
    const characterIndex = Number.parseInt(characterId ?? "", 10)

    if (Number.isNaN(characterIndex) || characterIndex < 0) {
      throw new Response("Character not found", { status: 404 })
    }

    const perspective = extractFromContentTree.getPerspective(
      content,
      characterIndex,
    )

    if (!perspective) {
      throw new Response("Perspective not found", { status: 404 })
    }
    return { characterIndex, perspective }
  }
</file>

<file path="src/components/UI/LanguageSelector/LanguageSelector.jsx">
import { changeLanguage, getCurrentLocale } from "@/i18n"
import { useLanguages } from "@/providers/LanguageProvider"
import { useEffect, useMemo, useState } from "react"
import { useTranslation } from "react-i18next"
import { styled } from "styled-components"

const SelectorContainer = styled.div`
  position: relative;
  display: inline-block;
`

const CurrentLanguage = styled.button`
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 8px;
  color: white;
  padding: 8px 12px;
  font-size: 0.875rem;
  font-weight: 500;
  cursor: ${({ disabled }) => (disabled ? "default" : "pointer")};
  opacity: ${({ disabled }) => (disabled ? 0.8 : 1)};
  display: flex;
  align-items: center;
  gap: 8px;
  backdrop-filter: blur(10px);
  transition: all 0.2s ease;

  &::after {
    content: "▼";
    font-size: 0.75rem;
    transition: transform 0.2s ease;
    transform: ${({ $isOpen }) =>
      $isOpen ? "rotate(180deg)" : "rotate(0deg)"};
  }
`

const LanguageDropdown = styled.div`
  position: absolute;
  top: 100%;
  right: 0;
  margin-top: 4px;
  background: rgba(0, 0, 0, 0.9);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 8px;
  backdrop-filter: blur(20px);
  min-width: 120px;
  z-index: 1000;
  opacity: ${({ $isOpen }) => ($isOpen ? 1 : 0)};
  visibility: ${({ $isOpen }) => ($isOpen ? "visible" : "hidden")};
  transform: ${({ $isOpen }) =>
    $isOpen ? "translateY(0)" : "translateY(-8px)"};
  transition: all 0.2s ease;
`

const LanguageOption = styled.button`
  width: 100%;
  padding: 12px 16px;
  background: none;
  border: none;
  color: white;
  text-align: left;
  font-size: 0.875rem;
  cursor: pointer;
  transition: background-color 0.2s ease;

  &:first-child {
    border-radius: 8px 8px 0 0;
  }

  &:last-child {
    border-radius: 0 0 8px 8px;
  }

  &:only-child {
    border-radius: 8px;
  }

  ${({ $isActive }) =>
    $isActive &&
    `
    background: rgba(255, 255, 255, 0.15);
    font-weight: 600;

    &::after {
      content: '✓';
      float: right;
      color: #4ecdc4;
    }
  `}
`

const Overlay = styled.div`
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 999;
  display: ${({ $isOpen }) => ($isOpen ? "block" : "none")};
`

export default function LanguageSelector({ className }) {
  const { i18n } = useTranslation()
  const [isOpen, setIsOpen] = useState(false)
  const [currentLocale, setCurrentLocale] = useState(() => getCurrentLocale())
  const { supportedLanguages, isLoading } = useLanguages()
  const languageCodes = useMemo(
    () => Object.keys(supportedLanguages),
    [supportedLanguages],
  )
  const hasMultipleLanguages = languageCodes.length > 1

  useEffect(() => {
    const controller = new AbortController()

    const handleLanguageChange = () => {
      if (controller.signal.aborted) return
      setCurrentLocale(getCurrentLocale())
    }

    handleLanguageChange()

    i18n.on("languageChanged", handleLanguageChange)
    return () => {
      controller.abort()
      i18n.off("languageChanged", handleLanguageChange)
    }
  }, [i18n])

  const handleLanguageChange = async (languageCode) => {
    await changeLanguage(languageCode)
    setIsOpen(false)
  }

  const toggleDropdown = () =>
    hasMultipleLanguages && setIsOpen((previous) => !previous)

  const closeDropdown = () => {
    setIsOpen(false)
  }

  const currentLanguageName =
    supportedLanguages[currentLocale] ??
    supportedLanguages[languageCodes[0]] ??
    currentLocale.toUpperCase()

  if (isLoading) {
    return (
      <SelectorContainer className={className}>
        <CurrentLanguage $isOpen={false}>Loading...</CurrentLanguage>
      </SelectorContainer>
    )
  }

  return (
    <>
      <Overlay
        $isOpen={isOpen && hasMultipleLanguages}
        onClick={closeDropdown}
      />
      <SelectorContainer className={className}>
        <CurrentLanguage
          $isOpen={isOpen}
          onClick={toggleDropdown}
          disabled={!hasMultipleLanguages}
        >
          {currentLanguageName}
        </CurrentLanguage>

        <LanguageDropdown $isOpen={isOpen && hasMultipleLanguages}>
          {languageCodes.map((code) => (
            <LanguageOption
              key={code}
              $isActive={code === currentLocale}
              onClick={() => handleLanguageChange(code)}
            >
              {supportedLanguages[code]}
            </LanguageOption>
          ))}
        </LanguageDropdown>
      </SelectorContainer>
    </>
  )
}
</file>

<file path="src/components/Welcome/CharacterShowcase/CharacterShowcase.jsx">
import useGlobalState from "@/hooks/useGlobalState"
import { useRouteLoaderData } from "react-router-dom"

import CharacterCarousel from "./components/CharacterCarousel"
import Intro from "./components/Intro"
import { MainLayoutContainer } from "./styles"

export default function CharacterShowcase({
  showIntro,
  setShowIntro,
  characters,
}) {
  const { currentCharacterIndex, setCurrentCharacterIndex } = useGlobalState()
  const loaderData = useRouteLoaderData("welcome")

  const charactersData = characters ?? loaderData?.characters ?? []

  const handleCharacterSelection = (index) => {
    if (charactersData && charactersData.length > 0) {
      setCurrentCharacterIndex(index)
      setShowIntro(false)
    }
  }

  const handleCharacterChange = (newIndex) => {
    setCurrentCharacterIndex(newIndex)
  }

  return (
    <MainLayoutContainer>
      {showIntro ? (
        <Intro onCharacterSelect={handleCharacterSelection} />
      ) : (
        <CharacterCarousel
          selectedIndex={currentCharacterIndex}
          onSelectionChange={handleCharacterChange}
        />
      )}
    </MainLayoutContainer>
  )
}
</file>

<file path="package.json">
{
  "name": "cheminova-frontend",
  "private": true,
  "version": "0.1.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "dev:host": "vite --host",
    "lint": "eslint src",
    "format": "prettier --check src",
    "format:write": "prettier --write src",
    "build": "vite build",
    "preview": "vite preview",
    "prepare": "husky"
  },
  "dependencies": {
    "@react-three/drei": "^10.7.6",
    "@react-three/fiber": "^9.3.0",
    "@rive-app/react-canvas": "^4.23.4",
    "@tanstack/react-query": "^5.90.6",
    "@tanstack/react-query-devtools": "^5.90.2",
    "i18next": "^25.5.3",
    "i18next-browser-languagedetector": "^8.2.0",
    "i18next-http-backend": "^3.0.2",
    "motion": "^12.23.24",
    "react": "^19.1.1",
    "react-dom": "^19.1.1",
    "react-i18next": "^15.7.4",
    "react-router-dom": "^7.9.5",
    "styled-components": "^6.1.19"
  },
  "devDependencies": {
    "@eslint/js": "^9.35.0",
    "@ianvs/prettier-plugin-sort-imports": "^4.7.0",
    "@nabla/vite-plugin-eslint": "^2.0.6",
    "@react-three/eslint-plugin": "^0.1.2",
    "@tanstack/eslint-plugin-query": "^5.86.0",
    "@types/react": "^19.1.17",
    "@types/react-dom": "^19.1.11",
    "@vitejs/plugin-react": "^5.0.4",
    "babel-plugin-react-compiler": "^19.1.0-rc.1-rc-af1b7da-20250421",
    "babel-plugin-styled-components": "^2.1.4",
    "eslint": "^9.35.0",
    "eslint-config-prettier": "^10.1.8",
    "eslint-plugin-react": "^7.37.5",
    "eslint-plugin-react-compiler": "^19.1.0-rc.1-rc-af1b7da-20250421",
    "eslint-plugin-react-hooks": "^5.2.0",
    "globals": "^16.4.0",
    "husky": "^9.1.7",
    "lint-staged": "^16.1.6",
    "prettier": "^3.6.2",
    "vite": "^7.1.12",
    "vite-plugin-webfont-dl": "^3.11.1"
  }
}
</file>

<file path="src/api/uploadImage.js">
import { API_BASE_URL } from "@/config/api"

export const uploadImage = async (
  imageFile,
  characterSlug,
  { text, userName } = {},
) => {
  const formData = new FormData()
  formData.append("image", imageFile)

  if (text?.trim()) {
    formData.append("text", text.trim())
  }

  if (userName?.trim()) {
    formData.append("userName", userName.trim())
  }

  const response = await fetch(`${API_BASE_URL}/images/${characterSlug}/`, {
    method: "POST",
    body: formData,
    headers: {
      Accept: "application/json",
    },
  })

  if (!response.ok) {
    throw new Error(`Upload failed: ${response.status}`)
  }

  return response.json()
}
</file>

<file path="src/hooks/useUploadImage.js">
import { fetchCharacterSlugs } from "@/api/djangoApi"
import { uploadImage } from "@/api/uploadImage"
import { DEFAULT_LANGUAGE } from "@/config/language"
import { useMutation, useQuery, useQueryClient } from "@tanstack/react-query"
import { useRef } from "react"
import { useTranslation } from "react-i18next"
import { useParams } from "react-router-dom"

export const useUploadImage = () => {
  const queryClient = useQueryClient()
  const { i18n } = useTranslation()
  const locale = i18n.language || DEFAULT_LANGUAGE
  const lastUploadedCharacterSlugRef = useRef(null)
  const { characterId } = useParams()
  const currentCharacterIndex = Number.parseInt(characterId ?? "", 10) || 0

  const { data: characterSlugsData } = useQuery({
    queryKey: ["character-slugs", locale],
    queryFn: () => fetchCharacterSlugs(locale),
    staleTime: 5 * 60 * 1000,
    gcTime: 10 * 60 * 1000,
    retry: 2,
    enabled: Boolean(locale),
  })

  const getCharacterSlug = () => {
    return characterSlugsData[0].characters[currentCharacterIndex].slug
  }

  return useMutation({
    mutationFn: async ({ file, text, userName }) => {
      const slug = getCharacterSlug()
      lastUploadedCharacterSlugRef.current = slug
      return uploadImage(file, slug, { text, userName })
    },
    onSuccess: () => {
      const slug = lastUploadedCharacterSlugRef.current
      queryClient.invalidateQueries({ queryKey: ["images", slug] })
      queryClient.invalidateQueries({ queryKey: ["gallery-images"] })
      queryClient.invalidateQueries({ queryKey: ["recent-images"] })
    },
  })
}
</file>

<file path="src/i18n/index.js">
import {
  BACKEND_CONFIG,
  DEFAULT_LANGUAGE,
  DETECTION_CONFIG,
  findLanguageByCode,
  getLanguageCodes,
  INTERPOLATION_CONFIG,
  LANGUAGE_CONFIG,
  LANGUAGE_LIST,
  NAMESPACE_CONFIG,
  REACT_I18N_CONFIG,
} from "@/config/language"
import i18n from "i18next"
import LanguageDetector from "i18next-browser-languagedetector"
import HttpApi from "i18next-http-backend"
import { initReactI18next } from "react-i18next"

export { LANGUAGE_LIST }

const sanitizeLanguageCode = (value) => {
  if (typeof value !== "string") return ""
  return value.trim().toLowerCase()
}

const ensureSupportedLanguage = (code) => {
  const normalized = sanitizeLanguageCode(code)
  return findLanguageByCode(normalized) ? normalized : DEFAULT_LANGUAGE
}

const convertDetectedLanguage = (lng) => {
  const sanitized = sanitizeLanguageCode(lng)
  const baseCode = sanitized.split("-")[0]
  return ensureSupportedLanguage(baseCode)
}

i18n
  .use(HttpApi)
  .use(LanguageDetector)
  .use(initReactI18next)
  .init({
    supportedLngs: getLanguageCodes(),
    fallbackLng: DEFAULT_LANGUAGE,
    detection: {
      order: DETECTION_CONFIG.ORDER,
      caches: DETECTION_CONFIG.CACHES,
      lookupLocalStorage: DETECTION_CONFIG.LOOKUP_LOCAL_STORAGE,
      convertDetectedLanguage,
    },
    backend: {
      loadPath: BACKEND_CONFIG.LOAD_PATH,
    },
    react: {
      useSuspense: REACT_I18N_CONFIG.USE_SUSPENSE,
    },
    interpolation: {
      escapeValue: INTERPOLATION_CONFIG.ESCAPE_VALUE,
    },
    debug: import.meta.env.DEV,
    defaultNS: NAMESPACE_CONFIG.DEFAULT_NS,
    ns: NAMESPACE_CONFIG.NS,
  })

export const getCurrentLocale = () => {
  const language = sanitizeLanguageCode(i18n.language)
  const baseCode = language.split("-")[0]
  return ensureSupportedLanguage(baseCode)
}

export const changeLanguage = async (languageCode) => {
  const code = ensureSupportedLanguage(languageCode)
  await i18n.changeLanguage(code)
  localStorage.setItem(LANGUAGE_CONFIG.STORAGE_KEY, code)
}

export const getLanguageName = (languageCode) => {
  const code = ensureSupportedLanguage(languageCode)
  const language = findLanguageByCode(code)
  return language ? language.name : code.toUpperCase()
}

export const isLanguageSupported = (languageCode) => {
  const code = sanitizeLanguageCode(languageCode)
  return i18n.options.supportedLngs.includes(code)
}

export default i18n
</file>

<file path="src/api/djangoApi.js">
import { API_BASE_URL } from "@/config/api"

const apiRequest = async (endpoint, options = {}) => {
  const url = `${API_BASE_URL}${endpoint}`

  const defaultOptions = {
    headers: {
      "Content-Type": "application/json",
      ...options.headers,
    },
    ...options,
  }

  const response = await fetch(url, defaultOptions)

  if (!response.ok) {
    throw new Error(`HTTP error! status: ${response.status}`)
  }

  return response.json()
}

export const ALL_LOCALES_CONTENT_QUERY_KEY = ["all-locales-content"]

export const fetchAllLocalesContent = async () => {
  return apiRequest("/all/")
}

export const fetchCharacterSlugs = async (locale) => {
  const params = new URLSearchParams({ browsable: "false" })
  if (locale) {
    params.set("locale", locale)
  }

  const query = params.toString()
  const endpoint = `/characters/${query ? `?${query}` : ""}`
  return apiRequest(endpoint)
}

export const getContentForLocale = (allLocalesContent, locale = "en") => {
  const localeContent = allLocalesContent.find((item) => item.locale === locale)
  return localeContent ? [localeContent] : [allLocalesContent[0]]
}

export const fetchApiRoot = async () => {
  return apiRequest("/")
}

export const fetchAll = async (locale) => {
  const allLocalesContent = await fetchAllLocalesContent()
  return getContentForLocale(allLocalesContent, locale)
}
</file>

<file path="src/components/App/App.jsx">
import MobileOnlyGuard from "@/components/UI/MobileOnlyGuard"
import useGlobalState from "@/hooks/useGlobalState"
import useHistoryNavigation from "@/hooks/useHistoryNavigation"
import { useState } from "react"
import { styled } from "styled-components"

import Imprint from "@ui/Imprint"
import Privacy from "@ui/Privacy"

import Ending from "../Ending"
import Exploration from "../Exploration"
import Gallery from "../Gallery"
import Introduction from "../Introduction"
import Perspective from "../Perspective"
import PhotoCapture from "../PhotoCapture"
import LanguageSelector from "../UI/LanguageSelector"
import Upload from "../Upload"
import Welcome from "../Welcome"

const AppContainer = styled.div`
  width: 100dvw;
  height: 100dvh;
  overflow: ${(props) => (props.$scroll ? "scroll" : "hidden")};
  position: relative;
`

const LanguageSelectorContainer = styled.div`
  position: fixed;
  top: 2rem;
  right: 2rem;
  z-index: 1000;
`

export default function App() {
  const { showModal } = useGlobalState()
  const [state, navigateToPage] = useHistoryNavigation("welcome")
  const [capturedImages, setCapturedImages] = useState([])

  const handleImageCaptured = (imageData) => {
    setCapturedImages((prev) => [...prev, imageData])
  }

  const handleClearImages = () => {
    setCapturedImages([])
  }

  if (showModal === "privacy") {
    return (
      <AppContainer $scroll>
        <Privacy />
      </AppContainer>
    )
  }

  if (showModal === "imprint") {
    return (
      <AppContainer $scroll>
        <Imprint />
      </AppContainer>
    )
  }

  return (
    <MobileOnlyGuard>
      <AppContainer>
        {state === "welcome" && (
          <>
            <Welcome
              goToIntroduction={() => {
                navigateToPage("introduction")
                handleClearImages()
              }}
            />
            <LanguageSelectorContainer>
              <LanguageSelector />
            </LanguageSelectorContainer>
          </>
        )}
        {state === "introduction" && (
          <Introduction
            goToPhotoCapture={() => navigateToPage("photoCapture")}
          />
        )}
        {state === "photoCapture" && (
          <PhotoCapture
            goToExploration={() => navigateToPage("exploration")}
            onImageCaptured={handleImageCaptured}
            capturedImages={capturedImages}
          />
        )}
        {state === "exploration" && (
          <Exploration goToPerspective={() => navigateToPage("perspective")} />
        )}
        {state === "perspective" && (
          <Perspective goToUpload={() => navigateToPage("upload")} />
        )}
        {state === "upload" && (
          <Upload
            goToGallery={() => navigateToPage("gallery")}
            images={capturedImages}
          />
        )}
        {state === "gallery" && (
          <Gallery
            goToEnding={() => navigateToPage("ending")}
            capturedImages={capturedImages}
          />
        )}
        {state === "ending" && (
          <Ending goToWelcome={() => navigateToPage("welcome")} />
        )}
      </AppContainer>
    </MobileOnlyGuard>
  )
}
</file>

<file path="src/components/Exploration/Exploration.jsx">
import { extractFromContentTree } from "@/api/hooks"
import { allContentQuery } from "@/api/queries"
import { getCurrentLocale } from "@/i18n"
import { useScroll, useTransform } from "motion/react"
import { useRef } from "react"
import { useTranslation } from "react-i18next"
import { useLoaderData, useNavigate } from "react-router-dom"
import { styled } from "styled-components"

import Navigation from "../UI/Navigation"
import FirstImage from "./1stImage.png"
import SecondImage from "./2ndImage.png"
import {
  CharacterImage,
  CharacterImageContainer,
  ContentContainer,
  Headline,
  Image,
  IntroductionContainer,
  TextBlock,
} from "./styles"

const StyledNavigation = styled(Navigation)`
  bottom: 10%;
`

export default function Exploration() {
  const { t } = useTranslation()
  const {
    characterIndex: currentCharacterIndex,
    character,
    exploration,
  } = useLoaderData()
  const containerRef = useRef(null)
  const { scrollY } = useScroll({ container: containerRef })
  const y = useTransform(scrollY, (v) => -v * 0.5)
  const navigate = useNavigate()

  if (!character) {
    return (
      <IntroductionContainer ref={containerRef}>
        <ContentContainer initial={{ x: "-50%" }} style={{ y }}>
          <Headline>
            {t("loading.characters", "Loading characters...")}
          </Headline>
        </ContentContainer>
      </IntroductionContainer>
    )
  }

  const getExplorationContent = () => {
    if (exploration) {
      return {
        heading: exploration.heading || t("exploration.title"),
        description: exploration.description
          ? exploration.description.replace(/<[^>]*>/g, "")
          : t("exploration.content.stone1"),
        topImage: exploration.topImage?.file || FirstImage,
        bottomImage: exploration.bottomImage?.file || SecondImage,
      }
    }
    return {
      heading: t("exploration.title"),
      description: t("exploration.content.stone1"),
      topImage: FirstImage,
      bottomImage: SecondImage,
    }
  }

  const explorationContent = getExplorationContent()

  return (
    <IntroductionContainer ref={containerRef}>
      <CharacterImageContainer>
        <CharacterImage src={character.selectedImage || ""} />
      </CharacterImageContainer>

      <ContentContainer initial={{ x: "-50%" }} style={{ y }}>
        <Headline>{explorationContent.heading}</Headline>

        <Image src={explorationContent.topImage} />

        <TextBlock>{t("exploration.content.stone1")}</TextBlock>

        <TextBlock>{t("exploration.content.stone2")}</TextBlock>

        <Image src={explorationContent.bottomImage} />

        <TextBlock>{explorationContent.description}</TextBlock>

        <StyledNavigation
          mode="single"
          onSelect={() =>
            navigate(`/characters/${currentCharacterIndex}/perspective`)
          }
          iconColor="black"
        />
      </ContentContainer>
    </IntroductionContainer>
  )
}

export const loader =
  (queryClient) =>
  async ({ params }) => {
    const locale = getCurrentLocale()
    const query = allContentQuery(locale)
    const content = await queryClient.ensureQueryData(query)

    const characterId = params.characterId
    const characterIndex = Number.parseInt(characterId ?? "", 10)

    if (Number.isNaN(characterIndex) || characterIndex < 0) {
      throw new Response("Character not found", { status: 404 })
    }

    const character = extractFromContentTree.getCharacter(
      content,
      characterIndex,
    )

    if (!character) {
      throw new Response("Character not found", { status: 404 })
    }

    const exploration = extractFromContentTree.getExploration(
      content,
      characterIndex,
    )

    return { characterIndex, character, exploration }
  }
</file>

<file path="src/components/Gallery/Gallery.jsx">
import { extractFromContentTree } from "@/api/hooks"
import { allContentQuery } from "@/api/queries"
import { useGalleryImages } from "@/hooks/useGallery"
import useGlobalState from "@/hooks/useGlobalState"
import { getCurrentLocale } from "@/i18n"
import { Canvas } from "@react-three/fiber"
import theme from "@theme"
import { AnimatePresence, motion } from "motion/react"
import { useMemo, useRef, useState } from "react"
import { useTranslation } from "react-i18next"
import { useLoaderData, useNavigate } from "react-router-dom"
import { styled } from "styled-components"

import Navigation from "@ui/Navigation"

import PersonalImage1 from "./assets/1.jpg"
import PersonalImage2 from "./assets/2.jpg"
import PersonalImage3 from "./assets/3.jpg"
import CameraController from "./components/CameraController"
import GalleryContent from "./components/GalleryContent"
import GalleryLoader from "./components/GalleryLoader"
import StackBump from "./components/StackBump"
import { CAMERA_DEFAULT_Z, DEBUG_GALLERY } from "./config"
import { buildCombinedImagePool, getPersistedPersonalImages } from "./helpers"
import useImagePreloader from "./hooks/useImagePreloader"
import useResponsiveTilesPerRow from "./hooks/useResponsiveTilesPerRow"

const Page = styled.div`
  background-color: ${theme.colors.background.dark};
  min-height: 100vh;
  width: 100%;
`

const Title = styled.h1`
  color: ${theme.colors.background.paper};
  margin: 0;
  padding: 20px;
`

const Stage = styled.div`
  width: 100%;
  height: 90vh;
  position: relative;
  overflow: hidden;
`

const ExitButton = styled.button`
  position: absolute;
  top: 20px;
  right: 20px;
  background: rgba(0, 0, 0, 0.7);
  color: white;
  border: 1px solid #333;
  padding: 10px 15px;
  border-radius: 5px;
  font-family: inherit;
  font-size: 14px;
  cursor: pointer;
  z-index: 50;
`

const defaultPersonalImages = [PersonalImage1, PersonalImage2, PersonalImage3]

const cologneImages = import.meta.glob("./CologneCathedral/*.webp", {
  eager: true,
  query: "?url",
  import: "default",
})

export default function Gallery() {
  const { t } = useTranslation()
  const { capturedImages = [] } = useGlobalState()
  const tilesPerRow = useResponsiveTilesPerRow()
  const [allAnimsDone, setAllAnimsDone] = useState(false)
  const [detailMode, setDetailMode] = useState(false)
  const [activeIndex, setActiveIndex] = useState(0)
  const [stackSize, setStackSize] = useState(0)
  const [switchDir, setSwitchDir] = useState(0)
  const switchStartRef = useRef(0)
  const [detailStackScale, setDetailStackScale] = useState(null)
  const navigate = useNavigate()
  const { characterIndex: currentCharacterIndex, gallery } = useLoaderData()

  const { data: galleryData, isLoading: galleryLoading } = useGalleryImages()

  const galleryHeading = gallery?.heading || t("gallery.title")
  const exitButtonText = gallery?.exitButtonText || t("gallery.exitGallery")
  const closeButtonText = gallery?.closeButtonText || t("gallery.close")

  const personalImages = useMemo(
    () => getPersistedPersonalImages(defaultPersonalImages, capturedImages),
    [capturedImages],
  )

  const imagePoolData = useMemo(() => {
    const uploadedImages = galleryData?.images || []
    return buildCombinedImagePool(cologneImages, uploadedImages)
  }, [galleryData?.images])

  const allImages = useMemo(
    () => [...imagePoolData.combined, ...personalImages],
    [imagePoolData.combined, personalImages],
  )

  const { isLoading, loadedCount, totalImages } = useImagePreloader(allImages)

  const isFullyLoading = isLoading || galleryLoading

  const handleExitGallery = () => {
    navigate("/")
  }

  if (isFullyLoading) {
    return (
      <Page>
        <Title>{galleryHeading}</Title>
        <ExitButton onClick={handleExitGallery}>{exitButtonText}</ExitButton>
        <GalleryLoader loadedCount={loadedCount} totalImages={totalImages} />
      </Page>
    )
  }

  return (
    <Page>
      <Title>
        {allAnimsDone && !detailMode ? galleryHeading : `${galleryHeading}`}
      </Title>
      <ExitButton
        onClick={() => navigate(`/characters/${currentCharacterIndex}/ending`)}
      >
        {exitButtonText}
      </ExitButton>
      <Stage>
        <Canvas
          camera={{ position: [0, 0, CAMERA_DEFAULT_Z], fov: 75 }}
          style={{ touchAction: "none" }}
          gl={{ antialias: true, alpha: true }}
        >
          <CameraController detailMode={detailMode} />

          <StackBump
            switchDir={switchDir}
            switchStartRef={switchStartRef}
            onEnd={() => {
              DEBUG_GALLERY && console.debug("[StackBump] end")
              setSwitchDir(0)
              switchStartRef.current = 0
            }}
          >
            <GalleryContent
              imagePool={imagePoolData.combined}
              targetTilesPerRow={tilesPerRow}
              personalImages={personalImages}
              onAllAnimationsDone={() => setAllAnimsDone(true)}
              detailMode={detailMode}
              setDetailMode={setDetailMode}
              canEnterDetail={allAnimsDone && !detailMode}
              activeIndex={activeIndex}
              setActiveIndex={setActiveIndex}
              detailStackScale={detailStackScale}
              setDetailStackScale={setDetailStackScale}
              onStackSizeChange={(n) => {
                n !== stackSize &&
                  DEBUG_GALLERY &&
                  console.debug("[Gallery] stack size", n)
                setStackSize(n)
              }}
              switchInfo={{ dir: switchDir, startMs: switchStartRef.current }}
            />
          </StackBump>
        </Canvas>
        <AnimatePresence>
          {detailMode && (
            <motion.div
              style={{
                position: "fixed",
                left: 0,
                right: 0,
                bottom: 0,
                zIndex: 20,
              }}
              initial={{ opacity: 0, y: 40 }}
              animate={{ opacity: 1, y: 0 }}
              exit={{ opacity: 0, y: 40 }}
              transition={{ type: "tween", duration: 0.3 }}
            >
              <Navigation
                mode="select"
                position="bottom"
                selectLabel={closeButtonText}
                onSelect={() => {
                  DEBUG_GALLERY && console.debug("[Gallery] exit detail")
                  setDetailMode(false)
                  setDetailStackScale(null)
                }}
                onPrev={() => {
                  if (stackSize <= 0) return
                  DEBUG_GALLERY &&
                    console.debug("[Gallery] prev", { stackSize, activeIndex })
                  setSwitchDir(-1)
                  switchStartRef.current = performance.now()
                  setActiveIndex((i) => (i - 1 + stackSize) % stackSize)
                }}
                onNext={() => {
                  if (stackSize <= 0) return
                  DEBUG_GALLERY &&
                    console.debug("[Gallery] next", { stackSize, activeIndex })
                  setSwitchDir(1)
                  switchStartRef.current = performance.now()
                  setActiveIndex((i) => (i + 1) % stackSize)
                }}
              />
            </motion.div>
          )}
        </AnimatePresence>
      </Stage>
    </Page>
  )
}

export const loader =
  (queryClient) =>
  async ({ params }) => {
    const locale = getCurrentLocale()
    const query = allContentQuery(locale)
    const content = await queryClient.ensureQueryData(query)

    const characterId = params.characterId
    const characterIndex = Number.parseInt(characterId ?? "", 10)

    if (Number.isNaN(characterIndex) || characterIndex < 0) {
      throw new Response("Character not found", { status: 404 })
    }

    const gallery = extractFromContentTree.getGallery(content, characterIndex)

    return { characterIndex, gallery }
  }
</file>

<file path="src/components/PhotoCapture/PhotoCapture.jsx">
import { extractFromContentTree } from "@/api/hooks"
import { allContentQuery } from "@/api/queries"
import useGlobalState from "@/hooks/useGlobalState"
import { getCurrentLocale } from "@/i18n"
import useDevicePlatform from "@hooks/useDevicePlatform"
import { useMemo, useRef, useState } from "react"
import { useTranslation } from "react-i18next"
import { useLoaderData, useNavigate } from "react-router-dom"

import SmallButton from "@ui/SmallButton"

import Navigation from "../UI/Navigation"
import usePhotoTasks from "./hooks/usePhotoTasks"
import PhotoCaptureMetadata from "./PhotoCaptureMetadata"
import {
  HeaderContainer,
  HeaderText,
  HiddenInput,
  MetadataOverlay,
  PhotoCaptureContainer,
  TaskCard,
  TaskContent,
  TaskDescription,
  TaskHeadline,
  TaskImage,
  TasksContainer,
} from "./styles"

const DEFAULT_TASK_KEYS = ["laNau", "surroundings", "special"]

export default function PhotoCapture() {
  const { t } = useTranslation()
  const { capturedImages, setCapturedImageAt } = useGlobalState()
  const cameraInputRef = useRef(null)
  const galleryInputRef = useRef(null)
  const { isAndroid } = useDevicePlatform()
  const navigate = useNavigate()

  const [showMetadataModal, setShowMetadataModal] = useState(false)
  const [pendingImageData, setPendingImageData] = useState(null)
  const [photoMetadata, setPhotoMetadata] = useState({})

  const { characterIndex, photography } = useLoaderData()

  const heading = photography?.heading || t("photoCapture.title")
  const takePhotoText =
    photography?.takePhotoButtonText || t("photoCapture.buttons.takePhoto")
  const retakeText =
    photography?.retakePhotoButtonText || t("photoCapture.buttons.retake")
  const galleryText =
    photography?.galleryButtonText || t("photoCapture.buttons.gallery")

  const fallbackTitles = useMemo(
    () => DEFAULT_TASK_KEYS.map((key) => t(`photoCapture.tasks.${key}`)),
    [t],
  )

  const taskMetadata = useMemo(() => {
    const cmsTasks = photography?.imageDescriptions
    if (cmsTasks && cmsTasks.length > 0) {
      return cmsTasks.map((item, index) => {
        const titleFallback = fallbackTitles[index] || fallbackTitles[0] || ""
        return {
          title: item?.shortDescription?.trim() || titleFallback,
          description: (item?.description || "").trim(),
        }
      })
    }

    return fallbackTitles.map((title) => ({
      title,
      description: "",
    }))
  }, [photography?.imageDescriptions, fallbackTitles])

  const tasksForHook = useMemo(
    () =>
      taskMetadata.map(({ description, title }) => description || title || ""),
    [taskMetadata],
  )

  const { taskImages, currentTaskIndex, handleFileObject, retake } =
    usePhotoTasks({
      tasks: tasksForHook,
      onImageCaptured: (dataUrl, taskIndex) => {
        setPendingImageData({ dataUrl, taskIndex })
        setShowMetadataModal(true)
      },
      initialImages: capturedImages,
    })

  const handleFileChange = (event) => {
    const file = event.target.files?.[0]
    if (file) handleFileObject(file)
    event.target.value = ""
  }

  const handleOpenCamera = () => cameraInputRef.current?.click()
  const handleOpenGallery = () => galleryInputRef.current?.click()

  const handleMetadataSave = ({ text, userName, taskIndex }) => {
    setPhotoMetadata((prev) => ({
      ...prev,
      [taskIndex]: { text, userName },
    }))

    if (pendingImageData) {
      setCapturedImageAt(taskIndex, pendingImageData.dataUrl)
    }

    setShowMetadataModal(false)
    setPendingImageData(null)
  }

  const handleMetadataSkip = (taskIndex) => {
    if (pendingImageData) {
      setCapturedImageAt(taskIndex, pendingImageData.dataUrl)
    }

    setShowMetadataModal(false)
    setPendingImageData(null)
  }

  const getMetadataForTask = (taskIndex) => {
    return photoMetadata[taskIndex] || { text: "", userName: "" }
  }

  return (
    <>
      <PhotoCaptureContainer>
        <HiddenInput
          type="file"
          accept="image/*"
          capture="environment"
          onChange={handleFileChange}
          ref={cameraInputRef}
        />

        <HiddenInput
          type="file"
          accept="image/*"
          onChange={handleFileChange}
          ref={galleryInputRef}
        />

        <HeaderContainer>
          <HeaderText>{heading}</HeaderText>
        </HeaderContainer>

        <TasksContainer>
          {taskMetadata.map((task, index) => {
            const metadata = getMetadataForTask(index)
            const hasMetadata = metadata.text || metadata.userName

            return (
              <TaskCard key={index}>
                {task.title && <TaskHeadline>{task.title}</TaskHeadline>}
                {task.description && (
                  <TaskDescription
                    dangerouslySetInnerHTML={{ __html: task.description }}
                  />
                )}

                {hasMetadata && taskImages[index] && (
                  <TaskDescription>
                    {metadata.userName && (
                      <strong>{metadata.userName}: </strong>
                    )}
                    {metadata.text && <em>{metadata.text}</em>}
                  </TaskDescription>
                )}

                <TaskContent>
                  {taskImages[index] && (
                    <>
                      <SmallButton onClick={() => retake(index)}>
                        {retakeText}
                      </SmallButton>
                      <TaskImage
                        src={taskImages[index]}
                        alt={`Task ${index + 1} completed`}
                      />
                    </>
                  )}

                  {index === currentTaskIndex && !taskImages[index] && (
                    <>
                      {isAndroid ? (
                        <>
                          <SmallButton onClick={handleOpenCamera}>
                            {takePhotoText}
                          </SmallButton>
                          <SmallButton onClick={handleOpenGallery}>
                            {galleryText}
                          </SmallButton>
                        </>
                      ) : (
                        <SmallButton onClick={handleOpenGallery}>
                          {takePhotoText}
                        </SmallButton>
                      )}
                    </>
                  )}
                </TaskContent>
              </TaskCard>
            )
          })}
        </TasksContainer>
        <Navigation
          mode="single"
          onSelect={() => navigate(`/characters/${characterIndex}/exploration`)}
        />
      </PhotoCaptureContainer>

      {showMetadataModal && pendingImageData && (
        <>
          <MetadataOverlay
            onClick={() => handleMetadataSkip(pendingImageData.taskIndex)}
          />
          <PhotoCaptureMetadata
            taskIndex={pendingImageData.taskIndex}
            taskTitle={taskMetadata[pendingImageData.taskIndex]?.title}
            onSave={handleMetadataSave}
            onSkip={handleMetadataSkip}
          />
        </>
      )}
    </>
  )
}

export const loader =
  (queryClient) =>
  async ({ params }) => {
    const locale = getCurrentLocale()
    const query = allContentQuery(locale)
    const content = await queryClient.ensureQueryData(query)

    const characterId = params.characterId
    const characterIndex = Number.parseInt(characterId ?? "", 10)

    if (Number.isNaN(characterIndex) || characterIndex < 0) {
      throw new Response("Character not found", { status: 404 })
    }

    const photography = extractFromContentTree.getPhotography(
      content,
      characterIndex,
    )

    return { characterIndex, photography }
  }
</file>

<file path=".gitlab-ci.yml">
stages:
  - lint
  - build
  - deploy

variables:
  GIT_DEPTH: "1"
  GIT_SUBMODULE_STRATEGY: recursive
  HOST_NAME: dev.cheminova.acmade.de
  USER_NAME: deployment
  WEBSERVER_GID: 10001
  STATIC_DIR: /srv/docker/volumes/dev-cheminova_static/_data/public/

cache:
  key:
    files:
      - package-lock.json
  paths:
    - node_modules/
    - .eslintcache

lint:
  image: node:20-alpine
  stage: lint
  script:
    - npm ci
    - npm run lint
    - npm run format
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - node_modules/
      - .eslintcache
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: on_success
    - when: manual
  allow_failure: false

build:
  image: node:20-alpine
  stage: build
  needs:
    - job: lint
      optional: false
  script:
    - npm ci
    - export VITE_BASE_PATH=/
    - echo "Building with base path for deployment"
    - echo "Environment variables:"
    - echo "  VITE_BASE_PATH=$VITE_BASE_PATH"
    - echo "  CI_COMMIT_BRANCH=$CI_COMMIT_BRANCH"
    - echo "  CI_PROJECT_NAME=$CI_PROJECT_NAME"
    - npm run build
    - 'echo {\"commit\": \"$CI_COMMIT_SHA\", \"buildJob\": $CI_JOB_ID, \"buildTime\": \"$(date -u +"%Y-%m-%dT%H:%M:%SZ")\", \"branch\": \"$CI_COMMIT_BRANCH\"} > dist/build.json'
  artifacts:
    name: $CI_PROJECT_NAME-$CI_COMMIT_SHA
    paths:
      - dist/
    expire_in: 1 week
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: on_success
    - when: on_success

deploy:
  image: gitlab.artcom.de:5005/artcom/container-images/rsync-gitlab:v1.1.0
  stage: deploy
  needs:
    - job: build
      optional: false
  dependencies:
    - build
  environment:
    name: $CI_COMMIT_BRANCH
    url: https://$HOST_NAME/public/$CI_PROJECT_NAME/$CI_COMMIT_BRANCH
  before_script:
    - mkdir -p ~/.ssh
    - ssh-keyscan -H $HOST_NAME >> ~/.ssh/known_hosts
    - echo "Deploying to $CI_COMMIT_BRANCH environment"
  script:
    - ssh $USER_NAME@$HOST_NAME sudo mkdir -p $STATIC_DIR/$CI_PROJECT_NAME/$CI_COMMIT_BRANCH
    - rsync -avz --delete --rsync-path="sudo rsync" dist/ $USER_NAME@$HOST_NAME:$STATIC_DIR/$CI_PROJECT_NAME/$CI_COMMIT_BRANCH
    - ssh $USER_NAME@$HOST_NAME "sudo chown -R $USER_NAME:$WEBSERVER_GID $STATIC_DIR/$CI_PROJECT_NAME &&
      sudo find $STATIC_DIR/$CI_PROJECT_NAME -type d -exec sudo chmod 0750 {} \; &&
      sudo find $STATIC_DIR/$CI_PROJECT_NAME -type f -exec sudo chmod 0640 {} \;"
    - echo "Deployment complete! Site available at https://$HOST_NAME/public/$CI_PROJECT_NAME/$CI_COMMIT_BRANCH"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: never
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: on_success
    - when: on_success
</file>

<file path="src/components/Introduction/Introduction.jsx">
import { extractFromContentTree } from "@/api/hooks"
import { allContentQuery } from "@/api/queries"
import { getCurrentLocale } from "@/i18n"
import { useScroll, useTransform } from "motion/react"
import { useRef } from "react"
import { useTranslation } from "react-i18next"
import { useLoaderData, useNavigate } from "react-router-dom"

import IconButton from "@ui/IconButton"
import RiveAnimation from "@ui/RiveAnimation"

import Rectangle from "./Rectangle.png"
import {
  CameraButtonContainer,
  CharacterImage,
  CharacterImageContainer,
  ContentContainer,
  Headline,
  Image,
  IntroductionContainer,
  RiveAnimationContainer,
  TextBlock,
} from "./styles"

export default function Introduction() {
  const { t } = useTranslation()
  const navigate = useNavigate()
  const containerRef = useRef(null)
  const { scrollY } = useScroll({ container: containerRef })
  const y = useTransform(scrollY, (v) => -v * 0.5)

  const {
    characterIndex: currentCharacterIndex,
    character,
    introduction,
  } = useLoaderData()

  const heading = introduction?.heading || t("introduction.title")
  const description = introduction?.description
    ? introduction.description.replace(/<[^>]*>/g, "")
    : t("introduction.description")
  const paragraphs = [description]

  const imageUrl = introduction?.image?.file || Rectangle

  if (!character) {
    return (
      <IntroductionContainer data-introduction-container ref={containerRef}>
        <ContentContainer initial={{ x: "-50%" }} style={{ y }}>
          <Headline>
            {t("loading.characters", "Loading characters...")}
          </Headline>
        </ContentContainer>
      </IntroductionContainer>
    )
  }

  return (
    <IntroductionContainer data-introduction-container ref={containerRef}>
      {currentCharacterIndex === 0 ? (
        <RiveAnimationContainer>
          <RiveAnimation src="/amaraWriting.riv" autoplay />
        </RiveAnimationContainer>
      ) : (
        <CharacterImageContainer>
          <CharacterImage
            src={
              character.selectedImage || character.characterImage?.file || ""
            }
            alt={character.name || ""}
          />
        </CharacterImageContainer>
      )}

      <ContentContainer initial={{ x: "-50%" }} style={{ y }}>
        <Headline>{heading}</Headline>

        {paragraphs.map((paragraph, index) => (
          <TextBlock key={index}>
            {paragraph}
            {index < paragraphs.length - 1 && <br />}
          </TextBlock>
        ))}

        <Image src={imageUrl} />

        <CameraButtonContainer>
          <IconButton
            variant="camera"
            onClick={() => {
              navigate(`/characters/${currentCharacterIndex}/photo-capture`)
            }}
          />
        </CameraButtonContainer>
      </ContentContainer>
    </IntroductionContainer>
  )
}

export const loader =
  (queryClient) =>
  async ({ params }) => {
    const locale = getCurrentLocale()
    const query = allContentQuery(locale)
    const content = await queryClient.ensureQueryData(query)

    const characterId = params.characterId
    const characterIndex = Number.parseInt(characterId ?? "", 10)

    if (Number.isNaN(characterIndex) || characterIndex < 0) {
      throw new Response("Character not found", { status: 404 })
    }

    const character = extractFromContentTree.getCharacter(
      content,
      characterIndex,
    )

    if (!character) {
      throw new Response("Character not found", { status: 404 })
    }

    const introduction = extractFromContentTree.getIntroduction(
      content,
      characterIndex,
    )

    return { characterIndex, character, introduction }
  }
</file>

<file path="src/providers/LanguageProvider.jsx">
import {
  ALL_LOCALES_CONTENT_QUERY_KEY,
  fetchAllLocalesContent,
} from "@/api/djangoApi"
import { LANGUAGE_CONFIG, LANGUAGE_LIST } from "@/config/language"
import { useQuery } from "@tanstack/react-query"
import { createContext, useContext, useEffect, useMemo, useState } from "react"

const LanguageContext = createContext(null)

const resolveLanguagesFromContent = (content) => {
  const codes = [
    ...new Set(
      content
        .map((entry) => entry.locale)
        .filter((code) => LANGUAGE_LIST[code]),
    ),
  ]
  return codes.reduce(
    (acc, code) => ({ ...acc, [code]: LANGUAGE_LIST[code] }),
    {},
  )
}

const useLanguages = () => {
  const context = useContext(LanguageContext)
  if (!context) {
    throw new Error("useLanguages must be used within LanguageProvider")
  }
  return context
}

function LanguageProvider({ children }) {
  const { data, error, isLoading, isFetching, isSuccess, refetch } = useQuery({
    queryKey: ALL_LOCALES_CONTENT_QUERY_KEY,
    queryFn: fetchAllLocalesContent,
    staleTime: LANGUAGE_CONFIG.ALL_LOCALES_STALE_TIME,

    gcTime: LANGUAGE_CONFIG.CACHE_TIME,
    retry: LANGUAGE_CONFIG.RETRY_ATTEMPTS,
    retryDelay: LANGUAGE_CONFIG.RETRY_DELAY,
  })

  const [languages, setLanguages] = useState(LANGUAGE_LIST)

  useEffect(() => {
    if (!isSuccess || !data) return
    setLanguages(resolveLanguagesFromContent(data))
  }, [data, isSuccess])

  const contextValue = useMemo(
    () => ({
      supportedLanguages: languages,
      languageCodes: Object.keys(languages),
      isLoading,
      isFetching,
      isSuccess,
      error,
      refetch,
    }),
    [languages, isLoading, isFetching, isSuccess, error, refetch],
  )

  return (
    <LanguageContext.Provider value={contextValue}>
      {children}
    </LanguageContext.Provider>
  )
}

export { useLanguages }
export default LanguageProvider
</file>

<file path="src/components/Upload/Upload.jsx">
import { extractFromContentTree } from "@/api/hooks"
import { allContentQuery } from "@/api/queries"
import useGlobalState from "@/hooks/useGlobalState"
import usePhotoTasks from "@/hooks/usePhotoTasks"
import { useUploadImage } from "@/hooks/useUploadImage"
import { getCurrentLocale } from "@/i18n"
import { useState } from "react"
import { useTranslation } from "react-i18next"
import { useLoaderData, useNavigate } from "react-router-dom"

import SmallButton from "@ui/SmallButton"

import {
  Actions,
  ErrorList,
  ImageRow,
  ImagesGrid,
  Preview,
  ProgressMessage,
  Question,
  QuestionBlock,
  TaskLabel,
  UploadContainer,
} from "./styles"

const dataURLToFile = (dataURL, filename) => {
  const [metadata, base64Data] = dataURL.split(",")
  const mimeMatch = metadata.match(/:(.*?);/)
  const binaryString = atob(base64Data)
  const length = binaryString.length
  const u8arr = new Uint8Array(length)

  for (let i = 0; i < length; i++) {
    u8arr[i] = binaryString.charCodeAt(i)
  }

  return new File([u8arr], filename, { type: mimeMatch[1] })
}

export default function Upload() {
  const { t } = useTranslation()
  const { capturedImages } = useGlobalState()
  const [uploadProgress, setUploadProgress] = useState("")
  const [uploadErrors, setUploadErrors] = useState([])
  const { tasks } = usePhotoTasks()
  const navigate = useNavigate()
  const {
    characterIndex: currentCharacterIndex,
    character,
    upload: uploadData,
  } = useLoaderData()

  const uploadImageMutation = useUploadImage()
  const isUploading = uploadImageMutation.isPending
  const images = capturedImages || []
  const validImages = images.filter(Boolean)

  const characterName = character?.name || ""

  const uploadDescription = uploadData?.description
    ? uploadData.description.replace(/<[^>]*>/g, "")
    : t("upload.question")
  const yesButtonText = uploadData?.yesButtonText || t("upload.buttons.yes")
  const noButtonText = uploadData?.noButtonText || t("upload.buttons.no")

  const goToGallery = () =>
    navigate(`/characters/${currentCharacterIndex}/gallery`)

  const handleUpload = async () => {
    setUploadErrors([])

    if (validImages.length === 0) {
      goToGallery()
      return
    }

    try {
      setUploadProgress(
        t("upload.status.uploadingToCharacter", {
          count: validImages.length,
          character: characterName,
          defaultValue: `Uploading ${validImages.length} images to ${characterName}'s collection...`,
        }),
      )

      const timestamp = Date.now()
      const uploadResults = []
      const uploadErrors = []

      for (let index = 0; index < validImages.length; index++) {
        const imageData = validImages[index]
        try {
          const file = dataURLToFile(
            imageData,
            `photo-${timestamp}-${index}.jpg`,
          )
          const result = await uploadImageMutation.mutateAsync({ file })
          uploadResults.push(result)

          setUploadProgress(
            t("upload.status.uploadProgress", {
              current: index + 1,
              total: validImages.length,
              character: characterName,
              defaultValue: `Uploaded ${index + 1} of ${validImages.length} images to ${characterName}'s collection`,
            }),
          )
        } catch (error) {
          uploadErrors.push({
            index: index + 1,
            error: error.message || t("errors.unexpectedError"),
          })
        }
      }

      if (uploadErrors.length === 0) {
        setUploadProgress(
          t("upload.status.allCompleteForCharacter", {
            character: characterName,
            defaultValue: `All uploads completed successfully for ${characterName}!`,
          }),
        )
        setTimeout(() => {
          goToGallery()
        }, 2000)
      } else if (uploadResults.length > 0) {
        setUploadErrors(uploadErrors)
        setUploadProgress(
          t("upload.status.partialSuccess", {
            successful: uploadResults.length,
            failed: uploadErrors.length,
            total: validImages.length,
            defaultValue: `${uploadResults.length} of ${validImages.length} uploads completed. ${uploadErrors.length} failed.`,
          }),
        )
      } else {
        setUploadErrors(uploadErrors)
        setUploadProgress(t("errors.uploadFailed"))
      }
    } catch (error) {
      setUploadErrors([{ error: error.message }])
      setUploadProgress(t("errors.uploadFailed"))
    }
  }

  const getButtonText = () => {
    if (isUploading) return uploadProgress || t("upload.buttons.uploading")
    if (uploadErrors.length > 0) return t("upload.buttons.retry")
    return yesButtonText
  }

  const getUploadDescription = () => {
    if (validImages.length === 0) return t("upload.noImages")

    const baseDescription = uploadDescription || t("upload.question")
    return t("upload.questionWithCharacter", {
      description: baseDescription,
      character: characterName,
      defaultValue: `${baseDescription} Your photos will be added to ${characterName}'s collection.`,
    })
  }

  return (
    <UploadContainer>
      <ImagesGrid>
        {validImages.map((imageData, index) => (
          <ImageRow key={index}>
            <TaskLabel>{tasks[index]}</TaskLabel>
            <Preview src={imageData} />
          </ImageRow>
        ))}
      </ImagesGrid>

      <QuestionBlock>
        <Question>{getUploadDescription()}</Question>

        {uploadProgress && (
          <ProgressMessage $hasErrors={uploadErrors.length > 0}>
            {uploadProgress}
          </ProgressMessage>
        )}

        {uploadErrors.length > 0 && (
          <ErrorList>
            {uploadErrors.map((error, index) => (
              <div key={index}>
                {error.index && `Photo ${error.index}: `}
                {error.error?.message || error.error || "Unknown error"}
              </div>
            ))}
          </ErrorList>
        )}

        <Actions>
          <SmallButton onClick={handleUpload} disabled={isUploading}>
            {getButtonText()}
          </SmallButton>
          <SmallButton onClick={goToGallery} disabled={isUploading}>
            {isUploading ? t("upload.buttons.pleaseWait") : noButtonText}
          </SmallButton>
        </Actions>
      </QuestionBlock>
    </UploadContainer>
  )
}

export const loader =
  (queryClient) =>
  async ({ params }) => {
    const locale = getCurrentLocale()
    const query = allContentQuery(locale)
    const content = await queryClient.ensureQueryData(query)

    const characterId = params.characterId
    const characterIndex = Number.parseInt(characterId ?? "", 10)

    if (Number.isNaN(characterIndex) || characterIndex < 0) {
      throw new Response("Character not found", { status: 404 })
    }

    const character = extractFromContentTree.getCharacter(
      content,
      characterIndex,
    )

    if (!character) {
      throw new Response("Character not found", { status: 404 })
    }

    const upload = extractFromContentTree.getUpload(content, characterIndex)

    return { characterIndex, character, upload }
  }
</file>

<file path="src/components/Welcome/Welcome.jsx">
import { extractFromContentTree } from "@/api/hooks"
import { allContentQuery } from "@/api/queries"
import useGlobalState from "@/hooks/useGlobalState"
import { getCurrentLocale } from "@/i18n"
import { useState } from "react"
import { useLoaderData, useNavigate } from "react-router-dom"

import Description from "@ui/Description"
import Header from "@ui/Header"
import LanguageSelector from "@ui/LanguageSelector"
import Navigation from "@ui/Navigation"
import Vignette from "@ui/Vignette"

import CharacterShowcase from "./CharacterShowcase"
import { STEP } from "./constants"
import { useWelcomeBackground } from "./hooks/useWelcomeBackground"
import { useWelcomeContent } from "./hooks/useWelcomeContent"
import { useWelcomeSteps } from "./hooks/useWelcomeSteps"
import {
  ChildrenContainer,
  LanguageSelectorContainer,
  Layout,
  TextLayout,
} from "./styles"

export default function Welcome() {
  const [showIntro, setShowIntro] = useState(true)
  const {
    currentCharacterIndex,
    setCurrentCharacterIndex,
    clearCapturedImages,
  } = useGlobalState()
  const navigate = useNavigate()

  const { welcome, characterOverview, characters } = useLoaderData()

  const welcomeData = welcome
  const characterOverviewData = characterOverview
  const charactersData = characters

  const handleGoToIntroduction = () => {
    clearCapturedImages()
    navigate(`/characters/${currentCharacterIndex}/introduction`)
  }

  const { step, setStep, getNavigationProps } = useWelcomeSteps({
    goToIntroduction: handleGoToIntroduction,
    showIntro,
    setShowIntro,
    currentCharacterIndex,
    setCurrentCharacterIndex,
    charactersData,
  })

  const { headline, subHeadline, description, navigationMode } =
    useWelcomeContent(step, showIntro, currentCharacterIndex, {
      charactersData,
      characterOverviewData,
    })

  const backgroundImage = useWelcomeBackground(
    step,
    welcomeData,
    characterOverviewData,
  )

  return (
    <Layout $backgroundImage={backgroundImage}>
      {step === STEP.CHARACTER && (
        <ChildrenContainer>
          <CharacterShowcase
            onSelect={() => setStep(2)}
            showIntro={showIntro}
            setShowIntro={setShowIntro}
            characters={charactersData}
          />
        </ChildrenContainer>
      )}
      <TextLayout $hasDescription={!!description}>
        {headline && (
          <Header
            headline={headline}
            subheadline={subHeadline}
            legalNotice={step === STEP.INTRO}
          />
        )}

        {description && (
          <Description
            title={description.title}
            text={description.text}
            headline={headline}
            subheadline={subHeadline}
          />
        )}
      </TextLayout>
      <Navigation position="default" {...getNavigationProps(navigationMode)} />
      <Vignette />
      <LanguageSelectorContainer>
        <LanguageSelector />
      </LanguageSelectorContainer>
    </Layout>
  )
}

export const loader = (queryClient) => async () => {
  const locale = getCurrentLocale()
  const query = allContentQuery(locale)
  const content = await queryClient.ensureQueryData(query)

  const welcome = extractFromContentTree.getWelcome(content)
  const characterOverview = extractFromContentTree.getCharacterOverview(content)
  const characters = extractFromContentTree.getCharacters(content)

  return {
    welcome,
    characterOverview,
    characters,
  }
}
</file>

</files>
